<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>AI:å¹¸è¿æˆ¿ä¸œ</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background: #222;
            color: #fff;
        }

        #slot-machine {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 40px auto;
            width: fit-content;
        }

        #coin-pool {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            color: #fff;
            z-index: 100;
        }

        .coin-icon {
            font-size: 22px;
            animation: none;
        }

        #coin-count {
            font-weight: bold;
        }

        @keyframes coinBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .coin-highlight {
            animation: coinBounce 0.5s ease infinite;
        }

        .flying-coin {
            position: absolute;
            font-size: 20px;
            z-index: 99;
            pointer-events: none;
        }

        .column {
            width: 80px;
            height: 400px;
            overflow: hidden;
            border: 2px solid #555;
            background: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 8px;
            position: relative;
        }

        .slot {
            width: 100%;
            height: 80px;
            font-size: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: slide 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        @keyframes slide {
            from {
                transform: translateY(-20px);
                opacity: 0.5;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        button {
            padding: 10px 20px;
            font-size: 18px;
            border: none;
            border-radius: 6px;
            background: #00bcd4;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background: #0097a7;
        }

        .slot:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            background: #333;
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 14px;
            transform: translateY(-5px);
            opacity: 0.9;
        }

        .highlight {
            animation: blink 0.6s infinite;
            background: #ffeb3b;
            border-radius: 6px;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        #upgrade-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .panel-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .skip-button, .hide-button {
            padding: 8px 16px;
            background: #666;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        .skip-button:hover, .hide-button:hover {
            background: #888;
        }

        #show-upgrade-button {
            margin-left: 10px;
            padding: 8px 16px;
            background: #4a90e2;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        #show-upgrade-button:hover {
            background: #3a80d2;
        }

        #upgrade-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .upgrade-card {
            background: #333;
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            width: 150px;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
        }

        .upgrade-card:hover {
            transform: scale(1.05);
            background: #555;
        }

        .upgrade-card .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }


        .resource-panel {
            position: fixed;
            left: 20px;
            bottom: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            color: white;
            width: 280px;  /* å›ºå®šå®½åº¦ */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }


        /* ç¾åŒ–èµ„æºé¢æ¿æ ‡é¢˜ */
        .resource-panel h3 {
            margin: 0 0 15px 0;
            color: #4a90e2;
            font-size: 18px;
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 8px;
        }

        /* ä¼˜åŒ–èµ„æºé¡¹å¸ƒå±€ */
        .resource-item {
            margin: 8px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .resource-info {
            flex: 1;
        }

        .resource-name {
            font-size: 14px;
            color: #4a90e2;
        }

        .resource-count {
            font-size: 18px;
            font-weight: bold;
        }

        .resource-actions {
            display: flex;
            gap: 8px;
        }

        .trade-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .buy-btn {
            background: #27ae60;
            color: white;
        }

        .sell-btn {
            background: #e74c3c;
            color: white;
        }

        .trade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div id="coin-pool">
    <div class="coin-icon">ğŸ’°</div>
    <span id="coin-count">0</span>
</div>
<div id="slot-machine">
    <div class="column" id="col-0" data-index="0"></div>
    <div class="column" id="col-1" data-index="1"></div>
    <div class="column" id="col-2" data-index="2"></div>
    <div class="column" id="col-3" data-index="3"></div>
    <div class="column" id="col-4" data-index="4"></div>
</div>
<div id="upgrade-panel">
    <h2>ğŸ é€‰æ‹©ä¸€ä¸ªæ„ç­‘åŠ æˆ</h2>
    <div id="upgrade-options"></div>
    <div class="panel-buttons">
        <button class="skip-button" onclick="giveUpgrade()">è·³è¿‡é€‰æ‹©</button>
        <button class="hide-button" onclick="hideUpgradePanel()">éšè—é¢æ¿</button>
    </div>
</div>

<!-- æ¸¸æˆä¸»ç•Œé¢æ·»åŠ æ˜¾ç¤ºæ„ç­‘é¢æ¿æŒ‰é’® -->
<div class="game-controls">
    <button id="start-button" onclick="startSlots()">å¼€å§‹æ»šåŠ¨</button>
    <button id="show-upgrade-button" onclick="toggleUpgradePanel()" style="display: none;">é€‰æ‹©å¥–åŠ±</button>
</div>

<script>
    // å®šä¹‰å›¾æ ‡ç±»åˆ«æšä¸¾
    const IconCategory = {
        Items: 'Items',            // åŸºç±» æ”¾æ•°å€¼å¡ç‰Œ
        Box: 'Box',                 // å®ç®±ç±»
        Key: 'Key',                 // é’¥åŒ™ç±»
        STATUS: 'STATUS',          // çŠ¶æ€æ•ˆæœç±»
        WEATHER: 'WEATHER',        // å¤©æ°”ç¯å¢ƒç±»
        ANIMAL: 'ANIMAL',          // åŠ¨ç‰©ä¼™ä¼´ç±»
        BUILDING: 'BUILDING',      // å»ºç­‘è®¾æ–½ç±»
        PLANT: 'PLANT',           // æ¤ç‰©èµ„æºç±»
        MAGIC: 'MAGIC',           // é­”æ³•å…ƒç´ ç±»
        TREASURE: 'TREASURE',      // å®ç‰©è´¢å¯Œç±»
        FESTIVAL: 'FESTIVAL',      // èŠ‚æ—¥åº†å…¸ç±»
        MUSIC: 'MUSIC',           // éŸ³ä¹è‰ºæœ¯ç±»
        VEHICLE: 'VEHICLE',        // äº¤é€šå·¥å…·ç±»
        GEM: 'GEM',               // æ°´æ™¶å®çŸ³ç±»
        TECH: 'TECH',             // ç§‘æŠ€è£…å¤‡ç±»
        MARINE: 'MARINE',         // æµ·æ´‹ç”Ÿç‰©ç±»
        MYTH: 'MYTH',             // ç¥è¯ç”Ÿç‰©ç±»
        TIME: 'TIME'              // æ—¶ç©ºå…ƒç´ ç±»
    };

    // å®šä¹‰ç¨€æœ‰åº¦æšä¸¾
    const Rarity = {
        COMMON: 'ä¼˜ç§€',           // ä¼˜ç§€ (2-3é‡‘å¸)
        RARE: 'ç²¾è‰¯',            // ç²¾è‰¯ (4-6é‡‘å¸)
        EPIC: 'å²è¯—',            // å²è¯— (7-9é‡‘å¸)
        LEGENDARY: 'ä¼ è¯´'         // ä¼ è¯´ (15-20é‡‘å¸)
    };
    // å®Œå–„èŒä¸šåˆ—è¡¨
    const professions = [
        // { icon: 'ğŸ§™â€â™‚ï¸', tip: 'æ³•å¸ˆ', baseCoins: 0, rarity: Rarity.LEGENDARY,
        //     description: 'æŒæ¡å¥¥æœ¯çš„å¤§å¸ˆï¼Œæ“…é•¿å„ç±»é­”æ³•å…ƒç´ ',
        //     excludeCategories: [IconCategory.TECH,IconCategory.ANIMAL, IconCategory.VEHICLE, IconCategory.MARINE] },
        //
        // { icon: 'ğŸ§â€â™€ï¸', tip: 'è‰ºæœ¯å®¶', baseCoins: 0, rarity: Rarity.COMMON,
        //     description: 'æ²‰æµ¸äºè‰ºæœ¯åˆ›ä½œï¼Œçƒ­çˆ±éŸ³ä¹ä¸ç¾æœ¯å’Œå¥‡æ€ªçš„å»ºç­‘',
        //     excludeCategories: [IconCategory.TECH,IconCategory.VEHICLE, IconCategory.PLANT, IconCategory.MAGIC] },
        //
        // { icon: 'ğŸ¦¸â€â™‚ï¸', tip: 'å•†äºº', baseCoins: 0, rarity: Rarity.COMMON,
        //     description: 'ç²¾äºç®—è®¡çš„è´¸æ˜“å•†äººï¼Œå–„äºè´¢å¯Œç§¯ç´¯ï¼Œä¹Ÿä¼šé“¤è€Œèµ°é™©',
        //     excludeCategories: [IconCategory.PLANT, IconCategory.TECH, IconCategory.ANIMAL] },
        //
        // { icon: 'ğŸ¤–', tip: 'æœºå™¨äºº', baseCoins: 0, rarity: Rarity.LEGENDARY,
        //     description: 'ç²¾é€šç§‘æŠ€çš„å‘æ˜å®¶ï¼Œæ“…é•¿æœºæ¢°è£…ç½®',
        //     excludeCategories: [IconCategory.MAGIC, IconCategory.PLANT, IconCategory.FESTIVAL, IconCategory.MYTH] },

        { icon: 'ğŸ§‘â€ğŸŒ¾', tip: 'å†œå¤«', baseCoins: 0, rarity: Rarity.RARE,
            description: 'å‹¤åŠ³çš„è€•ç§è€…ï¼Œä¸è‡ªç„¶å’Œæ¤ç‰©äº²è¿‘',
            excludeCategories: [IconCategory.TECH, IconCategory.MAGIC, IconCategory.MARINE, IconCategory.TREASURE] }
    ];

    // æ·»åŠ èŒä¸šé€‰æ‹©é¢æ¿HTML
    const professionSelectionHTML = `
<div id="profession-selection-panel">
    <h2>ğŸ§© é€‰æ‹©ä½ çš„èŒä¸š</h2>
    <p>ä¸åŒèŒä¸šä¼šå½±å“ä½ çš„æŠ½ç‰Œåº“æ„æˆ</p>
    <div id="profession-options"></div>
</div>
`;

    // æ·»åŠ èŒä¸šé€‰æ‹©é¢æ¿æ ·å¼
    const professionSelectionStyles = `
#profession-selection-panel {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 20px;
    color: white;
}

#profession-options {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
    max-width: 800px;
}

.profession-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 20px;
    width: 180px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.profession-card:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-5px);
}

.profession-icon {
    font-size: 48px;
    margin-bottom: 10px;
}

.profession-name {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 10px;
    color: #4a90e2;
}

.profession-description {
    font-size: 14px;
    margin-bottom: 15px;
    color: rgba(255, 255, 255, 0.8);
}

.profession-rarity {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-top: 10px;
}

.rarity-common {
    background: #7fba00;
}

.rarity-rare {
    background: #2b88d9;
}

.rarity-epic {
    background: #9370db;
}

.rarity-legendary {
    background: #ff8c00;
}
`;

    // æ·»åŠ å˜é‡å­˜å‚¨å½“å‰é€‰æ‹©çš„èŒä¸š
    let selectedProfession = null;
    let filteredIconData = [];

    // åˆå§‹åŒ–èŒä¸šé€‰æ‹©é¢æ¿
    function initProfessionSelection() {
        // æ·»åŠ æ ·å¼
        const styleSheet = document.createElement('style');
        styleSheet.textContent = professionSelectionStyles;
        document.head.appendChild(styleSheet);

        // æ·»åŠ HTML
        const div = document.createElement('div');
        div.innerHTML = professionSelectionHTML;
        document.body.appendChild(div.firstElementChild);

        // è·å–èŒä¸šé€‰é¡¹å®¹å™¨
        const optionsContainer = document.getElementById('profession-options');

        // æ¸²æŸ“èŒä¸šå¡ç‰‡
        professions.forEach(profession => {
            const rarityClass = `rarity-${profession.rarity.toLowerCase()}`;
            const card = document.createElement('div');
            card.className = 'profession-card';
            card.innerHTML = `
            <div class="profession-icon">${profession.icon}</div>
            <div class="profession-name">${profession.tip}</div>
            <div class="profession-description">${profession.description}</div>
            <div class="profession-rarity ${rarityClass}">${profession.rarity}</div>
        `;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            card.addEventListener('click', () => {
                selectProfession(profession);
            });

            optionsContainer.appendChild(card);
        });
    }

    // ä¿®æ”¹é€‰æ‹©èŒä¸šçš„å‡½æ•°
    function selectProfession(profession) {
        selectedProfession = profession;

        // è¿‡æ»¤æŠ½ç‰Œåº“
        filterCardsByProfession();

        // å…³é—­èŒä¸šé€‰æ‹©é¢æ¿
        const panel = document.getElementById('profession-selection-panel');
        panel.style.opacity = '0';
        panel.style.transition = 'opacity 0.5s ease';

        setTimeout(() => {
            panel.remove();
            // å¼€å§‹åˆå§‹æ„ç­‘ç¯èŠ‚
            startInitialDeck();
        }, 500);

        // æ˜¾ç¤ºé€‰æ‹©ç¡®è®¤æ¶ˆæ¯
        showProfessionConfirmation(profession);
    }

    function startInitialDeck() {
        window.deckBuildingCount = 10; // æ„ç­‘æ¬¡æ•°
        const upgradePanel = document.getElementById('upgrade-panel');

        // æ˜¾ç¤ºæ„ç­‘é¢æ¿
        upgradePanel.style.display = 'block';
        document.getElementById('show-upgrade-button').style.display = 'none';

        // ä¿®æ”¹é¢æ¿æ ‡é¢˜
        const panelTitle = document.querySelector('#upgrade-panel h2');
        panelTitle.textContent = `ğŸ® åˆå§‹æ„ç­‘ (å‰©ä½™${window.deckBuildingCount}æ¬¡)`;

        showUpgradeChoices();
    }

    // æ˜¾ç¤ºæ„ç­‘å®Œæˆæ¶ˆæ¯
    function showDeckCompleteMessage() {
        const message = document.createElement('div');
        message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 200, 0, 0.9);
        padding: 20px;
        border-radius: 10px;
        color: white;
        font-size: 24px;
        z-index: 2000;
        text-align: center;
        animation: fadeInOut 2s ease-in-out;
    `;
        message.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 10px;">âœ¨</div>
        <div>åˆå§‹æ„ç­‘å®Œæˆï¼</div>
        <div style="font-size: 16px; margin-top: 10px;">ç‚¹å‡»å¼€å§‹æŒ‰é’®å¼€å§‹æ¸¸æˆ</div>
    `;
        document.body.appendChild(message);

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
        }
    `;
        document.head.appendChild(style);

        // 2ç§’åç§»é™¤æ¶ˆæ¯
        setTimeout(() => {
            message.remove();
            style.remove();
        }, 2000);
    }


    // æ ¹æ®èŒä¸šè¿‡æ»¤å¡ç‰Œ
    function filterCardsByProfession() {
        if (!selectedProfession) {
            filteredIconData = [...iconData];
            return;
        }

        // è¿‡æ»¤æ‰èŒä¸šæ’é™¤çš„ç±»åˆ«
        filteredIconData = iconData.filter(card =>
            !selectedProfession.excludeCategories.includes(card.category)
        );

        console.log(`å·²è¿‡æ»¤å¡ç‰Œåº“ï¼Œå‰©ä½™ ${filteredIconData.length} å¼ å¡ç‰Œ`);
    }

    // æ˜¾ç¤ºèŒä¸šé€‰æ‹©ç¡®è®¤æ¶ˆæ¯
    function showProfessionConfirmation(profession) {
        const message = document.createElement('div');
        message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(74, 144, 226, 0.9);
        padding: 20px;
        border-radius: 10px;
        color: white;
        font-size: 24px;
        z-index: 1000;
        text-align: center;
    `;
        message.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 10px;">${profession.icon}</div>
        <div>ä½ é€‰æ‹©äº† ${profession.tip} èŒä¸šï¼</div>
    `;
        document.body.appendChild(message);
        setTimeout(() => message.remove(), 2000);
    }

    // ä¼˜åŒ–åçš„çŒ«é¼ äº’åŠ¨æ£€æŸ¥å‡½æ•°
    function checkCatMouseInteraction(grid, row, col, highlightGroups) {
        const currentCard = grid[row][col];
        if (!currentCard) return;
    
        // æ£€æŸ¥æ˜¯å¦æ˜¯çŒ«æˆ–é¼ 
        if (currentCard.icon === 'ğŸˆ' || currentCard.icon === 'ğŸ­') {
            const neighbors = [];
    
            // æ£€æŸ¥å…«ä¸ªæ–¹å‘ç›¸é‚»æ ¼å­
            const directions = [
                [-1, -1], // å·¦ä¸Š
                [-1, 0],  // ä¸Š
                [-1, 1],  // å³ä¸Š
                [0, -1],  // å·¦
                [0, 1],   // å³
                [1, -1],  // å·¦ä¸‹
                [1, 0],   // ä¸‹
                [1, 1]    // å³ä¸‹
            ];
    
            for (const [dx, dy] of directions) {
                const newRow = row + dx;
                const newCol = col + dy;
    
                // ç¡®ä¿ä½ç½®åœ¨ç½‘æ ¼å†…
                if (newRow >= 0 && newRow < 5 && newCol >= 0 && newCol < 5) {
                    const neighbor = grid[newRow][newCol];
                    if (neighbor) {
                        // å¦‚æœå½“å‰æ˜¯çŒ«,å¯»æ‰¾è€é¼ 
                        if (currentCard.icon === 'ğŸˆ' && neighbor.icon === 'ğŸ­') {
                            neighbors.push({
                                card: neighbor,
                                element: document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`)
                            });
                        }
                        // å¦‚æœå½“å‰æ˜¯è€é¼ ,å¯»æ‰¾çŒ«
                        else if (currentCard.icon === 'ğŸ­' && neighbor.icon === 'ğŸˆ') {
                            neighbors.push({
                                card: neighbor,
                                element: document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`)
                            });
                        }
                    }
                }
            }
    
            // å¦‚æœæ‰¾åˆ°ç›¸äº’ä½œç”¨çš„å¡ç‰Œ
            if (neighbors.length > 0) {
                const currentElement = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
                
                // å°†å½“å‰å¡ç‰Œå’Œç›¸é‚»å¡ç‰ŒåŠ å…¥é«˜äº®ç»„
                const group = [
                    { card: currentCard, element: currentElement },
                    ...neighbors
                ];
                highlightGroups.push(group);
    
                // è®¡ç®—é¢å¤–è·å¾—çš„é‡‘å¸
                const extraCoins = neighbors.reduce((sum, {card}) => sum + card.baseCoins, 0);
                
                // æ›´æ–°å½“å‰å¡ç‰‡å³ä¸Šè§’çš„é‡‘å¸æç¤º
                const coinIndicator = currentElement.querySelector('.coin-indicator');
                if (coinIndicator) {
                    coinIndicator.textContent = `+${currentCard.baseCoins + extraCoins}ğŸ’°`;
                }
    
                // æ˜¾ç¤ºäº’åŠ¨æ•ˆæœ
                setTimeout(() => {
                    showCatMouseEffect(currentElement, neighbors.map(n => n.element));
                    addCoins(extraCoins, currentElement);
                }, 500);
            }
        }
    }
    
    // ä¼˜åŒ–çŒ«é¼ äº’åŠ¨æ•ˆæœæ˜¾ç¤º
    function showCatMouseEffect(sourceElement, targetElements) {
        targetElements.forEach(targetElement => {
            // åˆ›å»ºæ”¾å°„çŠ¶è¿æ¥çº¿
            const line = document.createElement('div');
            line.className = 'cat-mouse-line';
            document.body.appendChild(line);
    
            // è·å–ä½ç½®
            const sourceRect = sourceElement.getBoundingClientRect();
            const targetRect = targetElement.getBoundingClientRect();
    
            // è®¾ç½®çº¿çš„ä½ç½®å’Œè§’åº¦
            const startX = sourceRect.left + sourceRect.width / 2;
            const startY = sourceRect.top + sourceRect.height / 2;
            const endX = targetRect.left + targetRect.width / 2;
            const endY = targetRect.top + targetRect.height / 2;
    
            const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
    
            line.style.width = `${length}px`;
            line.style.left = `${startX}px`;
            line.style.top = `${startY}px`;
            line.style.transform = `rotate(${angle}deg)`;
    
            // åˆ›å»ºäº’åŠ¨æ–‡æœ¬
            const text = document.createElement('div');
            text.className = 'cat-mouse-text';
            const isMultiple = targetElements.length > 1;
            text.textContent = sourceElement.__card.icon === 'ğŸˆ' ? 
                `ğŸˆ å’Œ Jerry!` :
                `ğŸ­ å’Œ Tom!`;
            text.style.left = `${(startX + endX) / 2}px`;
            text.style.top = `${(startY + endY) / 2 - 20}px`;
            document.body.appendChild(text);
    
            // åŠ¨ç”»ç»“æŸåç§»é™¤æ•ˆæœ
            setTimeout(() => {
                line.remove();
                text.remove();
            }, 1000);
        });
    }

    const catMouseStyles = `
    .cat-mouse-line {
        position: fixed;
        height: 2px;
        background: linear-gradient(90deg, #ffeb3b, #ff9800);
        transform-origin: left;
        z-index: 100;
        animation: catMousePulse 1s ease-in-out;
    }

    .cat-mouse-text {
        position: fixed;
        color: #ff9800;
        font-weight: bold;
        font-size: 16px;
        text-shadow: 0 0 5px rgba(0,0,0,0.8);
        transform: translate(-50%, -50%);
        z-index: 101;
        animation: catMouseTextFloat 1.5s ease-out;
        white-space: nowrap;
    }

    @keyframes catMousePulse {
        0% { opacity: 0; height: 1px; }
        50% { opacity: 1; height: 3px; }
        100% { opacity: 0; height: 2px; }
    }

    @keyframes catMouseTextFloat {
        0% { opacity: 0; transform: translate(-50%, 0); }
        20% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; transform: translate(-50%, -30px); }
    }
    `;



    const iconData = [
        // é’¥åŒ™å’Œå®ç®±
        { icon: 'ğŸ—ï¸', tip: 'å¼€é”', baseCoins: 1,delCoins:0, rarity: Rarity.COMMON, category: IconCategory.Key },
        { icon: 'ğŸ“¦', tip: 'å®ç®±è—ç€30é‡‘å¸', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        { icon: 'ğŸ’¼', tip: 'ç²¾åå®ç®±è—ç€50é‡‘å¸', baseCoins: 2,delCoins:50, rarity: Rarity.RARE, category: IconCategory.Box },
        { icon: 'ğŸ‘‘', tip: 'è´¢å¯Œå®ç®±è—ç€80é‡‘å¸', baseCoins: 3,delCoins:80, rarity: Rarity.EPIC, category: IconCategory.Box },
        { icon: 'ğŸ§³', tip: 'ä¼ å¥‡å®ç®±è—ç€120é‡‘å¸', baseCoins: 5,delCoins:120, rarity: Rarity.LEGENDARY, category: IconCategory.Box },

        // å¤©æ°”ç¯å¢ƒç±»
        { icon: 'ğŸŒªï¸', tip: 'é¾™å·é£ï¼šç ´å', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.WEATHER },
        { icon: 'ğŸŒ§ï¸', tip: 'é›¨å¤©:20%æ¦‚ç‡æ·»åŠ ğŸ’§',make:'ğŸ’§', baseCoins: 1, rarity: Rarity.RARE, category: IconCategory.WEATHER },
        { icon: 'ğŸ’§', tip: 'æ°´:å¯ä»¥è®©æ¤ç‰©é•¿å¤§', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.WEATHER },
        // { icon: 'ğŸŒ«ï¸', tip: 'æ ¸åºŸæ°´', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.WEATHER },

        // æ¤ç‰©èµ„æºç±»
        { icon: 'ğŸŒ¿', tip: 'å‘èŠ½', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.PLANT },
        { icon: 'ğŸŒ¸', tip: 'å¼€èŠ±', baseCoins: 1, rarity: Rarity.RARE, category: IconCategory.PLANT },
        { icon: 'ğŸŒ»', tip: 'å‘æ—¥è‘µ', baseCoins: 2, rarity: Rarity.RARE, category: IconCategory.PLANT },
        { icon: 'ğŸŒ¾', tip: 'éº¦ç©—', baseCoins: 2, rarity: Rarity.EPIC, category: IconCategory.PLANT },
        { icon: 'ğŸ', tip: 'è‹¹æœ', baseCoins: 3, rarity: Rarity.EPIC, category: IconCategory.PLANT},
        { icon: 'ğŸŒ²', tip: 'æ¾æ ‘ï¼šç”Ÿäº§ææ–™2', baseCoins: 5, rarity: Rarity.LEGENDARY, category: IconCategory.PLANT },
        { icon: 'ğŸŒ³', tip: 'æ ‘æœ¨: ç”Ÿäº§ç¥ç§˜2', baseCoins: 5, rarity: Rarity.LEGENDARY, category: IconCategory.PLANT },
        { icon: 'ğŸŒ´', tip: 'æ£•æ¦ˆæ ‘ï¼šç”Ÿäº§ç§‘æŠ€2', baseCoins: 5, rarity: Rarity.LEGENDARY, category: IconCategory.PLANT },
        { icon: 'ğŸ„', tip: 'åœ£è¯æ ‘ 20%æ¦‚ç‡æ·»åŠ ğŸ‡',make: 'ğŸ‡', baseCoins: 5, rarity: Rarity.LEGENDARY, category: IconCategory.PLANT },

        // åŠ¨ç‰©ä¼™ä¼´ç±»
        { icon: 'ğŸ•', tip: 'å°ç‹—', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.ANIMAL },
        { icon: 'ğŸˆ', tip: 'Tom', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.ANIMAL },
        { icon: 'ğŸ­', tip: 'Jerry', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.ANIMAL },
        { icon: 'ğŸ‡', tip: 'å…”å­ 20%æ¦‚ç‡æ·»åŠ ğŸ‡',make:'ğŸ‡', baseCoins: 2, rarity: Rarity.RARE, category: IconCategory.ANIMAL },
        { icon: 'ğŸº', tip: 'ç‹¼', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.ANIMAL },
        { icon: 'ğŸ¯', tip: 'çŒ›è™', baseCoins: 5, rarity: Rarity.EPIC, category: IconCategory.ANIMAL },
        { icon: 'ğŸ‰', tip: 'å·¨é¾™: æœ€å¼ºç”Ÿç‰©', baseCoins: 20, rarity: Rarity.LEGENDARY, category: IconCategory.ANIMAL },

        // å»ºç­‘è®¾æ–½ç±»
        { icon: 'ğŸšï¸', tip: 'åºŸå¢Ÿ', baseCoins: 3, rarity: Rarity.COMMON, category: IconCategory.BUILDING },
        { icon: 'â›ª', tip: 'æ•™å ‚', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.BUILDING },
        { icon: 'ğŸ°', tip: 'åŸå ¡', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.BUILDING },
        { icon: 'ğŸ¯', tip: 'è¦å¡', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.BUILDING },
        { icon: 'ğŸ—½', tip: 'ç¥åƒ', baseCoins: 20, rarity: Rarity.LEGENDARY, category: IconCategory.BUILDING },

        // é­”æ³•å…ƒç´ ç±»
        // { icon: 'ğŸ”¥', tip: 'ç«ç„°ä¼¤å®³', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.MAGIC },
        // { icon: 'â„ï¸', tip: 'å†°å†»æ•ˆæœ', baseCoins: 6, rarity: Rarity.RARE, category: IconCategory.MAGIC },
        // { icon: 'âš¡', tip: 'é—ªç”µè¿å‡»', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.MAGIC },
        // { icon: 'ğŸŒˆ', tip: 'å½©è™¹ç¥ç¦', baseCoins: 9, rarity: Rarity.EPIC, category: IconCategory.MAGIC },
        // { icon: 'ğŸ’«', tip: 'é­”æ³•æ˜Ÿå°˜', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.MAGIC },
        // { icon: 'ğŸŒŸ', tip: 'æ˜Ÿå…‰ç¥ç¦', baseCoins: 9, rarity: Rarity.EPIC, category: IconCategory.MAGIC },
        // { icon: 'ğŸŒ€', tip: 'ç©ºé—´æ‰­æ›²', baseCoins: 16, rarity: Rarity.LEGENDARY, category: IconCategory.MAGIC },
        // { icon: 'â˜„ï¸', tip: 'é™¨çŸ³å è½', baseCoins: 18, rarity: Rarity.LEGENDARY, category: IconCategory.MAGIC },
        // { icon: 'ğŸ§ª', tip: 'ç¥ç§˜è¯æ°´', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.MAGIC },
        // { icon: 'ğŸ“œ', tip: 'æ³•æœ¯å·è½´', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.MAGIC },
        // { icon: 'ğŸ’Š', tip: 'æ²»ç–—è¯å‰‚', baseCoins: 4, rarity: Rarity.RARE, category: IconCategory.MAGIC },
        // { icon: 'ğŸ§‰', tip: 'èƒ½é‡é¥®å“', baseCoins: 3, rarity: Rarity.COMMON, category: IconCategory.MAGIC },
        // { icon: 'ğŸ”®', tip: 'é¢„è¨€æ°´æ™¶', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.MAGIC },
        // { icon: 'ğŸª', tip: 'å˜‰å¹´å', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.FESTIVAL },

        // å®ç‰©è´¢å¯Œç±»
        { icon: 'ğŸ’°', tip: 'é‡‘å¸', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.TREASURE },
        { icon: 'ğŸ’', tip: 'ç¨€æœ‰å®çŸ³', baseCoins: 3, rarity: Rarity.EPIC, category: IconCategory.TREASURE },
        { icon: 'ğŸ’', tip: 'é­”æ³•æˆ’æŒ‡', baseCoins: 4, rarity: Rarity.EPIC, category: IconCategory.TREASURE },
        { icon: 'ğŸ†', tip: 'è£èª‰å¥–æ¯: ç”Ÿäº§ç¥ç§˜3', baseCoins: 8, rarity: Rarity.LEGENDARY, category: IconCategory.TREASURE },

        // èŠ‚æ—¥åº†å…¸ç±»
        { icon: 'ğŸ¨', tip: 'å½©ç»˜', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.FESTIVAL },
        { icon: 'ğŸ‡', tip: 'çƒŸèŠ±', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.FESTIVAL },
        { icon: 'ğŸ‰', tip: 'åº†ç¥', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.FESTIVAL },
        { icon: 'ğŸ®', tip: 'çº¢ç¯ç¬¼', baseCoins: 2, rarity: Rarity.RARE, category: IconCategory.FESTIVAL },
        { icon: 'ğŸƒ', tip: 'å—ç“œç¯', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.FESTIVAL },
        { icon: 'ğŸ­', tip: 'ç‹‚æ¬¢é¢å…· 20%æ¦‚ç‡æ·»åŠ ğŸ¨',make: 'ğŸ¨', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.FESTIVAL },
        { icon: 'ğŸ…', tip: 'åœ£è¯è€äºº 40%æ¦‚ç‡æ·»åŠ ğŸ‰',make: 'ğŸ‰', baseCoins: 8, rarity: Rarity.LEGENDARY, category: IconCategory.MYTH },

        // éŸ³ä¹è‰ºæœ¯ç±»
        { icon: 'ğŸ»', tip: 'å°æç´ 20%æ¦‚ç‡æ·»åŠ ğŸµ',make:'ğŸµ', baseCoins: 1, rarity: Rarity.RARE, category: IconCategory.MUSIC },
        { icon: 'ğŸ¹', tip: 'é’¢ç´ 30%æ¦‚ç‡æ·»åŠ ğŸµ',make:'ğŸµ', baseCoins: 1, rarity: Rarity.EPIC, category: IconCategory.MUSIC },
        { icon: 'ğŸ¶', tip: 'æ—‹å¾‹', baseCoins: 2, rarity: Rarity.RARE, category: IconCategory.MUSIC },
        { icon: 'ğŸµ', tip: 'éŸ³ç¬¦', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.MUSIC },
        { icon: 'ğŸ¼', tip: 'ä¹è°±', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.MUSIC },
        { icon: 'ğŸ¥', tip: 'æˆ˜é¼“', baseCoins: 3, rarity: Rarity.EPIC, category: IconCategory.MUSIC },
        { icon: 'ğŸ§š', tip: 'ç²¾çµ 30%æ¦‚ç‡æ·»åŠ ğŸ¶',make:'ğŸ¶', baseCoins: 8, rarity: Rarity.LEGENDARY, category: IconCategory.MYTH },

        // æµ·æ´‹ç”Ÿç‰©ç±»
        { icon: 'ğŸ‹', tip: 'å·¨é²¸', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.MARINE },
        { icon: 'ğŸ¦', tip: 'è™¾', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.MARINE },
        { icon: 'ğŸš', tip: 'è´å£³', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.MARINE },
        { icon: 'ğŸ¡', tip: 'æ²³è±š', baseCoins: 2, rarity: Rarity.RARE, category: IconCategory.MARINE },
        { icon: 'ğŸ™', tip: 'ç« é±¼', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.MARINE },
        { icon: 'ğŸ³', tip: 'å–·æ°´é²¸ï¼šç”Ÿäº§ç¥ç§˜1', baseCoins: 4, rarity: Rarity.EPIC, category: IconCategory.MARINE },
        { icon: 'ğŸ¬', tip: 'æµ·è±šï¼šç”Ÿäº§ç¥ç§˜1', baseCoins: 4, rarity: Rarity.EPIC, category: IconCategory.MARINE },
        { icon: 'ğŸ§œâ€â™€ï¸', tip: 'äººé±¼å…¬ä¸»:å¯ä»¥å¬å”¤æµ·ç‹ç±»', baseCoins: 2, rarity: Rarity.EPIC, category: IconCategory.MARINE },

        // æ°´æ™¶å®çŸ³ç±»
        { icon: 'â¬œ', tip: 'æ™®é€šçŸ¿çŸ³', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.GEM },
        { icon: 'ğŸ”¶', tip: 'ç¥ç€', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.GEM },
        { icon: 'ğŸ”·', tip: 'è“å®çŸ³', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.GEM },
        { icon: 'â™¦ï¸', tip: 'çº¢å®çŸ³', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.GEM },
        { icon: 'ğŸŸ¡', tip: 'é»„å®çŸ³', baseCoins: 4, rarity: Rarity.EPIC, category: IconCategory.GEM },
        { icon: 'ğŸ”º', tip: 'æ°´æ™¶', baseCoins: 4, rarity: Rarity.EPIC, category: IconCategory.GEM },
        { icon: 'ğŸ’', tip: 'é’»çŸ³:ç”Ÿäº§ææ–™3', baseCoins: 10, rarity: Rarity.LEGENDARY, category: IconCategory.GEM },
        { icon: 'ğŸ”®', tip: 'é­”æ³•æ°´æ™¶:ç”Ÿäº§ç¥ç§˜3', baseCoins: 8, rarity: Rarity.LEGENDARY, category: IconCategory.GEM },

        // æ—¶ç©ºå…ƒç´ ç±» ç¿»è½¬
        { icon: 'ğŸŒŒ', tip: 'æ˜Ÿç©º', baseCoins: 5, rarity: Rarity.EPIC, category: IconCategory.TIME },
        { icon: 'ğŸŒ ', tip: 'æµæ˜Ÿ', baseCoins: 5, rarity: Rarity.EPIC, category: IconCategory.TIME },
        { icon: 'ğŸŒ™', tip: 'æœˆå…‰', baseCoins: 4, rarity: Rarity.EPIC, category: IconCategory.TIME },
        { icon: 'ğŸŒ', tip: 'å¤ªé˜³', baseCoins: 3, rarity: Rarity.EPIC, category: IconCategory.TIME },
        { icon: 'ğŸŒ€', tip: 'æ—¶ç©ºå€’æµ', baseCoins: 0, rarity: Rarity.LEGENDARY, category: IconCategory.TIME },
        { icon: 'âŒ›', tip: 'æ—¶ä¹‹æ²™ï¼šç”Ÿäº§ç¥ç§˜2', baseCoins: 8, rarity: Rarity.LEGENDARY, category: IconCategory.TIME },

        // ç§‘æŠ€ç±» å‡çº§
        { icon: 'âš™ï¸', tip: 'æœºæ¢°é½¿è½®', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.TECH },
        { icon: 'ğŸ”‹', tip: 'é«˜èƒ½ç”µæ± ', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.TECH },
        { icon: 'ğŸ’»', tip: 'ç»ˆç«¯è®¾å¤‡', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.TECH },
        { icon: 'ğŸ®', tip: 'æ§åˆ¶å™¨', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.TECH },
        { icon: 'ğŸ“±', tip: 'æ™ºèƒ½è®¾å¤‡', baseCoins: 4, rarity: Rarity.EPIC, category: IconCategory.TECH },
        { icon: 'ğŸ›°ï¸', tip: 'å«æ˜Ÿæ¨¡å—', baseCoins: 4, rarity: Rarity.EPIC, category: IconCategory.TECH },
        { icon: 'ğŸ¤–', tip: 'æœºå™¨äºº', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.TECH },
        { icon: 'ğŸ›¸', tip: 'æ—¶å…‰æœº', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.TECH },

        // é­”æ³•ç¬¦æ–‡ç±»
        // { icon: 'âœ¡ï¸', tip: 'å…­èŠ’æ˜Ÿ', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.RUNE },
        // { icon: 'ğŸ•¯ï¸', tip: 'é­”æ³•çƒ›å°', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.RUNE },
        // { icon: 'âšœï¸', tip: 'åœ£å°', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.RUNE },
        // { icon: 'ğŸ”¯', tip: 'æ³•é˜µ', baseCoins: 9, rarity: Rarity.EPIC, category: IconCategory.RUNE },
        // { icon: 'â˜¯ï¸', tip: 'é˜´é˜³ç¬¦', baseCoins: 6, rarity: Rarity.RARE, category: IconCategory.RUNE },
        // { icon: 'âš›ï¸', tip: 'å…ƒç´ ç¬¦æ–‡', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.RUNE },
        // { icon: 'ğŸ”®', tip: 'é¢„è¨€ç¬¦æ–‡', baseCoins: 16, rarity: Rarity.LEGENDARY, category: IconCategory.RUNE },
        // { icon: 'ğŸ“œ', tip: 'å¤ä»£å·è½´', baseCoins: 4, rarity: Rarity.RARE, category: IconCategory.RUNE },
    ];

    let isPanelVisible = false;

    function checkMermaidInteraction(grid, row, col, highlightGroups) {
        const currentCard = grid[row][col];
        if (!currentCard || currentCard.icon !== 'ğŸ§œâ€â™€ï¸') return false;

        // æ£€æŸ¥å…«ä¸ªæ–¹å‘çš„ç›¸é‚»æ ¼å­
        const directions = [
            [-1, -1], [-1, 0], [-1, 1],
            [0, -1],           [0, 1],
            [1, -1],  [1, 0],  [1, 1]
        ];

        const marineNeighbors = [];
        let availableSpots = 0;

        // æ£€æŸ¥å‘¨å›´çš„æµ·æ´‹ç”Ÿç‰©å’Œå¯ç”¨æ ¼å­æ•°
        for (const [dx, dy] of directions) {
            const newRow = row + dx;
            const newCol = col + dy;

            // æ£€æŸ¥ä½ç½®æ˜¯å¦åœ¨ç½‘æ ¼å†…
            if (newRow >= 0 && newRow < 5 && newCol >= 0 && newCol < 5) {
                availableSpots++;
                const neighbor = grid[newRow][newCol];
                if (neighbor && neighbor.category === IconCategory.MARINE) {
                    const element = document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`);
                    marineNeighbors.push({ card: neighbor, element: element });
                }
            }
        }

        // å¦‚æœæ‰€æœ‰å¯ç”¨æ ¼å­éƒ½æ˜¯æµ·æ´‹ç”Ÿç‰©
        if (marineNeighbors.length === availableSpots) {
            const currentElement = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);

            // å°†å½“å‰å¡ç‰Œå’Œç›¸é‚»å¡ç‰ŒåŠ å…¥é«˜äº®ç»„
            const group = [
                { card: currentCard, element: currentElement },
                ...marineNeighbors
            ];
            highlightGroups.push(group);

            // æ·»åŠ å·¨é²¸åˆ°æ‰‹ç‰Œ
            const whaleCard = iconData.find(card => card.icon === 'ğŸ‹');
            if (whaleCard) {
                handCards.push({...whaleCard});
                setTimeout(() => {
                    showFloatingText(currentElement, 'âœ¨ å¬å”¤å·¨é²¸!');
                    updateHandCards();
                }, 500);
            }

            return true;
        }

        return false;
    }

    function checkMusicInteraction(grid, row, col, highlightGroups) {
        const currentSlot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
        const currentCard = currentSlot?.__card;

        // æ£€æŸ¥æ˜¯å¦æ˜¯ä¹è°±
        if (!currentCard || currentCard.icon !== 'ğŸ¼') return false;

        const directions = [
            [-1,-1], [-1,0], [-1,1],
            [0,-1],         [0,1],
            [1,-1],  [1,0],  [1,1]
        ];

        const musicElements = [];

        // æ£€æŸ¥å‘¨å›´8ä¸ªæ–¹å‘çš„éŸ³ç¬¦
        for (const [dx, dy] of directions) {
            const newRow = row + dx;
            const newCol = col + dy;

            if (newRow >= 0 && newRow < 5 && newCol >= 0 && newCol < 5) {
                const targetSlot = document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`);
                const targetCard = targetSlot?.__card;

                if (targetCard && (targetCard.icon === 'ğŸµ' || targetCard.icon === 'ğŸ¶')) {
                    musicElements.push({
                        row: newRow,
                        col: newCol,
                        slot: targetSlot,
                        card: targetCard
                    });
                }
            }
        }

        if (musicElements.length > 0) {
            // å¤„ç†æ¯ä¸ªéŸ³ä¹å…ƒç´ 
            musicElements.forEach(({slot: targetSlot, card: targetCard}) => {
                // æ˜¾ç¤ºç ´åæ•ˆæœ
                showMusicDestructionEffect(currentSlot, targetSlot);
                // å¢åŠ ä¹è°±åŸºç¡€é‡‘å¸
                currentCard.baseCoins += 1;

                // æ›´æ–°ä¹è°±æç¤ºæ–‡æœ¬
                currentSlot.setAttribute('data-tooltip',
                    `ä¹è°± (åŸºç¡€é‡‘å¸:${currentCard.baseCoins})`);

                // æ¸…é™¤ç›®æ ‡æ ¼å­
                targetSlot.innerHTML = '';
                targetSlot.removeAttribute('data-tooltip');
                targetSlot.__card = null;
            });

            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç”Ÿæˆç²¾çµçš„æ¡ä»¶
            if (Math.floor(currentCard.baseCoins / 12) >
                Math.floor((currentCard.baseCoins - musicElements.length) / 12)) {
                // æ·»åŠ ç²¾çµåˆ°æ‰‹ç‰Œ
                const fairyCard = {...iconData.find(card => card.icon === 'ğŸ§š')};
                if (fairyCard) {
                    handCards.push(fairyCard);
                    showFloatingText(currentSlot, 'âœ¨ è·å¾—ç²¾çµ! âœ¨');
                }
            }

            highlightGroups.push([currentSlot]);
            return true;
        }

        return false;
    }

    function showMusicDestructionEffect(sourceSlot, targetSlot) {
        // åˆ›å»ºç‰¹æ•ˆå®¹å™¨
        const effectContainer = document.createElement('div');
        effectContainer.className = 'music-effect';
        effectContainer.style.position = 'absolute';
        effectContainer.style.pointerEvents = 'none';
        effectContainer.style.zIndex = '9999';

        // æ·»åŠ åˆ°åˆ—å®¹å™¨ä¸­
        const column = sourceSlot.closest('.column');
        column.appendChild(effectContainer);

        // è·å–ç›¸å¯¹ä½ç½®
        const columnRect = column.getBoundingClientRect();
        const sourceRect = sourceSlot.getBoundingClientRect();
        const targetRect = targetSlot.getBoundingClientRect();

        // è®¡ç®—ç›¸å¯¹åæ ‡
        const startX = sourceRect.left - columnRect.left + sourceRect.width / 2;
        const startY = sourceRect.top - columnRect.top + sourceRect.height / 2;
        const endX = targetRect.left - columnRect.left + targetRect.width / 2;
        const endY = targetRect.top - columnRect.top + targetRect.height / 2;

        // åˆ›å»ºéŸ³ç¬¦çº¿
        const line = document.createElement('div');
        line.className = 'music-line';
        const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
        line.style.cssText = `
            position: absolute;
            width: ${distance}px;
            left: ${startX}px;
            top: ${startY}px;
            transform-origin: left center;
            transform: rotate(${Math.atan2(endY - startY, endX - startX)}rad);
        `;
        effectContainer.appendChild(line);

        // åˆ›å»ºéŸ³ä¹æ–‡æœ¬æ•ˆæœ
        const text = document.createElement('div');
        text.className = 'music-text';
        text.textContent = 'â™ª ç ´å!';
        text.style.cssText = `
            position: absolute;
            left: ${endX}px;
            top: ${endY - 20}px;
            transform: translate(-50%, -50%);
        `;
        effectContainer.appendChild(text);

        // æ·»åŠ ç ´ååŠ¨ç”»ç±»
        targetSlot.classList.add('destroy-animation');

        // ç«‹å³å¤„ç†éŸ³ç¬¦ç§»é™¤
        const targetCard = targetSlot.__card;
        if (targetCard) {
            const cardIndex = handCards.findIndex(card =>
                card.icon === targetCard.icon && !card.used);
            if (cardIndex !== -1) {
                handCards[cardIndex].used = true;
            }
        }

        // ç«‹å³æ¸…é™¤ç›®æ ‡æ ¼å­
        targetSlot.innerHTML = '';
        targetSlot.removeAttribute('data-tooltip');
        targetSlot.__card = null;

        // æ›´æ–°æ‰‹ç‰Œæ˜¾ç¤º
        updateHandCards();

        // å»¶æ—¶ç§»é™¤æ•ˆæœ
        setTimeout(() => {
            effectContainer.remove();
            targetSlot.classList.remove('destroy-animation');
        }, 1000);
    }

    // æ·»åŠ æ›´æ–°æ‰‹ç‰Œæ˜¾ç¤ºçš„å‡½æ•°
    function updateHandCards() {
        // ç§»é™¤å·²ä½¿ç”¨çš„å¡ç‰Œ
        handCards = handCards.filter(card => !card.used);

        // è¿™é‡Œå¯ä»¥æ·»åŠ æ‰‹ç‰ŒUIæ›´æ–°çš„é€»è¾‘
        // å¦‚æœæœ‰ç›¸å…³çš„UIå…ƒç´ éœ€è¦æ›´æ–°
    }

    // æ·»åŠ ç ´ååŠ¨ç”»æ ·å¼
    const musicDestructionStyles = `
    .music-effect {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
    }

    .music-line {
        height: 2px;
        background: linear-gradient(90deg, #ff69b4, #00bcd4);
        z-index: 9999;
        animation: musicPulse 1s ease-in-out;
    }

    .music-text {
        color: #ff69b4;
        font-weight: bold;
        font-size: 16px;
        text-shadow: 0 0 5px rgba(0,0,0,0.8);
        z-index: 9999;
        animation: musicTextFloat 1.5s ease-out;
        white-space: nowrap;
    }

    .destroy-animation {
        animation: destroyPulse 1s ease-in-out;
    }

    @keyframes musicPulse {
        0% { opacity: 0; height: 1px; }
        50% { opacity: 1; height: 3px; }
        100% { opacity: 0; height: 2px; }
    }

    @keyframes musicTextFloat {
        0% { opacity: 0; transform: translate(-50%, -30%); }
        20% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; transform: translate(-50%, -100%); }
    }

    @keyframes destroyPulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.5; }
        100% { transform: scale(1); opacity: 0; }
    }`;

    function toggleUpgradePanel() {
        const panel = document.getElementById('upgrade-panel');
        isPanelVisible = !isPanelVisible;
        panel.style.display = isPanelVisible ? 'block' : 'none';
    }

    function hideUpgradePanel() {
        isPanelVisible = false;
        document.getElementById('upgrade-panel').style.display = 'none';
        document.getElementById('show-upgrade-button').style.display = 'block';
    }

    function giveUpgrade() {
        hasSelectedUpgrade = true; // æ ‡è®°å·²å®Œæˆé€‰æ‹©
        document.getElementById('show-upgrade-button').style.display = 'none';
        isPanelVisible = false;
        document.getElementById('upgrade-panel').style.display = 'none';
        document.body.classList.remove('upgrade-panel-visible'); // æ·»åŠ è¿™è¡Œ
        clearNoticeChoose();
    }

    function showUpgradeChoices() {
        const panel = document.getElementById('upgrade-panel');
        const container = document.getElementById('upgrade-options');
        container.innerHTML = '';

        // æ ¹æ®æ˜¯å¦æœ‰å¾…å¤„ç†çš„é«˜ç¨€æœ‰åº¦é€‰æ‹©æ¥å†³å®šæ˜¾ç¤ºå“ªç§é€‰é¡¹
        if (window.pendingRareUpgrades > 0) {
            // é«˜ç¨€æœ‰åº¦3é€‰1
            const rareCards = filteredIconData.filter(card =>
                card.rarity === Rarity.EPIC || card.rarity === Rarity.LEGENDARY
            );

            // éšæœºé€‰æ‹©3å¼ é«˜ç¨€æœ‰åº¦å¡ç‰Œ
            const choices = [];
            while (choices.length < 3 && rareCards.length > 0) {
                const index = Math.floor(Math.random() * rareCards.length);
                choices.push({...rareCards[index]});
                rareCards.splice(index, 1);
            }

            // åˆ›å»ºé€‰é¡¹å¡ç‰‡
            choices.forEach(card => {
                const choice = document.createElement('div');
                choice.className = 'upgrade-card';
                choice.innerHTML = `
                    <div class="icon">${card.icon}</div>
                    <div>${card.tip}</div>
                    <div style="color: #FFD700">${card.rarity}</div>
                    <div>åŸºç¡€é‡‘å¸: ${card.baseCoins}</div>
                `;

                choice.onclick = () => {
                    handCards.push(card);
                    if (window.pendingRareUpgrades > 0) {
                        window.pendingRareUpgrades--;
                    }
                    giveUpgrade();
                    showFloatingText(choice, 'âœ¨ è·å¾—å¡ç‰Œ!');

                    showUpgradeChoices();
                };

                container.appendChild(choice);
            });

        } else {
            // å¸¸è§„3é€‰1(ä½¿ç”¨å½“å‰æŒ‘æˆ˜çš„æ¦‚ç‡)
            const currentProbs = challenges[currentChallenge];
            const cardPool = [...filteredIconData];
            const choices = [];

            // è·å–3ä¸ªéšæœºé€‰é¡¹
            for (let i = 0; i < 3; i++) {
                if (cardPool.length === 0) break;

                const roll = Math.random()*100;
                let card;

                if (roll < currentProbs.legendaryChance) {
                    card = getRandomCardByRarity(cardPool, Rarity.legendaryChance);
                } else if (roll < currentProbs.legendaryChance + currentProbs.epicChance) {
                    card = getRandomCardByRarity(cardPool, Rarity.EPIC);
                } else if (roll < currentProbs.legendaryChance + currentProbs.epicChance + currentProbs.rareChance) {
                    card = getRandomCardByRarity(cardPool, Rarity.RARE);
                } else {
                    card = getRandomCardByRarity(cardPool, Rarity.COMMON);
                }

                if (card) {
                    choices.push({...card});
                }
            }

            // åˆ›å»ºé€‰é¡¹å¡ç‰‡
            choices.forEach(card => {
                const choice = document.createElement('div');
                choice.className = 'upgrade-card';
                choice.innerHTML = `
                <div class="icon">${card.icon}</div>
                <div>${card.tip}</div>
                <div style="color: ${getRarityColor(card.rarity)}">${card.rarity}</div>
                <div>åŸºç¡€é‡‘å¸: ${card.baseCoins}</div>
            `;

                choice.onclick = () => {
                    handCards.push(card);
                    // æ›´æ–°æ„ç­‘æ¬¡æ•°
                    if (window.deckBuildingCount > 0) {
                        window.deckBuildingCount--;

                        if (window.deckBuildingCount > 0) {
                            // æ›´æ–°æ ‡é¢˜
                            const panelTitle = document.querySelector('#upgrade-panel h2');
                            panelTitle.textContent = `ğŸ® åˆå§‹æ„ç­‘ (å‰©ä½™${window.deckBuildingCount}æ¬¡)`;
                            // åˆ·æ–°æ–°çš„é€‰é¡¹
                            showUpgradeChoices();
                        } else {
                            // æ„ç­‘å®Œæˆ
                            const panelTitle = document.querySelector('#upgrade-panel h2');
                            panelTitle.textContent = `ğŸ® é€‰æ‹©ä½ çš„å¥–åŠ±`;
                            const upgradePanel = document.getElementById('upgrade-panel');
                            upgradePanel.style.display = 'none';
                            document.getElementById('start-button').disabled = false;
                            showDeckCompleteMessage();
                        }
                    } else {
                        // éåˆå§‹æ„ç­‘çš„æƒ…å†µ
                        giveUpgrade();
                        showFloatingText(choice, 'âœ¨ è·å¾—å¡ç‰Œ!');
                    }
                };

                container.appendChild(choice);
            });
        }

        panel.style.display = 'block';
        document.getElementById('show-upgrade-button').style.display = 'none';
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®ç¨€æœ‰åº¦è·å–éšæœºå¡ç‰Œ
    function getRandomCardByRarity(cardPool, rarity) {
        const cards = cardPool.filter(card => card.rarity === rarity);
        if (cards.length === 0) return null;

        const index = Math.floor(Math.random() * cards.length);
        const selected = cards[index];

        // ä»å¡æ± ä¸­ç§»é™¤å·²é€‰å¡ç‰Œ
        const poolIndex = cardPool.findIndex(card => card.icon === selected.icon);
        if (poolIndex !== -1) {
            cardPool.splice(poolIndex, 1);
        }

        return selected;
    }

    // è¾…åŠ©å‡½æ•°ï¼šè·å–ç¨€æœ‰åº¦å¯¹åº”çš„é¢œè‰²
    function getRarityColor(rarity) {
        switch (rarity) {
            case Rarity.LEGENDARY: return '#FFD700'; // é‡‘è‰²
            case Rarity.EPIC: return '#9370DB';      // ç´«è‰²
            case Rarity.RARE: return '#4169E1';      // è“è‰²
            case Rarity.COMMON: return '#90EE90';    // ç»¿è‰²
            default: return '#FFFFFF';
        }
    }

    const columns = Array.from({ length: 5 }, (_, i) => document.getElementById(`col-${i}`));
    const rows = 5;

    // åˆå§‹æ‰‹ç‰Œ
    let handCards = [
        // { icon: 'ğŸ—ï¸', tip: 'å¼€é”', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.Key },
        // { icon: 'ğŸ“¦', tip: 'å®ç®±', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        // { icon: 'ğŸ“¦', tip: 'å®ç®±', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        // { icon: 'ğŸ“¦', tip: 'å®ç®±', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        // { icon: 'ğŸ“¦', tip: 'å®ç®±', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        // { icon: 'ğŸ“¦', tip: 'å®ç®±', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        // { icon: 'ğŸ“¦', tip: 'å®ç®±', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        { icon: 'ğŸšï¸', tip: 'éšœç¢', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.BUILDING },
        { icon: 'ğŸ¦Š', tip: 'ç‹ç‹¸', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.ANIMAL },
    ];

    // ä¿®æ”¹ fillColumn å‡½æ•°ï¼Œæ·»åŠ å»ºç­‘å›ºå®šé€»è¾‘
    function fillColumn(col) {
        col.innerHTML = '';
        const colIndex = parseInt(col.dataset.index);

        // å¦‚æœæ˜¯ç¬¬ä¸€åˆ—ï¼Œåˆ›å»ºä¸´æ—¶æ ˆå¹¶æ‰“ä¹±
        if(colIndex === 0) {
            // åˆ›å»º25ä¸ªæ ¼å­çš„æ•°ç»„
            let slots = new Array(25).fill(null);

            // ä½¿ç”¨è¿‡æ»¤åçš„å¡ç‰Œåº“
            let tempStack = [...handCards];

            // è®°å½•å½“å‰æ‰€æœ‰å»ºç­‘çš„ä½ç½®
            let buildingPositions = [];
            document.querySelectorAll('.slot').forEach(slot => {
                if (slot.__card && slot.__card.category === IconCategory.BUILDING) {
                    const row = parseInt(slot.dataset.row);
                    const col = parseInt(slot.dataset.col);
                    buildingPositions.push({
                        row: row,
                        col: col,
                        card: slot.__card
                    });
                }
            });

            // å…ˆå°†å»ºç­‘æ”¾å›åŸä½ç½®
            buildingPositions.forEach(building => {
                const slotIndex = building.row * columns.length + building.col;
                slots[slotIndex] = building.card;

                // ä»ä¸´æ—¶æ ˆä¸­ç§»é™¤è¯¥å»ºç­‘å¡ç‰Œ
                const buildingIndex = tempStack.findIndex(card =>
                    card.icon === building.card.icon &&
                    card.category === building.card.category
                );
                if (buildingIndex !== -1) {
                    tempStack.splice(buildingIndex, 1);
                }
            });

            // Fisher-Yates æ´—ç‰Œç®—æ³•æ‰“ä¹±å‰©ä½™å¡ç‰Œ
            for(let i = tempStack.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [tempStack[i], tempStack[j]] = [tempStack[j], tempStack[i]];
            }

            // éšæœºåˆ†é…å‰©ä½™å¡ç‰Œåˆ°ç©ºæ ¼å­
            let availableSlots = [];
            for(let i = 0; i < 25; i++) {
                if(slots[i] === null) {
                    availableSlots.push(i);
                }
            }

            tempStack.forEach(card => {
                if(availableSlots.length > 0) {
                    // éšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨æ ¼å­
                    const randomIndex = Math.floor(Math.random() * availableSlots.length);
                    const slotIndex = availableSlots[randomIndex];

                    // å°†å¡ç‰Œæ”¾å…¥é€‰ä¸­çš„æ ¼å­
                    slots[slotIndex] = card;

                    // ä»å¯ç”¨æ ¼å­ä¸­ç§»é™¤å·²ä½¿ç”¨çš„æ ¼å­
                    availableSlots.splice(randomIndex, 1);
                }
            });

            // ä¿å­˜æ‰“ä¹±åçš„ç»“æœä¾›å…¶ä»–åˆ—ä½¿ç”¨
            window.currentSlots = slots;
        }

        // æ¸²æŸ“å½“å‰åˆ—çš„æ ¼å­
        for (let i = 0; i < rows; i++) {
            const slot = document.createElement('div');
            slot.className = 'slot';
            slot.setAttribute('data-row', i);
            slot.setAttribute('data-col', colIndex);

            const slotIndex = i * columns.length + colIndex;
            const card = window.currentSlots[slotIndex];

            if (card) {
                slot.innerHTML = `
                    <div class="card-icon">${card.icon}</div>
                    <div class="coin-indicator">+${card.baseCoins}ğŸ’°</div>
                `;
                slot.setAttribute('data-tooltip', `${card.tip} (${card.rarity})`);

                // å¦‚æœæ˜¯å»ºç­‘ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                if (card.category === IconCategory.BUILDING) {
                    slot.classList.add('building-slot');
                }

                // åœ¨slotå…ƒç´ ä¸Šå­˜å‚¨å¯¹å¡ç‰Œçš„å¼•ç”¨
                slot.__card = card;
            } else {
                slot.innerHTML = '';
            }

            col.appendChild(slot);
        }
    }

    const buildingStyles = `
    .building-slot {
        border: 2px solid #8e44ad;
        background: rgba(142, 68, 173, 0.1);
    }

    .building-slot .card-icon {
        transform: scale(1.1);
        transition: transform 0.3s ease;
    }

    .building-slot:hover .card-icon {
        transform: scale(1.2);
    }
    `;

    let hasSelectedUpgrade = false; // æ·»åŠ é€‰æ‹©çŠ¶æ€æ ‡è®°

    function startSlots() {
        // å¦‚æœæœªå®Œæˆä¸Šä¸€è½®é€‰æ‹©ï¼Œç¦æ­¢å¼€å§‹
        if (!hasSelectedUpgrade) {
            noticeChoose();
            toggleUpgradePanel();
            return;
        }

        // å¦‚æœæœ‰å¾…å¤„ç†çš„é«˜ç¨€æœ‰åº¦é€‰æ‹©
        if (window.pendingRareUpgrades > 0) {
            // æ˜¾ç¤ºé€‰æ‹©é¢æ¿
            showUpgradeChoices();
            return;
        }

        // å¦‚æœæœªå®Œæˆä¸Šä¸€è½®é€‰æ‹©,ç¦æ­¢å¼€å§‹
        if(!hasSelectedUpgrade) {
            noticeChoose();
            toggleUpgradePanel();
            return;
        }

        if (remainingSlots <= 0) {
            checkChallengeResult();
            return;
        }

        remainingSlots--;
        totalSlots++;
        updateRemainingSlots();

        clearHighlights();
        hasSelectedUpgrade = false; // é‡ç½®é€‰æ‹©çŠ¶æ€

        columns.forEach((col, index) => {
            let interval = setInterval(() => fillColumn(col), 100);
            setTimeout(() => {
                clearInterval(interval);
                fillColumn(col);
                if (index === columns.length - 1) {
                    setTimeout(() => {
                        checkWin();

                        // å¤„ç†æ‰€æœ‰æ ¼å­çš„ç”Ÿäº§æ•ˆæœ
                        const allSlots = document.querySelectorAll('.slot');
                        allSlots.forEach(slot => {
                            if (slot.__card) {
                                processProduction(slot.__card, slot);
                            }
                        });
                        setTimeout(showUpgradeChoices, 500);
                    }, 500);
                }
            }, 1000 + index * 500);
        });
    }

    function noticeChoose(){
        const panel = document.getElementById('upgrade-panel');
        const skipButton = panel.querySelector('.skip-button');
        // ä½¿ç”¨ç›´æ¥æ ·å¼è®¾ç½®
        panel.style.border = '3px solid #4a90e2';
        panel.style.boxShadow = '0 0 20px #4a90e2';
        panel.style.transition = 'all 0.3s ease';

        skipButton.style.background = '#4a90e2';
        skipButton.style.transform = 'scale(1.1)';
        skipButton.style.transition = 'all 0.3s ease';
    }

    function clearNoticeChoose(){
        const panel = document.getElementById('upgrade-panel');
        const skipButton = panel.querySelector('.skip-button');
        // ä½¿ç”¨ç›´æ¥æ ·å¼è®¾ç½®
        panel.style.border = '';
        panel.style.boxShadow = '';
        panel.style.transition = '';

        skipButton.style.background = '';
        skipButton.style.transform = '';
        skipButton.style.transition = '';
    }

    // æ–°å¢å‡½æ•°ï¼šæ£€æŸ¥æ°´ä¸æ¤ç‰©ç›¸é‚»
    function checkWaterPlantInteraction(grid, row, col, highlightGroups) {
        const currentCard = grid[row][col];
        if (!currentCard) return;

        // æ£€æŸ¥æ˜¯å¦æ˜¯æ°´
        if (currentCard.icon === 'ğŸ’§' && currentCard.category === IconCategory.WEATHER) {
            // æ£€æŸ¥å…«ä¸ªæ–¹å‘çš„ç›¸é‚»æ ¼å­ï¼ˆåŒ…æ‹¬å¯¹è§’çº¿ï¼‰
            const directions = [
                { dr: -1, dc: 0 },  // ä¸Š
                { dr: 1, dc: 0 },   // ä¸‹
                { dr: 0, dc: -1 },  // å·¦
                { dr: 0, dc: 1 },   // å³
                { dr: -1, dc: -1 }, // å·¦ä¸Š
                { dr: -1, dc: 1 },  // å³ä¸Š
                { dr: 1, dc: -1 },  // å·¦ä¸‹
                { dr: 1, dc: 1 }    // å³ä¸‹
            ];

            const foundPlants = [];  // å­˜å‚¨æ‰¾åˆ°çš„æ‰€æœ‰æ¤ç‰©
            const waterSlot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);

            // æŸ¥æ‰¾å‘¨å›´æ‰€æœ‰çš„æ¤ç‰©
            for (const dir of directions) {
                const newRow = row + dir.dr;
                const newCol = col + dir.dc;

                // æ£€æŸ¥è¾¹ç•Œ
                if (newRow < 0 || newRow >= rows || newCol < 0 || newCol >= columns.length) {
                    continue;
                }

                const adjacentCard = grid[newRow][newCol];
                if (adjacentCard && adjacentCard.category === IconCategory.PLANT) {
                    // æ‰¾åˆ°æ¤ç‰©
                    const plantSlot = document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`);
                    foundPlants.push({
                        card: adjacentCard,
                        row: newRow,
                        col: newCol,
                        slot: plantSlot
                    });
                }
            }

            // å¦‚æœæ‰¾åˆ°äº†æ¤ç‰©ï¼Œå¤„ç†æ‰€æœ‰æ¤ç‰©
            if (foundPlants.length > 0) {
                // 20%æ¦‚ç‡è§¦å‘æˆé•¿æ•ˆæœ
                if (Math.random() < 0.2) {
                    // å°†æ°´æ·»åŠ åˆ°é«˜äº®ç»„
                    const highlightGroup = [{ row, col }];  // æ°´çš„ä½ç½®

                    // å°†æ‰€æœ‰æ¤ç‰©æ·»åŠ åˆ°é«˜äº®ç»„
                    foundPlants.forEach(plant => {
                        highlightGroup.push({ row: plant.row, col: plant.col });
                    });

                    // æ·»åŠ åˆ°é«˜äº®ç»„
                    highlightGroups.push(highlightGroup);

                    // å¤„ç†ç‰¹æ•ˆå’Œæˆé•¿
                    setTimeout(() => {
                        // æ·»åŠ åŸºç¡€é‡‘å¸
                        addCoins(currentCard.baseCoins);

                        // ä¸ºæ¯ä¸ªæ¤ç‰©æ˜¾ç¤ºæˆé•¿ç‰¹æ•ˆå¹¶åˆ›å»ºæ–°æ¤ç‰©
                        foundPlants.forEach((plant, index) => {
                            // å»¶è¿Ÿæ˜¾ç¤ºæ•ˆæœï¼Œåˆ›é€ è¿é”ååº”çš„è§†è§‰æ•ˆæœ
                            setTimeout(() => {
                                // æ˜¾ç¤ºæˆé•¿çº¿
                                showGrowthEffect(waterSlot, plant.slot);

                                // åˆ›å»ºæ›´é«˜ç¨€æœ‰åº¦çš„æ¤ç‰©
                                const newPlant = getHigherRarityPlant(plant.card);

                                // ä»æ‰‹ç‰Œä¸­ç§»é™¤åŸæ¤ç‰©
                                removeCardFromHand(plant.card);

                                // åœ¨åŸæ¤ç‰©ä½ç½®ç”Ÿæˆæ–°æ¤ç‰©
                                setTimeout(() => {
                                    spawnNewPlant(plant.row, plant.col, newPlant);
                                }, 300);

                            }, index * 200); // æ¯ä¸ªæ¤ç‰©ä¹‹é—´é—´éš”200ms
                        });

                        // ä»æ‰‹ç‰Œä¸­ç§»é™¤æ°´
                        setTimeout(() => {
                            removeCardFromHand(currentCard);
                            console.log(`æ°´æ»‹å…»äº†${foundPlants.length}æ ªæ¤ç‰©ï¼å‰©ä½™æ‰‹ç‰Œæ•°é‡ï¼š${handCards.length}`);
                        }, foundPlants.length * 200 + 300);

                    }, 500);
                }
            }
        }
    }

    // è·å–æ›´é«˜ç¨€æœ‰åº¦çš„æ¤ç‰©ï¼ˆä¸¥æ ¼æŒ‰ç…§ç¨€æœ‰åº¦å‡çº§ï¼‰
    function getHigherRarityPlant(originalPlant) {
        // ç¨€æœ‰åº¦å‡çº§è·¯å¾„
        const rarityUpgrade = {
            [Rarity.COMMON]: Rarity.RARE,
            [Rarity.RARE]: Rarity.EPIC,
            [Rarity.EPIC]: Rarity.LEGENDARY,
            [Rarity.LEGENDARY]: Rarity.LEGENDARY
        };

        // ç¡®å®šä¸‹ä¸€ä¸ªç¨€æœ‰åº¦çº§åˆ«
        const nextRarity = rarityUpgrade[originalPlant.rarity];

        // ä»è¿‡æ»¤åçš„å¡ç‰Œåº“ä¸­é€‰æ‹©ç¬¦åˆä¸‹ä¸€çº§ç¨€æœ‰åº¦çš„æ¤ç‰©å¡ç‰Œ
        const availablePlants = filteredIconData.filter(card =>
            card.category === IconCategory.PLANT &&
            card.rarity === nextRarity
        );

        // å¦‚æœæœ‰å¯ç”¨çš„æ›´é«˜ç¨€æœ‰åº¦æ¤ç‰©ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
        if (availablePlants && availablePlants.length > 0) {
            return availablePlants[Math.floor(Math.random() * availablePlants.length)];
        }

        // å¦‚æœæ²¡æœ‰æ›´é«˜ç¨€æœ‰åº¦çš„æ¤ç‰©ï¼Œè¿”å›åŸæ¤ç‰©
        return originalPlant;
    }

    // ä»æ‰‹ç‰Œä¸­ç§»é™¤å¡ç‰Œ
    function removeCardFromHand(card) {
        const index = handCards.findIndex(c =>
            c.icon === card.icon &&
            c.category === card.category
        );

        if (index !== -1) {
            handCards.splice(index, 1);
        }
    }

    // åœ¨æŒ‡å®šä½ç½®ç”Ÿæˆæ–°æ¤ç‰©
    function spawnNewPlant(row, col, plant) {
        const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
        if (!slot) return;

        // æ¸…ç©ºåŸæœ‰å†…å®¹
        slot.innerHTML = '';
        slot.removeAttribute('data-tooltip');
        slot.classList.remove('highlight');

        // æ·»åŠ æ–°æ¤ç‰©
        slot.innerHTML = `
        <div class="icon">${plant.icon}</div>
        <div class="coin-indicator">+${plant.baseCoins}ğŸ’°</div>
    `;
        slot.setAttribute('data-tooltip', `${plant.tip}`);

        // ä¿å­˜å¼•ç”¨
        slot.__card = plant;

        // æ·»åŠ å‡ºåœºåŠ¨ç”»
        slot.classList.add('grow-animation');
        setTimeout(() => {
            slot.classList.remove('grow-animation');

            // è§¦å‘æ–°æ¤ç‰©çš„é‡‘å¸æ•ˆæœ
            addCoins(plant.baseCoins, slot);
        }, 500);

        // å°†æ–°æ¤ç‰©æ·»åŠ åˆ°æ‰‹ç‰Œä¸­
        handCards.push(plant);
    }

    // æ˜¾ç¤ºæˆé•¿ç‰¹æ•ˆ
    function showGrowthEffect(waterSlot, plantSlot) {
        if (!waterSlot || !plantSlot) return;

        // åˆ›å»ºè¿æ¥çº¿ç‰¹æ•ˆ
        const line = document.createElement('div');
        line.className = 'growth-line';
        document.body.appendChild(line);

        // è·å–ä¸¤ä¸ªå…ƒç´ çš„ä½ç½®
        const waterRect = waterSlot.getBoundingClientRect();
        const plantRect = plantSlot.getBoundingClientRect();

        // è®¡ç®—çº¿çš„èµ·ç‚¹å’Œç»ˆç‚¹
        const startX = waterRect.left + waterRect.width / 2;
        const startY = waterRect.top + waterRect.height / 2;
        const endX = plantRect.left + plantRect.width / 2;
        const endY = plantRect.top + plantRect.height / 2;

        // è®¡ç®—çº¿çš„é•¿åº¦å’Œè§’åº¦
        const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
        const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;

        // è®¾ç½®çº¿çš„æ ·å¼
        line.style.width = `${length}px`;
        line.style.left = `${startX}px`;
        line.style.top = `${startY}px`;
        line.style.transform = `rotate(${angle}deg)`;

        // åˆ›å»ºæˆé•¿æç¤º
        const growthText = document.createElement('div');
        growthText.className = 'growth-text';
        growthText.textContent = 'æ¤ç‰©æˆé•¿!';
        growthText.style.left = `${(startX + endX) / 2}px`;
        growthText.style.top = `${(startY + endY) / 2 - 20}px`;
        document.body.appendChild(growthText);

        // è®¾ç½®åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
        setTimeout(() => {
            line.remove();
            growthText.remove();
        }, 1500);
    }

    function clearHighlights() {
        document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
    }

    // ä¿®æ”¹ checkWin å‡½æ•°ï¼Œå¢åŠ å®ç®±ä¸é’¥åŒ™ç›¸é‚»æ—¶çš„ç‰¹æ®Šæ¶ˆé™¤é€»è¾‘
    function checkWin() {
        const grid = [];
        const processed = new Set(); // ç”¨äºè®°å½•å·²å¤„ç†çš„ä½ç½®

        // æ„å»ºç½‘æ ¼æ•°æ®
        for (let row = 0; row < rows; row++) {
            grid[row] = [];
            for (let col = 0; col < columns.length; col++) {
                const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
                grid[row][col] = slot?.__card;
            }
        }

        const highlightGroups = [];
        let delay = 0;

        // éå†æ ¼å­æ£€æŸ¥ä¸‰æ¶ˆæ•ˆæœ
        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < columns.length; col++) {
                const key = `${row},${col}`;
                if (!processed.has(key) && grid[row][col]?.category === IconCategory.FESTIVAL) {
                    if (checkFestivalInteraction(grid, row, col, highlightGroups)) {
                        processed.add(key); // æ ‡è®°å½“å‰ä½ç½®å·²å¤„ç†
                        // æ ‡è®°ç›¸é‚»çš„èŠ‚æ—¥å…ƒç´ ä¸ºå·²å¤„ç†
                        const directions = [
                            [-1, -1], [-1, 0], [-1, 1],
                            [0, -1],           [0, 1],
                            [1, -1],  [1, 0],  [1, 1]
                        ];
                        for (const [dx, dy] of directions) {
                            const newRow = row + dx;
                            const newCol = col + dy;
                            if (newRow >= 0 && newRow < 5 && newCol >= 0 && newCol < 5) {
                                const newKey = `${newRow},${newCol}`;
                                processed.add(newKey);
                            }
                        }
                    }
                }
            }
        }

        // éå†æ‰€æœ‰æ ¼å­ï¼Œå¤„ç†é‡‘å¸æ•ˆæœ
        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < columns.length; col++) {
                const currentCard = grid[row][col];
                if (!currentCard) continue;

                // æ£€æŸ¥éŸ³ä¹ç¬¦å·ä¸å…¶ä»–ç¬¦å·ç›¸é‚»
                checkMusicInteraction(grid, row, col, highlightGroups);

                // æ£€æŸ¥å®ç®±ä¸é’¥åŒ™ç›¸é‚»
                checkKeyBoxPair(grid, row, col, highlightGroups);
                // æ£€æŸ¥æ°´ä¸æ¤ç‰©ç›¸é‚»
                checkWaterPlantInteraction(grid, row, col, highlightGroups);
                // çŒ«é¼ æ¸¸æˆ
                checkCatMouseInteraction(grid, row, col, highlightGroups);
                // äººé±¼å…¬ä¸»
                checkMermaidInteraction(grid, row, col, highlightGroups);

                // å®çŸ³é‡ç”Ÿ
                checkGemRespawn(grid, row, col, grid[row][col]);

                // è·å–åŸºç¡€é‡‘å¸
                const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
                if (slot && currentCard) {
                    setTimeout(() => {
                        addCoins(currentCard.baseCoins, slot);
                    }, delay);
                    delay += 100;
                }
            }
        }

        // å¤„ç†åŒ¹é…ç»„çš„é«˜äº®æ•ˆæœ
        let highlightDelay = delay; // åœ¨æ‰€æœ‰é‡‘å¸åŠ¨ç”»å®Œæˆåå†æ˜¾ç¤ºé«˜äº®
        highlightGroups.forEach(group => {
            setTimeout(() => {
                group.forEach(pos => {
                    const slot = document.querySelector(`.slot[data-row="${pos.row}"][data-col="${pos.col}"]`);
                    if (slot) slot.classList.add('highlight');
                });
            }, highlightDelay);
            highlightDelay += 300;
        });
    }

    // æ–°å¢å‡½æ•°ï¼šæ£€æŸ¥å®ç®±ä¸é’¥åŒ™ç›¸é‚»
    function checkKeyBoxPair(grid, row, col, highlightGroups) {
        const currentCard = grid[row][col];
        if (!currentCard) return;

        // æ£€æŸ¥æ˜¯å¦æ˜¯é’¥åŒ™
        if (currentCard.category === IconCategory.Key) {
            // æ£€æŸ¥å…«ä¸ªæ–¹å‘çš„ç›¸é‚»æ ¼å­ï¼ˆåŒ…æ‹¬å¯¹è§’çº¿ï¼‰
            const directions = [
                { dr: -1, dc: 0 },  // ä¸Š
                { dr: 1, dc: 0 },   // ä¸‹
                { dr: 0, dc: -1 },  // å·¦
                { dr: 0, dc: 1 },   // å³
                { dr: -1, dc: -1 }, // å·¦ä¸Š
                { dr: -1, dc: 1 },  // å³ä¸Š
                { dr: 1, dc: -1 },  // å·¦ä¸‹
                { dr: 1, dc: 1 }    // å³ä¸‹
            ];

            const foundBoxes = [];  // å­˜å‚¨æ‰¾åˆ°çš„æ‰€æœ‰å®ç®±
            const keySlot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);

            // æŸ¥æ‰¾å‘¨å›´æ‰€æœ‰çš„å®ç®±
            for (const dir of directions) {
                const newRow = row + dir.dr;
                const newCol = col + dir.dc;

                // æ£€æŸ¥è¾¹ç•Œ
                if (newRow < 0 || newRow >= rows || newCol < 0 || newCol >= columns.length) {
                    continue;
                }

                const adjacentCard = grid[newRow][newCol];
                if (adjacentCard && adjacentCard.category === IconCategory.Box) {
                    // æ‰¾åˆ°å®ç®±
                    const boxSlot = document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`);
                    foundBoxes.push({
                        card: adjacentCard,
                        row: newRow,
                        col: newCol,
                        slot: boxSlot
                    });
                }
            }

            // å¦‚æœæ‰¾åˆ°äº†å®ç®±ï¼Œå¤„ç†æ‰€æœ‰å®ç®±
            if (foundBoxes.length > 0) {
                // å°†é’¥åŒ™å’Œæ‰€æœ‰å®ç®±æ·»åŠ åˆ°é«˜äº®ç»„
                const highlightGroup = [{ row, col }]; // é’¥åŒ™ä½ç½®

                // æ·»åŠ æ‰€æœ‰å®ç®±ä½ç½®
                foundBoxes.forEach(box => {
                    highlightGroup.push({ row: box.row, col: box.col });
                });

                // æ·»åŠ åˆ°é«˜äº®ç»„
                highlightGroups.push(highlightGroup);

                // å¤„ç†ç‰¹æ•ˆå’Œå¾—åˆ†
                let totalDelCoins = 0;
                foundBoxes.forEach((box, index) => {
                    // ç´¯è®¡å®ç®±çš„é¢å¤–å¥–åŠ±
                    if (box.card.delCoins) {
                        totalDelCoins += box.card.delCoins;
                    }

                    // ä¸ºæ¯ä¸ªå®ç®±æ˜¾ç¤ºè¿æ¥çº¿
                    setTimeout(() => {
                        showUnlockEffect(keySlot, box.slot);
                    }, index * 200); // é”™å¼€ç‰¹æ•ˆæ˜¾ç¤ºæ—¶é—´
                });

                // æ˜¾ç¤ºæ€»å…±è·å¾—çš„é¢å¤–å¥–åŠ±
                if (totalDelCoins > 0) {
                    setTimeout(() => {
                        addCoins(totalDelCoins);
                        showFloatingText(keySlot, `å¼€å¯${foundBoxes.length}ä¸ªå®ç®±! +${totalDelCoins}`);
                    }, 500);
                }

                // ä»æ‰‹ç‰Œä¸­ç§»é™¤é’¥åŒ™å’Œæ‰€æœ‰å®ç®±
                setTimeout(() => {
                    // ç§»é™¤é’¥åŒ™
                    const keyIndex = handCards.findIndex(card =>
                        card.icon === currentCard.icon &&
                        card.category === currentCard.category
                    );

                    if (keyIndex !== -1) {
                        handCards.splice(keyIndex, 1);
                    }

                    // ç§»é™¤æ‰€æœ‰æ‰¾åˆ°çš„å®ç®±
                    foundBoxes.forEach(box => {
                        const boxIndex = handCards.findIndex(card =>
                            card.icon === box.card.icon &&
                            card.category === box.card.category
                        );

                        if (boxIndex !== -1) {
                            handCards.splice(boxIndex, 1);
                        }
                    });

                    console.log(`é’¥åŒ™å¼€å¯äº†${foundBoxes.length}ä¸ªå®ç®±ï¼å‰©ä½™æ‰‹ç‰Œæ•°é‡ï¼š${handCards.length}`);
                }, 1000);
            }
        }
    }

    // æ˜¾ç¤ºå¼€é”ç‰¹æ•ˆ
    function showUnlockEffect(keySlot, boxSlot) {
        if (!keySlot || !boxSlot) return;

        // åˆ›å»ºè¿æ¥çº¿ç‰¹æ•ˆ
        const line = document.createElement('div');
        line.className = 'unlock-line';
        document.body.appendChild(line);

        // è·å–ä¸¤ä¸ªå…ƒç´ çš„ä½ç½®
        const keyRect = keySlot.getBoundingClientRect();
        const boxRect = boxSlot.getBoundingClientRect();

        // è®¡ç®—çº¿çš„èµ·ç‚¹å’Œç»ˆç‚¹
        const startX = keyRect.left + keyRect.width / 2;
        const startY = keyRect.top + keyRect.height / 2;
        const endX = boxRect.left + boxRect.width / 2;
        const endY = boxRect.top + boxRect.height / 2;

        // è®¡ç®—çº¿çš„é•¿åº¦å’Œè§’åº¦
        const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
        const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;

        // è®¾ç½®çº¿çš„æ ·å¼
        line.style.width = `${length}px`;
        line.style.left = `${startX}px`;
        line.style.top = `${startY}px`;
        line.style.transform = `rotate(${angle}deg)`;

        // è®¾ç½®åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
        setTimeout(() => {
            line.remove();
        }, 1500);
    }

    // æ˜¾ç¤ºæµ®åŠ¨æ–‡æœ¬
    function showFloatingText(element, text) {
        const unlockText = document.createElement('div');
        unlockText.className = 'unlock-text';
        unlockText.textContent = text;

        const rect = element.getBoundingClientRect();
        unlockText.style.left = `${rect.left + rect.width / 2}px`;
        unlockText.style.top = `${rect.top - 20}px`;

        document.body.appendChild(unlockText);

        // è®¾ç½®åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
        setTimeout(() => {
            unlockText.remove();
        }, 1500);
    }


    // æ·»åŠ å¼€é”ç‰¹æ•ˆçš„æ ·å¼
    const unlockStyles = `
    .unlock-line {
        position: fixed;
        height: 3px;
        background: linear-gradient(90deg, gold, #ffeb3b);
        transform-origin: left;
        z-index: 100;
        animation: unlockPulse 0.8s ease-in-out;
    }

    .unlock-text {
        position: fixed;
        color: gold;
        font-weight: bold;
        font-size: 16px;
        text-shadow: 0 0 5px rgba(0,0,0,0.8);
        transform: translate(-50%, -50%);
        z-index: 101;
        animation: unlockTextFloat 1.5s ease-out;
        white-space: nowrap;
    }

    @keyframes unlockPulse {
        0% { opacity: 0; height: 1px; }
        50% { opacity: 1; height: 4px; }
        100% { opacity: 0; height: 2px; }
    }

    @keyframes unlockTextFloat {
        0% { opacity: 0; transform: translate(-50%, 0); }
        20% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; transform: translate(-50%, -30px); }
    }
    `;

    // é‡‘å¸æ± ä»£ç 
    let coinCount = 0;

    // åˆå§‹åŒ–é‡‘å¸æ± 
    function initCoinPool() {
        updateCoinDisplay();
    }

    // æ›´æ–°é‡‘å¸æ˜¾ç¤º
    function updateCoinDisplay() {
        document.getElementById('coin-count').textContent = coinCount;
    }

    // æ·»åŠ é‡‘å¸å¹¶æ˜¾ç¤ºåŠ¨ç”»
    function addCoins(amount, sourceElement) {
        // é«˜äº®é‡‘å¸æ± å›¾æ ‡
        const coinIcon = document.querySelector('.coin-icon');
        coinIcon.classList.add('coin-highlight');

        // åœ¨æŒ‡å®šæ—¶é—´åç§»é™¤é«˜äº®
        setTimeout(() => {
            coinIcon.classList.remove('coin-highlight');
        }, 1500);

        // åˆ›å»ºé£è¡Œé‡‘å¸åŠ¨ç”»
        if (sourceElement) {
            createFlyingCoin(sourceElement);
        }

        // å¢åŠ é‡‘å¸æ•°é‡
        coinCount += amount;
        updateCoinDisplay();
    }

    // åˆ›å»ºé£å‘é‡‘å¸æ± çš„é‡‘å¸åŠ¨ç”»
    function createFlyingCoin(sourceElement) {
        const coinPool = document.getElementById('coin-pool');
        const flyingCoin = document.createElement('div');
        flyingCoin.className = 'flying-coin';
        flyingCoin.textContent = 'ğŸ’°';
        document.body.appendChild(flyingCoin);

        // è·å–èµ·å§‹ä½ç½®å’Œç›®æ ‡ä½ç½®
        const sourceRect = sourceElement.getBoundingClientRect();
        const targetRect = coinPool.getBoundingClientRect();

        // è®¾ç½®é‡‘å¸åˆå§‹ä½ç½®
        flyingCoin.style.left = `${sourceRect.left + sourceRect.width/2}px`;
        flyingCoin.style.top = `${sourceRect.top + sourceRect.height/2}px`;

        // åŠ¨ç”»ç›®æ ‡ä½ç½®
        const targetX = targetRect.left + targetRect.width/2;
        const targetY = targetRect.top + targetRect.height/2;

        // ä½¿ç”¨Web Animations APIåˆ›å»ºé£è¡ŒåŠ¨ç”»
        flyingCoin.animate([
            { transform: 'translate(0, 0) scale(1)', opacity: 1 },
            { transform: `translate(${targetX - sourceRect.left - sourceRect.width/2}px,
                                ${targetY - sourceRect.top - sourceRect.height/2}px) scale(0.5)`,
                opacity: 0 }
        ], {
            duration: 800,
            easing: 'ease-out'
        }).onfinish = () => {
            flyingCoin.remove();
        };
    }

    //å›¾é‰´ä»£ç 
    // åœ¨ head çš„ style æ ‡ç­¾ä¸­æ·»åŠ ä»¥ä¸‹æ ·å¼
    // åœ¨ body çš„æœ€åˆé€‚ä½ç½®æ·»åŠ ä»¥ä¸‹æŒ‰é’®å’Œå®¹å™¨
    const codexStyles = `
    #codex-button {
        position: fixed;
        left: 20px;
        top: 20px;
        padding: 10px 20px;
        background: #4a90e2;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        z-index: 1001;
    }

    // æ·»åŠ å…³é—­æŒ‰é’®æ ·å¼
    #codex-close {
        position: absolute;
        right: 20px;
        top: 20px;
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    #codex-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }

    #codex-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 1002;
        overflow-y: auto;
        padding: 20px;
    }

    #codex-content {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
    }

    .codex-category {
        color: #4a90e2;
        font-size: 24px;
        margin-top: 30px;
        padding-bottom: 10px;
        border-bottom: 2px solid #4a90e2;
    }

    .codex-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        padding: 20px 0;
    }

    .codex-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        color: white;
        transition: transform 0.2s;
        cursor: pointer;
        position: relative;
    }

    .codex-tip {
        display: none;
        position: absolute;
        bottom: 110%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        white-space: nowrap;
        z-index: 1003;
        animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateX(-50%) translateY(10px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .codex-tip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
    }

    .codex-tabs {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
    }

    .codex-tab {
        padding: 10px 20px;
        background: rgba(74, 144, 226, 0.2);
        border: 2px solid #4a90e2;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
    }

    .codex-tab.active {
        background: #4a90e2;
    }

    .codex-content-section {
        display: none;
    }

    .codex-content-section.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    #handcards-section {
        padding: 20px;
    }

    .handcards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }
    `;

    // æ·»åŠ  HTML ç»“æ„
    const codexHTML = `
    <button id="codex-button">ğŸ“– å›¾é‰´</button>
    <div id="codex-container">
        <button id="codex-close">Ã—</button>
        <div id="codex-content"></div>
    </div>
    `;

    // ä¿®æ”¹ initCodex å‡½æ•°ï¼Œæ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬
    function initCodex() {
        // æ·»åŠ æ ·å¼
        const styleSheet = document.createElement('style');
        styleSheet.textContent = codexStyles;
        document.head.appendChild(styleSheet);

        // æ·»åŠ  HTML
        const div = document.createElement('div');
        div.innerHTML = codexHTML;
        document.body.appendChild(div.firstElementChild);
        document.body.appendChild(div.firstElementChild);

        // è·å–DOMå…ƒç´ 
        const codexButton = document.getElementById('codex-button');
        const codexContainer = document.getElementById('codex-container');
        const codexContent = document.getElementById('codex-content');
        const codexClose = document.getElementById('codex-close');

        // åˆ‡æ¢å›¾é‰´æ˜¾ç¤º
        codexButton.addEventListener('click', () => {
            codexContainer.style.display = 'block';
            if(codexContainer.style.display === 'block') {
                renderCodex();
            }
        });

        // å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        codexClose.addEventListener('click', () => {
            codexContainer.style.display = 'none';
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­å›¾é‰´
        codexContainer.addEventListener('click', (e) => {
            if(e.target === codexContainer) {
                codexContainer.style.display = 'none';
            }
        });
    }

    function renderCodex() {
        const content = document.getElementById('codex-content');
        let html = `
            <div class="codex-tabs">
                <div class="codex-tab" data-tab="full-codex">å®Œæ•´å›¾é‰´</div>
                <div class="codex-tab active" data-tab="handcards-section">æ‰‹ç‰Œåˆ—è¡¨</div>
            </div>
            <div id="full-codex" class="codex-content-section">
        `;

        // éå†æ‰€æœ‰IconCategoryåˆ†ç±»
        Object.keys(IconCategory).forEach(category => {
            const categoryCards = iconData.filter(card => card.category === IconCategory[category]);
            if(categoryCards.length > 0) {
                html += `
                    <div class="codex-category">
                        <div class="category-title">${category}</div>
                    </div>
                    <div class="codex-grid">
                `;

                categoryCards.forEach(card => {
                    const borderColor = getRarityColor(card.rarity);
                    html += `
                        <div class="codex-item" style="border: 2px solid ${borderColor}">
                            <div class="codex-icon">${card.icon}</div>
                            <div class="codex-name">${card.tip}</div>
                            <div class="codex-rarity">${card.rarity}</div>
                            <div class="codex-coins">+${card.baseCoins}ğŸ’°</div>
                            <div class="codex-tip">
                                <div>ç±»åˆ«: ${category}</div>
                                <div>ç¨€æœ‰åº¦: ${card.rarity}</div>
                                <div>åŸºç¡€é‡‘å¸: +${card.baseCoins}</div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            }
        });

        html += `
            </div>
            <div id="handcards-section" class="codex-content-section active">
                <div class="handcards-grid">
        `;

        // æ·»åŠ æ‰‹ç‰Œå†…å®¹
        handCards.forEach((card, index) => {
            const borderColor = getRarityColor(card.rarity);
            html += `
                <div class="handcard-item" style="border: 2px solid ${borderColor}">
                    <div class="handcard-icon">${card.icon}</div>
                    <div class="handcard-info">
                        <div class="handcard-name">${card.tip}</div>
                        <div class="handcard-rarity">${card.rarity}</div>
                        <div class="handcard-coins">+${card.baseCoins}ğŸ’°</div>
                    </div>
                    <div class="handcard-actions">
                        <button class="action-btn delete-btn" data-index="${index}">ğŸ—‘ï¸ åˆ é™¤</button>
                        <button class="action-btn transform-btn" data-index="${index}">ğŸ”„ å˜æ¢</button>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;

        content.innerHTML = html;

        // æ·»åŠ äº‹ä»¶ç›‘å¬
        addHandcardListeners();

        // æ·»åŠ æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
        const tabs = document.querySelectorAll('.codex-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.querySelectorAll('.codex-content-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
    }

    function addHandcardListeners() {
        // åˆ é™¤æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // æ£€æŸ¥ç§‘æŠ€èµ„æºæ˜¯å¦è¶³å¤Ÿ
                if (resources.science < 1) {
                    showResourceError('éœ€è¦ 1 ä¸ªğŸ”¬ç§‘æŠ€èµ„æºæ‰èƒ½åˆ é™¤æ‰‹ç‰Œ');
                    return;
                }

                const cardElement = btn.closest('.handcard-item');
                const cardIndex = Array.from(cardElement.parentNode.children).indexOf(cardElement);

                // æ¶ˆè€—ç§‘æŠ€èµ„æº
                resources.science--;
                updateResourceDisplay();

                // ç§»é™¤æ‰‹ç‰Œ
                handCards.splice(cardIndex, 1);

                // æ›´æ–°å›¾é‰´æ˜¾ç¤º
                renderCodex();
            });
        });

        // å˜æ¢æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.transform-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // æ£€æŸ¥ç¥ç§˜èµ„æºæ˜¯å¦è¶³å¤Ÿ
                if (resources.mystery < 1) {
                    showResourceError('éœ€è¦ 1 ä¸ªğŸ”®ç¥ç§˜èµ„æºæ‰èƒ½å˜æ¢æ‰‹ç‰Œ');
                    return;
                }

                const cardElement = btn.closest('.handcard-item');
                const cardIndex = Array.from(cardElement.parentNode.children).indexOf(cardElement);

                // æ¶ˆè€—ç¥ç§˜èµ„æº
                resources.mystery--;
                updateResourceDisplay();

                // æ›¿æ¢ä¸ºéšæœºå¡ç‰Œ
                const newCard = getRandomCard();
                handCards[cardIndex] = newCard;

                // æ›´æ–°å›¾é‰´æ˜¾ç¤º
                renderCodex();
            });
        });
    }

    // æ˜¾ç¤ºèµ„æºä¸è¶³é”™è¯¯æç¤º
    function showResourceError(message) {
        const error = document.createElement('div');
        error.className = 'resource-error';
        error.textContent = message;
        error.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 9999;
            animation: fadeInOut 2s ease-in-out;
        `;

        document.body.appendChild(error);
        setTimeout(() => error.remove(), 2000);
    }

    // è·å–éšæœºå¡ç‰Œ
    function getRandomCard() {
        const availableCards = filteredIconData.length > 0 ? filteredIconData : iconData;
        return availableCards[Math.floor(Math.random() * availableCards.length)];
    }

    // æ·»åŠ æ‰‹ç‰Œæ ·å¼
    const handcardStyles = `
    .handcard-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 15px;
        color: white;
        display: flex;
        flex-direction: column;
        gap: 10px;
        transition: transform 0.2s;
    }

    .handcard-icon {
        font-size: 32px;
        text-align: center;
    }

    .handcard-info {
        text-align: center;
    }

    .handcard-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
    }

    .action-btn {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s;
    }

    .delete-btn {
        background: #e74c3c;
        color: white;
    }

    .transform-btn {
        background: #3498db;
        color: white;
    }

    .delete-btn:hover {
        background: #c0392b;
    }

    .transform-btn:hover {
        background: #2980b9;
    }
`;

    // å°†æ‰‹ç‰Œæ ·å¼æ·»åŠ åˆ° codexStyles
    const updatedCodexStyles = codexStyles + handcardStyles;

    // è·å–åˆ†ç±»å¯¹åº”çš„å›¾æ ‡
    function getCategoryIcon(category) {
        const icons = {
            'NORMAL': 'ğŸ’«',
            'BOX_KEY': 'ğŸ—ï¸',
            'WEATHER': 'â›…',
            'BUILDING': 'ğŸ ',
            'PLANT': 'ğŸŒ±',
            'MAGIC': 'âœ¨',
            'ANIMAL': 'ğŸ¾',
            'SPECIAL': 'ğŸ¯'
        };
        return icons[category] || 'ğŸ“¦';
    }

    // é‡‘å¸å³ä¸Šè§’æ˜¾ç¤ºæç¤º
    const styles = `
        .coin-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.7);
            color: gold;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 10;
        }

        /* ä¿®æ”¹è¿™é‡Œï¼šå½“é¢æ¿æ˜¾ç¤ºæ—¶æ˜¾ç¤ºé‡‘å¸æç¤º */
        .upgrade-panel-visible .coin-indicator {
            opacity: 1;
        }

        .slot:hover .coin-indicator {
            opacity: 1;
        }

        .slot.highlight .coin-indicator {
            background: rgba(0, 0, 0, 0.8);
        }
    `;

    const styleSheet = document.createElement('style');
    styleSheet.textContent = styles;
    document.head.appendChild(styleSheet);
    //æŒ‘æˆ˜ç›®æ ‡
    // åœ¨ coin-pool div ä¸‹æ–¹æ·»åŠ æŒ‘æˆ˜ç›®æ ‡æ˜¾ç¤ºåŒºåŸŸ
    const challengeHTML = `
    <div id="challenge-container">
        <div class="challenge-header">
            <span>ğŸ“‹ ç§Ÿé‡‘æŒ‘æˆ˜</span>
            <span id="remaining-slots">å‰©ä½™æ¬¡æ•°: 5</span>
        </div>
        <div id="challenge-list"></div>
    </div>
    `;

    // æ·»åŠ æ ·å¼
    const challengeStyles = `
        #challenge-container {
            position: fixed;
            right: 20px;
            top: 80px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            color: white;
            width: 280px;
            z-index: 100;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .challenge-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            transition: all 0.3s;
        }

        .challenge-item.active {
            background: rgba(74, 144, 226, 0.2);
            border: 1px solid #4a90e2;
        }

        .challenge-item.completed {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid #27ae60;
        }

        .challenge-item.failed {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
        }
    `;

    // æŒ‘æˆ˜åˆ—è¡¨æ•°æ®
    const challenges = [
        {
            slots: 9,
            coins: 240,
            completed: false,
            commonChance: 90,   // 70% è·å¾—"ä¼˜ç§€"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
            rareChance: 8,    // 25% è·å¾—"ç²¾è‰¯"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
            epicChance: 2,    // 5% è·å¾—"å²è¯—"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
            legendaryChance: 0   // 0% è·å¾—"ä¼ è¯´"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
        },
        {
            slots: 13,
            coins: 500,
            completed: false,
            commonChance: 80,   // 50% è·å¾—"ä¼˜ç§€"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
            rareChance: 15,    // 35% è·å¾—"ç²¾è‰¯"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
            epicChance: 5,    // 13% è·å¾—"å²è¯—"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
            legendaryChance: 0 // 2% è·å¾—"ä¼ è¯´"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
        },
        {
            slots: 15,
            coins: 1200,
            completed: false,
            commonChance: 65,   // 30% è·å¾—"ä¼˜ç§€"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
            rareChance: 20,     // 40% è·å¾—"ç²¾è‰¯"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
            epicChance: 12,     // 20% è·å¾—"å²è¯—"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
            legendaryChance: 3  // 10% è·å¾—"ä¼ è¯´"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
        },
        {
            slots: 16,
            coins: 1400,
            completed: false,
            commonChance: 30,
            rareChance: 40,     // 40% è·å¾—"ç²¾è‰¯"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
            epicChance: 20,     // 20% è·å¾—"å²è¯—"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
            legendaryChance: 10  // 10% è·å¾—"ä¼ è¯´"å“è´¨å¥–åŠ±çš„æ¦‚ç‡
        },
    ];

    let currentChallenge = 0;
    let remainingSlots = challenges[0].slots;
    let totalSlots = 0;

    // åˆå§‹åŒ–æŒ‘æˆ˜ç³»ç»Ÿ
    function initChallengeSystem() {
        // æ·»åŠ  HTML å’Œæ ·å¼
        document.body.insertAdjacentHTML('beforeend', challengeHTML);
        const styleSheet = document.createElement('style');
        styleSheet.textContent = challengeStyles;
        document.head.appendChild(styleSheet);

        // æ¸²æŸ“æŒ‘æˆ˜åˆ—è¡¨
        renderChallenges();
        updateRemainingSlots();
    }

    // æ¸²æŸ“æŒ‘æˆ˜åˆ—è¡¨
    function renderChallenges() {
        const list = document.getElementById('challenge-list');
        list.innerHTML = challenges.map((challenge, index) => `
        <div class="challenge-item ${index === currentChallenge ? 'active' : ''}
                                  ${challenge.completed ? 'completed' : ''}">
            <span>ğŸ¯ ${challenge.slots}æ¬¡æŠ½å–</span>
            <span>ğŸ’° ${challenge.coins}é‡‘å¸</span>
        </div>
    `).join('');
    }

    // æ›´æ–°å‰©ä½™æ¬¡æ•°æ˜¾ç¤º
    function updateRemainingSlots() {
        document.getElementById('remaining-slots').textContent =
            `å‰©ä½™æ¬¡æ•°: ${remainingSlots}`;
    }


    // æ£€æŸ¥æŒ‘æˆ˜ç»“æœ
    function checkChallengeResult() {
        const currentTarget = challenges[currentChallenge];

        if (coinCount >= currentTarget.coins) {
            // å®ŒæˆæŒ‘æˆ˜
            coinCount -= currentTarget.coins;
            updateCoinDisplay();
            currentTarget.completed = true;
            showChallengeComplete();

            // è¿›å…¥ä¸‹ä¸€ä¸ªæŒ‘æˆ˜
            if (currentChallenge < challenges.length - 1) {
                currentChallenge++;
                remainingSlots = challenges[currentChallenge].slots;
                renderChallenges();
                updateRemainingSlots();
            } else {
                showGameComplete();
            }
        } else {
            showGameOver();
        }
    }

    // æ˜¾ç¤ºæŒ‘æˆ˜å®Œæˆæ¶ˆæ¯
    function showChallengeComplete() {
        const message = document.createElement('div');
        message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(39, 174, 96, 0.9);
        padding: 20px;
        border-radius: 10px;
        color: white;
        font-size: 24px;
        z-index: 1000;
    `;
        message.textContent = 'ğŸ‰ æˆåŠŸæ”¯ä»˜ç§Ÿé‡‘ï¼è¿›å…¥ä¸‹ä¸€é˜¶æ®µ';
        document.body.appendChild(message);
        setTimeout(() => message.remove(), 2000);
    }

    // æ˜¾ç¤ºæ¸¸æˆç»“æŸæ¶ˆæ¯
    function showGameOver() {
        const message = document.createElement('div');
        message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(231, 76, 60, 0.9);
        padding: 20px;
        border-radius: 10px;
        color: white;
        font-size: 24px;
        z-index: 1000;
    `;
        message.textContent = 'ğŸ˜¢ ç§Ÿé‡‘ä¸è¶³ï¼Œä½ è¢«èµ¶äº†å‡ºå»ï¼Œèœï¼';
        document.body.appendChild(message);
        disableControls();
    }

    // æ˜¾ç¤ºé€šå…³åŠ¨ç”»
    function showGameComplete() {
        const container = document.createElement('div');
        container.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 1000;
    `;

        container.innerHTML = `
        <h1 style="color: gold; font-size: 48px; margin-bottom: 20px;">
            ğŸŠ æ­å–œé€šå…³ï¼ ğŸŠ
        </h1>
        <p style="color: white; font-size: 24px;">
            ä½ å·²ç»æˆä¸ºäº†ä¸€ä¸ªæˆåŠŸçš„æˆ¿ä¸œï¼
        </p>
    `;

        document.body.appendChild(container);
        disableControls();
    }

    // æ·»åŠ æˆé•¿ç‰¹æ•ˆçš„æ ·å¼
    const growthStyles = `
    .growth-line {
        position: fixed;
        height: 3px;
        background: linear-gradient(90deg, #4CAF50, #8BC34A);
        transform-origin: left;
        z-index: 100;
        animation: growthPulse 0.8s ease-in-out;
    }

    .growth-text {
        position: fixed;
        color: #4CAF50;
        font-weight: bold;
        font-size: 16px;
        text-shadow: 0 0 5px rgba(0,0,0,0.8);
        transform: translate(-50%, -50%);
        z-index: 101;
        animation: growthTextFloat 1.5s ease-out;
        white-space: nowrap;
    }

    .grow-animation {
        animation: growPlant 0.8s ease-out;
    }

    @keyframes growthPulse {
        0% { opacity: 0; height: 1px; }
        50% { opacity: 1; height: 4px; }
        100% { opacity: 0; height: 2px; }
    }

    @keyframes growthTextFloat {
        0% { opacity: 0; transform: translate(-50%, 0); }
        20% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; transform: translate(-50%, -30px); }
    }

    @keyframes growPlant {
        0% { transform: scale(0.5); opacity: 0.3; }
        70% { transform: scale(1.2); }
        100% { transform: scale(1); opacity: 1; }
    }
    `;

    // ç¦ç”¨æ¸¸æˆæ§åˆ¶
    function disableControls() {
        document.getElementById('start-button').disabled = true;
        document.getElementById('show-upgrade-button').disabled = true;
    }

    // æ¸¸æˆåˆå§‹åŒ–æ—¶è°ƒç”¨
    document.addEventListener('DOMContentLoaded', () => {
        // æ·»åŠ å¼€é”ç‰¹æ•ˆæ ·å¼
        const styleSheet = document.createElement('style');
        styleSheet.textContent = unlockStyles;
        document.head.appendChild(styleSheet);

        // æ·»åŠ æˆé•¿ç‰¹æ•ˆæ ·å¼
        const growthStyleSheet = document.createElement('style');
        growthStyleSheet.textContent = growthStyles;
        document.head.appendChild(growthStyleSheet);

        // æ·»åŠ ç ´åæ•ˆæœæ ·å¼
        document.head.appendChild(effectStyles);
        // æ·»åŠ éŸ³ç¬¦ç ´åæ•ˆæœæ ·å¼
        const musicStyles = document.createElement('style');
        musicStyles.textContent = musicDestructionStyles;
        document.head.appendChild(musicStyles);
        // æ·»åŠ çŒ«é¼ äº’åŠ¨æ ·å¼
        const catSheet = document.createElement('style');
        catSheet.textContent = catMouseStyles;
        document.head.appendChild(catSheet);

        // æ·»åŠ å»ºç­‘å›ºå®šæ ·å¼
        const buildSheet = document.createElement('style');
        buildSheet.textContent = buildingStyles;
        document.head.appendChild(buildSheet);

        // æ·»åŠ å»ºç­‘å›ºå®šæ ·å¼
        const musicSheet = document.createElement('style');
        musicSheet.textContent = musicStyles;
        document.head.appendChild(musicSheet);

        initCoinPool();
        initChallengeSystem();
        initCodex();
        initShop();
        initResourcePanel();

        // åœ¨æ‰€æœ‰åˆå§‹åŒ–å®Œæˆåæ˜¾ç¤ºèŒä¸šé€‰æ‹©é¢æ¿
        initProfessionSelection();

        // ç¦ç”¨å¼€å§‹æŒ‰é’®ï¼Œç›´åˆ°é€‰æ‹©å®ŒèŒä¸š
        document.getElementById('start-button').disabled = true;

        // è®¾ç½®åˆå§‹çŠ¶æ€
        hasSelectedUpgrade = true;
    });

    // èµ„æºç³»ç»Ÿ
    const resources = {
        material: 5,  // ææ–™
        mystic: 1,    // ç¥ç§˜
        tech: 1       // ç§‘ç ”
    };

    // äº¤æ˜“ä»·æ ¼é…ç½®
    const tradePrices = {
        buy: {
            material: 10, // 10é‡‘å¸ä¹°1ææ–™
            mystic: 10,   // 10é‡‘å¸ä¹°1ç¥ç§˜
            tech: 10      // 10é‡‘å¸ä¹°1ç§‘ç ”
        },
        sell: {
            material: 3,  // 1ææ–™å–3é‡‘å¸
            mystic: 3,    // 1ç¥ç§˜å–3é‡‘å¸
            tech: 3       // 1ç§‘ç ”å–3é‡‘å¸
        }
    };

    // 3. æ›´æ–°èµ„æºæ˜¾ç¤º
    function updateResourceDisplay() {
        document.getElementById('material-count').textContent = resources.material;
        document.getElementById('mystery-count').textContent = resources.mystery;
        document.getElementById('science-count').textContent = resources.science;
    }

    // 4. æ·»åŠ èµ„æºå¹¶æ˜¾ç¤ºåŠ¨ç”»
    function addResource(type, amount, sourceElement) {
        if (!type || amount <= 0) return;

        // æ›´æ–°èµ„æºæ•°é‡
        resources[type] += amount;

        // æ›´æ–°æ˜¾ç¤º
        updateResourceDisplay();

        // é«˜äº®èµ„æºå›¾æ ‡
        const resourceElement = document.querySelector(`.resource[data-type="${type}"]`);
        if (resourceElement) {
            resourceElement.classList.add('resource-highlight');
            setTimeout(() => {
                resourceElement.classList.remove('resource-highlight');
            }, 500);
        }

        // æ˜¾ç¤ºèµ„æºè·å–ç‰¹æ•ˆ
        if (sourceElement) {
            showResourceProduction(sourceElement, type);
            createFlyingResource(type, amount, sourceElement);
        }
    }

    // 5. æ˜¾ç¤ºèµ„æºç”Ÿäº§ç‰¹æ•ˆ
    function showResourceProduction(sourceElement, resourceType) {
        if (!sourceElement) return;

        const resourceText = document.createElement('div');
        resourceText.className = 'resource-text';

        // æ ¹æ®èµ„æºç±»å‹è®¾ç½®æ–‡æœ¬
        let emoji = '';
        let text = '';

        switch (resourceType) {
            case 'material':
                emoji = 'ğŸ§±';
                text = 'ææ–™';
                break;
            case 'mystery':
                emoji = 'âœ¨';
                text = 'ç¥ç§˜';
                break;
            case 'science':
                emoji = 'ğŸ”¬';
                text = 'ç§‘æŠ€';
                break;
        }

        resourceText.textContent = `${emoji} ${text}`;

        const rect = sourceElement.getBoundingClientRect();
        resourceText.style.left = `${rect.left + rect.width / 2}px`;
        resourceText.style.top = `${rect.top - 20}px`;

        document.body.appendChild(resourceText);

        // è®¾ç½®åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
        setTimeout(() => {
            resourceText.remove();
        }, 1500);
    }

    // 6. åˆ›å»ºé£å‘èµ„æºæ± çš„èµ„æºåŠ¨ç”»
    function createFlyingResource(type, amount, sourceElement) {
        if (!sourceElement) return;

        // è·å–èµ„æºå›¾æ ‡
        let emoji = '';
        switch (type) {
            case 'material': emoji = 'ğŸ§±'; break;
            case 'mystery': emoji = 'âœ¨'; break;
            case 'science': emoji = 'ğŸ”¬'; break;
        }

        // åˆ›å»ºé£è¡Œèµ„æºå…ƒç´ 
        const flyingResource = document.createElement('div');
        flyingResource.className = 'flying-resource';
        flyingResource.textContent = `${emoji}+${amount}`;

        // è·å–èµ·ç‚¹ä½ç½®ï¼ˆå¡ç‰Œä¸­å¿ƒï¼‰
        const sourceRect = sourceElement.getBoundingClientRect();
        const startX = sourceRect.left + sourceRect.width / 2;
        const startY = sourceRect.top + sourceRect.height / 2;

        // è·å–ç›®æ ‡ä½ç½®ï¼ˆèµ„æºæ± ä¸­å¯¹åº”èµ„æºçš„ä½ç½®ï¼‰
        const targetElement = document.querySelector(`.resource[data-type="${type}"]`);
        const targetRect = targetElement ? targetElement.getBoundingClientRect() :
            document.getElementById('resource-pool').getBoundingClientRect();
        const endX = targetRect.left + targetRect.width / 2;
        const endY = targetRect.top + targetRect.height / 2;

        // è®¾ç½®åˆå§‹ä½ç½®
        flyingResource.style.left = `${startX}px`;
        flyingResource.style.top = `${startY}px`;

        document.body.appendChild(flyingResource);

        // åŠ¨ç”»é£å‘ç›®æ ‡
        const startTime = performance.now();
        const duration = 800; // æ¯«ç§’

        function animate(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°ä½¿åŠ¨ç”»æ›´è‡ªç„¶
            const easeProgress = 1 - Math.pow(1 - progress, 3);

            // è®¡ç®—å½“å‰ä½ç½®ï¼ˆæŠ›ç‰©çº¿è½¨è¿¹ï¼‰
            const currentX = startX + (endX - startX) * easeProgress;
            const currentY = startY + (endY - startY) * easeProgress - Math.sin(easeProgress * Math.PI) * 50;

            flyingResource.style.left = `${currentX}px`;
            flyingResource.style.top = `${currentY}px`;
            flyingResource.style.opacity = 1 - Math.pow(progress, 2);

            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                flyingResource.remove();
            }
        }

        requestAnimationFrame(animate);
    }

    function processProduction(card, slot) {
        if (!card || !card.tip) return;

        // ä»æç¤ºæ–‡æœ¬ä¸­è§£æç”Ÿäº§æ•ˆæœ
        const tip = card.tip || "";

        // 1. å¤„ç†ç ´åæ•ˆæœ - æœ€é«˜ä¼˜å…ˆçº§
        if (tip.includes("ç ´å")) {
            // è·å–å‘¨å›´å…«ä¸ªæ–¹å‘çš„å…ƒç´ 
            const slotPos = slot.dataset;
            const currentRow = parseInt(slotPos.row);
            const currentCol = parseInt(slotPos.col);

            // è·å–å‘¨å›´æ‰€æœ‰æ ¼å­
            const surroundingSlots = [];
            for (let r = Math.max(0, currentRow - 1); r <= Math.min(rows - 1, currentRow + 1); r++) {
                for (let c = Math.max(0, currentCol - 1); c <= Math.min(columns.length - 1, currentCol + 1); c++) {
                    if (r === currentRow && c === currentCol) continue; // è·³è¿‡è‡ªèº«

                    const neighborSlot = document.querySelector(`.slot[data-row="${r}"][data-col="${c}"]`);
                    if (neighborSlot && neighborSlot.__card) {
                        surroundingSlots.push({slot: neighborSlot, row: r, col: c});
                    }
                }
            }

            // å¦‚æœæœ‰å‘¨å›´å…ƒç´ ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªç§»é™¤
            if (surroundingSlots.length > 0) {
                const randomIndex = Math.floor(Math.random() * surroundingSlots.length);
                const targetSlot = surroundingSlots[randomIndex];

                // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœç›®æ ‡æ˜¯å®ç®±ï¼Œè§¦å‘å¼€ç®±æ•ˆæœ
                if (targetSlot.slot.__card && targetSlot.slot.__card.category === IconCategory.Box) {
                    // å…ˆæ˜¾ç¤ºç ´åæ•ˆæœ
                    showDestructionEffect(slot, targetSlot.slot);

                    // ç„¶åè§¦å‘å¼€ç®±æ•ˆæœ
                    setTimeout(() => {
                        const boxCard = targetSlot.slot.__card;
                        const boxCoins = boxCard.delCoins || 0;
                        if (boxCoins > 0) {
                            addCoins(boxCoins, targetSlot.slot);
                            showFloatingText(targetSlot.slot, `+${boxCoins} ğŸ’°`);
                        }

                        // æ¸…ç©ºæ ¼å­
                        clearSlot(targetSlot.row, targetSlot.col);
                    }, 500);
                } else {
                    // å¯¹éå®ç®±å…ƒç´ ï¼Œç›´æ¥æ˜¾ç¤ºç ´åæ•ˆæœå¹¶æ¸…ç©º
                    showDestructionEffect(slot, targetSlot.slot);
                    setTimeout(() => {
                        clearSlot(targetSlot.row, targetSlot.col);
                    }, 500);
                }
            }
        }

        // 2. å¤„ç†æ¦‚ç‡æ·»åŠ å…ƒç´ 
        const probabilityMatch = tip.match(/(\d+)%æ¦‚ç‡æ·»åŠ /);
        if (probabilityMatch) {
            const probability = parseInt(probabilityMatch[1]);
            const elementToAdd = card.make || "";
            // æ£€æŸ¥æ˜¯å¦è§¦å‘æ¦‚ç‡
            if (Math.random() * 100 < probability) {
                console.log(card,"æˆåŠŸè§¦å‘æ¦‚ç‡æ·»åŠ ",probability,elementToAdd);
                // ä»iconDataä¸­æŸ¥æ‰¾åŒ¹é…çš„å…ƒç´ 
                const matchingCards = iconData.filter(card =>
                    card.icon === elementToAdd
                );

                if (matchingCards.length > 0) {
                    // éšæœºé€‰æ‹©ä¸€ä¸ªåŒ¹é…çš„å¡ç‰Œ
                    const cardToAdd = matchingCards[Math.floor(Math.random() * matchingCards.length)];

                    // æ·»åŠ åˆ°æ‰‹ç‰Œ
                    handCards.push(cardToAdd);

                    // æ˜¾ç¤ºæ·»åŠ æ•ˆæœ
                    showCardAddedEffect(slot, cardToAdd);
                }
            }
        }

        // ç‰¹å®šæç¤ºæ–‡æœ¬è§¦å‘ç‰¹å®šèµ„æºç”Ÿäº§
        if (tip.includes("ç”Ÿäº§ææ–™") && Math.random() < 0.2) {
            // ä»tipä¸­æå–æ•°å­—ä½œä¸ºèµ„æºæ•°é‡ï¼Œå¦‚æœæ²¡æœ‰æ•°å­—åˆ™é»˜è®¤ä¸º1
            const numberMatch = tip.match(/\d+/);
            const amount = numberMatch ? parseInt(numberMatch[0]) : 1;
            addResource('material', amount, slot);
        }

        if (tip.includes("ç”Ÿäº§ç¥ç§˜") && Math.random() < 0.2) {
            // ä»tipä¸­æå–æ•°å­—ä½œä¸ºèµ„æºæ•°é‡ï¼Œå¦‚æœæ²¡æœ‰æ•°å­—åˆ™é»˜è®¤ä¸º1
            const numberMatch = tip.match(/\d+/);
            const amount = numberMatch ? parseInt(numberMatch[0]) : 1;
            addResource('mystery', amount, slot);
        }

        if (tip.includes("ç”Ÿäº§ç§‘æŠ€") && Math.random() < 0.2) {
            // ä»tipä¸­æå–æ•°å­—ä½œä¸ºèµ„æºæ•°é‡ï¼Œå¦‚æœæ²¡æœ‰æ•°å­—åˆ™é»˜è®¤ä¸º1
            const numberMatch = tip.match(/\d+/);
            const amount = numberMatch ? parseInt(numberMatch[0]) : 1;
            addResource('science', amount, slot);
        }
    }

    // æ¸…ç©ºæŒ‡å®šæ ¼å­
    function clearSlot(row, col) {
        const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
        if (slot) {
            // ä¿å­˜åŸæ¥çš„å¡ç‰Œå¼•ç”¨ï¼ˆç”¨äºä»æ‰‹ç‰Œä¸­ç§»é™¤ï¼‰
            const card = slot.__card;

            // æ¸…ç©ºæ ¼å­å†…å®¹å’Œå¼•ç”¨
            slot.innerHTML = '';
            slot.removeAttribute('data-tooltip');
            slot.__card = null;

            // å¦‚æœå¡ç‰Œåœ¨æ‰‹ç‰Œä¸­ï¼Œç§»é™¤å®ƒ
            if (card) {
                removeCardFromHand(card);
            }
        }
    }

    // æ˜¾ç¤ºç ´åæ•ˆæœ
    function showDestructionEffect(sourceSlot, targetSlot) {
        // åˆ›å»ºç ´åæ•ˆæœå®¹å™¨
        const effectContainer = document.createElement('div');
        effectContainer.className = 'destruction-effect';
        document.body.appendChild(effectContainer);

        // è·å–ä¸¤ä¸ªå…ƒç´ çš„ä½ç½®
        const sourceRect = sourceSlot.getBoundingClientRect();
        const targetRect = targetSlot.getBoundingClientRect();

        // è®¾ç½®ç ´åçº¿
        const line = document.createElement('div');
        line.className = 'destruction-line';

        // è®¡ç®—çº¿çš„ä½ç½®å’Œè§’åº¦
        const sourceX = sourceRect.left + sourceRect.width / 2;
        const sourceY = sourceRect.top + sourceRect.height / 2;
        const targetX = targetRect.left + targetRect.width / 2;
        const targetY = targetRect.top + targetRect.height / 2;

        const length = Math.sqrt(Math.pow(targetX - sourceX, 2) + Math.pow(targetY - sourceY, 2));
        const angle = Math.atan2(targetY - sourceY, targetX - sourceX) * 180 / Math.PI;

        line.style.width = `${length}px`;
        line.style.left = `${sourceX}px`;
        line.style.top = `${sourceY}px`;
        line.style.transform = `rotate(${angle}deg)`;

        effectContainer.appendChild(line);

        // åˆ›å»ºç ´åæ–‡æœ¬
        const text = document.createElement('div');
        text.className = 'destruction-text';
        text.textContent = 'ğŸ’¥ ç ´å!';
        text.style.left = `${targetX}px`;
        text.style.top = `${targetY - 20}px`;

        effectContainer.appendChild(text);

        // æ·»åŠ åŠ¨ç”»åç§»é™¤æ•ˆæœ
        setTimeout(() => {
            effectContainer.remove();
        }, 1000);
    }

    // æ˜¾ç¤ºå¡ç‰Œæ·»åŠ æ•ˆæœ
    function showCardAddedEffect(slot, card) {
        // åˆ›å»ºæ•ˆæœæ–‡æœ¬
        const text = document.createElement('div');
        text.className = 'card-added-text';
        text.innerHTML = `${card.icon} æ·»åŠ åˆ°æ‰‹ç‰Œ!`;

        const rect = slot.getBoundingClientRect();
        text.style.left = `${rect.left + rect.width / 2}px`;
        text.style.top = `${rect.top - 20}px`;

        document.body.appendChild(text);

        // è®¾ç½®åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
        setTimeout(() => {
            text.remove();
        }, 1500);
    }

    const effectStyles = document.createElement('style');
    effectStyles.textContent = `
        .destruction-line {
            position: fixed;
            height: 3px;
            background: linear-gradient(to right, transparent, #ff4500, transparent);
            transform-origin: left center;
            z-index: 1000;
            animation: destructionPulse 0.5s ease-out;
        }

        .destruction-text {
            position: fixed;
            color: #ff4500;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
            transform: translate(-50%, -50%);
            z-index: 1001;
            animation: destructionTextFloat 1s ease-out;
            white-space: nowrap;
        }

        .card-added-text {
            position: fixed;
            color: #4CAF50;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
            transform: translate(-50%, -50%);
            z-index: 1001;
            animation: cardAddedFloat 1.5s ease-out;
            white-space: nowrap;
        }

        @keyframes destructionPulse {
            0% { opacity: 0; transform: scaleX(0.2) rotate(var(--angle)); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: scaleX(1.2) rotate(var(--angle)); }
        }

        @keyframes destructionTextFloat {
            0% { opacity: 0; transform: translate(-50%, 0); }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -30px); }
        }

        @keyframes cardAddedFloat {
            0% { opacity: 0; transform: translate(-50%, 0); }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -30px); }
        }
    `;

    // æ·»åŠ å…¨å±€è®¡æ•°å™¨ï¼Œè®°å½•å¾…è§¦å‘çš„é«˜ç¨€æœ‰åº¦é€‰æ‹©æ¬¡æ•°
    window.pendingRareUpgrades = 0;

    function checkFestivalInteraction(grid, row, col, highlightGroups) {
        const currentCard = grid[row][col];

        if (!currentCard || currentCard.category !== IconCategory.FESTIVAL) return false;

        // è·å–å‘¨å›´çš„èŠ‚æ—¥å…ƒç´ 
        const festivalNeighbors = [];
        const visited = new Set();
        visited.add(`${row},${col}`);
        const directions = [
            [-1, -1], [-1, 0], [-1, 1],
            [0, -1],           [0, 1],
            [1, -1],  [1, 0],  [1, 1]
        ];

        // æ£€æŸ¥é‚»å±…
        for (const [dx, dy] of directions) {
            const newRow = row + dx;
            const newCol = col + dy;

            if (newRow >= 0 && newRow < 5 && newCol >= 0 && newCol < 5) {
                const neighbor = grid[newRow][newCol];
                const key = `${newRow},${newCol}`;

                if (neighbor &&
                    neighbor.category === IconCategory.FESTIVAL &&
                    !visited.has(key)) {
                    festivalNeighbors.push({
                        row: newRow,
                        col: newCol,
                        card: neighbor,
                        element: document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`)
                    });
                    visited.add(key);
                }
            }
        }

        // å¦‚æœå‘¨å›´æœ‰2ä¸ªæˆ–ä»¥ä¸ŠèŠ‚æ—¥å…ƒç´ 
        if (festivalNeighbors.length >= 2) {
            const currentElement = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
            const elementsToRemove = [
                { element: currentElement, card: currentCard, row, col },
                ...festivalNeighbors.map(n => ({
                    element: n.element,
                    card: n.card,
                    row: n.row,
                    col: n.col
                }))
            ];

            // æ˜¾ç¤ºåº†å…¸æ¶ˆé™¤ç‰¹æ•ˆ
            showFestivalEffect(elementsToRemove);

            // ç§»é™¤æ‰‹ç‰Œä¸­å¯¹åº”çš„å¡ç‰Œå’Œæ ¼å­ä¸­çš„å…ƒç´ 
            elementsToRemove.forEach(({element, card}) => {
                // ä»æ‰‹ç‰Œç§»é™¤
                const cardIndex = handCards.findIndex(handCard =>
                    handCard.icon === card.icon && !handCard.used);
                if (cardIndex !== -1) {
                    handCards[cardIndex].used = true;
                }

                // æ¸…é™¤æ ¼å­
                element.innerHTML = '';
                element.removeAttribute('data-tooltip');
                element.__card = null;
            });

            // æ›´æ–°æ‰‹ç‰Œæ˜¾ç¤º
            updateHandCards();

            // å¢åŠ é«˜ç¨€æœ‰åº¦é€‰æ‹©æœºä¼š
            window.pendingRareUpgrades++;

            return true;
        }

        return false;
    }

    // æ·»åŠ åº†å…¸æ¶ˆé™¤ç‰¹æ•ˆå‡½æ•°
    function showFestivalEffect(elements) {
        // åˆ›å»ºç‰¹æ•ˆå®¹å™¨
        const effectContainer = document.createElement('div');
        effectContainer.className = 'festival-effect-container';
        document.body.appendChild(effectContainer);
        // ä¸ºæ¯ä¸ªå…ƒç´ åˆ›å»ºæ¶ˆé™¤ç‰¹æ•ˆ
        elements.forEach(({element, row, col}) => {
            // åˆ›å»ºçƒŸèŠ±ç‰¹æ•ˆ
            const firework = document.createElement('div');
            firework.className = 'festival-firework';

            // è·å–å…ƒç´ ä½ç½®
            const rect = element.getBoundingClientRect();

            // è®¾ç½®çƒŸèŠ±ä½ç½®
            firework.style.left = `${rect.left + rect.width/2}px`;
            firework.style.top = `${rect.top + rect.height/2}px`;

            effectContainer.appendChild(firework);

            // æ·»åŠ åº†å…¸æ–‡å­—
            const text = document.createElement('div');
            text.className = 'festival-text';
            text.textContent = 'âœ¨ ä¸‰è¿å¥‡è¿¹!';
            text.style.left = `${rect.left + rect.width/2}px`;
            text.style.top = `${rect.top - 20}px`;
            effectContainer.appendChild(text);
        });

        // æ·»åŠ ç‰¹æ•ˆæ ·å¼
        const style = document.createElement('style');
        style.textContent = `
        .festival-effect-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .festival-firework {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: radial-gradient(circle, #ffeb3b, #ff9800);
            transform: translate(-50%, -50%);
            animation: festivalExplosion 0.8s ease-out forwards;
        }

        .festival-text {
            position: absolute;
            color: #ff9800;
            font-weight: bold;
            font-size: 20px;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
            transform: translate(-50%, -50%);
            animation: festivalTextFloat 1s ease-out forwards;
        }

        @keyframes festivalExplosion {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(20);
                opacity: 0;
            }
        }

        @keyframes festivalTextFloat {
            0% {
                transform: translate(-50%, 0);
                opacity: 0;
            }
            20% {
                opacity: 1;
            }
            80% {
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -30px);
                opacity: 0;
            }
        }
    `;
        document.head.appendChild(style);

        // æ¸…ç†ç‰¹æ•ˆ
        setTimeout(() => {
            effectContainer.remove();
            style.remove();
        }, 1000);
    }

    function checkGemRespawn(grid, row, col, card) {
        if (!card || !grid) return false;

        // åˆ¤æ–­æ˜¯å¦æ˜¯å®çŸ³ç±»å…ƒç´ 
        const isGem = card.category === IconCategory.GEM;

        // åˆ¤æ–­æ˜¯å¦åœ¨æ—¶ç©ºå…ƒç´ æ—è¾¹
        const isNearTimeWarp = checkNearTimeWarp(grid, row, col);

        // å¦‚æœä¸æ˜¯å®çŸ³æˆ–ä¸åœ¨æ—¶ç©ºå…ƒç´ æ—ï¼Œç›´æ¥è¿”å›
        if (!isGem || !isNearTimeWarp) return false;

        // è·å–å½“å‰æ ¼å­
        const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
        if (!slot) return false;

        // å¤„ç†æ—¶ç©ºå€’æµæ•ˆæœ
        // å…ˆè§¦å‘é‡‘å¸æ•ˆæœ
        addCoins(card.baseCoins, slot);

        // å‡çº§å®çŸ³ç¨€æœ‰åº¦
        const upgradedGem = getHigherRarityGem(card);
        if (upgradedGem) {
            // ä»æ‰‹ç‰Œä¸­ç§»é™¤æ—§å®çŸ³
            removeCardFromHand(card);

            // ç”Ÿæˆæ–°å®çŸ³
            spawnNewCard(row, col, upgradedGem);

            // è§¦å‘æ–°å®çŸ³çš„é‡‘å¸å’Œç”Ÿäº§æ•ˆæœ
            addCoins(upgradedGem.baseCoins, slot);
            processProduction(upgradedGem, slot);

            // å°†æ–°å®çŸ³æ·»åŠ åˆ°æ‰‹ç‰Œ
            handCards.push(upgradedGem);

            return true;
        }

        return false;
    }

    function checkNearTimeWarp(grid, row, col) {
        const directions = [
            [-1, -1], [-1, 0], [-1, 1],
            [0, -1],           [0, 1],
            [1, -1],  [1, 0],  [1, 1]
        ];

        for (const [dx, dy] of directions) {
            const newRow = row + dx;
            const newCol = col + dy;

            if (newRow >= 0 && newRow < rows && newCol >= 0 && newCol < 5) {
                const nearCard = grid[newRow][newCol];
                if (nearCard && nearCard.icon === 'ğŸŒ€') {
                    return true;
                }
            }
        }
        return false;
    }

    // è¾…åŠ©å‡½æ•°ï¼šè·å–æ›´é«˜ç¨€æœ‰åº¦çš„å®çŸ³
    function getHigherRarityGem(currentGem) {
        const rarityOrder = [Rarity.COMMON, Rarity.RARE, Rarity.EPIC, Rarity.LEGENDARY];
        const currentIndex = rarityOrder.indexOf(currentGem.rarity);

        if (currentIndex < rarityOrder.length - 1) {
            const targetRarity = rarityOrder[currentIndex + 1];
            const availableGems = iconData.filter(card =>
                card.category === IconCategory.GEM && card.rarity === targetRarity
            );

            if (availableGems.length > 0) {
                return availableGems[Math.floor(Math.random() * availableGems.length)];
            }
        }
        return null;
    }

    // è¾…åŠ©å‡½æ•°ï¼šè·å–éšæœºå®çŸ³
    function getRandomGemByCategory() {
        const gems = iconData.filter(card => card.category === IconCategory.GEM);
        return gems.length > 0 ? gems[Math.floor(Math.random() * gems.length)] : null;
    }

    function spawnNewCard(row, col, card) {
        // è·å–å¯¹åº”æ ¼å­
        const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
        if (!slot) return;

        // æ¸…ç©ºåŸæœ‰å†…å®¹
        slot.innerHTML = '';
        slot.removeAttribute('data-tooltip');
        slot.__card = null;

        // åˆ›å»ºæ–°å¡ç‰Œå†…å®¹
        slot.innerHTML = `
            <div class="card-icon">${card.icon}</div>
            <div class="coin-indicator">+${card.baseCoins}ğŸ’°</div>
        `;

        // è®¾ç½®æç¤ºæ–‡æœ¬
        slot.setAttribute('data-tooltip', card.tip);

        // ä¿å­˜å¡ç‰Œæ•°æ®å¼•ç”¨
        slot.__card = card;

        // æ·»åŠ ç”ŸæˆåŠ¨ç”»
        slot.classList.add('spawn-animation');
        setTimeout(() => {
            slot.classList.remove('spawn-animation');
        }, 500);

        // æ›´æ–°ç½‘æ ¼æ•°æ®
        const grid = getGrid();
        grid[row][col] = card;
    }

    function getGrid() {
        const grid = [];

        // éå†æ‰€æœ‰è¡Œ
        for (let row = 0; row < rows; row++) {
            grid[row] = [];

            // éå†æ¯è¡Œçš„æ‰€æœ‰åˆ—
            for (let col = 0; col < 5; col++) {
                // è·å–å¯¹åº”æ ¼å­
                const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);

                // å¦‚æœæ ¼å­å­˜åœ¨ä¸”æœ‰å¡ç‰Œæ•°æ®ï¼Œåˆ™æ·»åŠ åˆ°ç½‘æ ¼ä¸­
                if (slot && slot.__card) {
                    grid[row][col] = slot.__card;
                } else {
                    grid[row][col] = null;
                }
            }
        }

        return grid;
    }

    const spawnStyles = `
    .spawn-animation {
        animation: spawnCard 0.5s ease-out;
    }

    @keyframes spawnCard {
        0% {
            transform: scale(0.3);
            opacity: 0;
        }
        70% {
            transform: scale(1.1);
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    `;

    // å°†æ ·å¼æ·»åŠ åˆ°æ–‡æ¡£ä¸­
    const spawnSheet = document.createElement('style');
    spawnSheet.textContent = spawnStyles;
    document.head.appendChild(spawnSheet);



    // æ·»åŠ å•†åº—æ ·å¼
    const shopStyles = `
        #shop-button {
            position: fixed;
            left: 20px;
            top: 80px;
            padding: 10px 20px;
            background: #e67e22;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            z-index: 1001;
        }

        #shop-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1002;
            overflow-y: auto;
            padding: 20px;
        }

        #shop-content {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            color: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .shop-item-icon {
            font-size: 32px;
        }

        .shop-item-price {
            color: #e67e22;
            font-weight: bold;
        }

        .shop-item-button {
            background: #e67e22;
            border: none;
            border-radius: 4px;
            color: white;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .shop-item-button:hover {
            background: #d35400;
        }

        .shop-item-button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }
    `;

    // æ·»åŠ å•†åº—çŠ¶æ€å˜é‡
    let isFirstShopOpen = true;
    let currentShopItems = [];
    let discountItemIndex = -1;

    // ä¿®æ”¹å•†åº—çš„HTMLç»“æ„,æ·»åŠ åˆ·æ–°æŒ‰é’®
    function addShopHTML() {
        const shopHTML = `
        <div id="shop-container">
            <div id="shop-content">
                <button id="shop-close">Ã—</button>
                <h2>ğŸª å•†åº—</h2>
                <div class="shop-buttons">
                    <button id="refresh-shop">åˆ·æ–°å•†å“</button>
                </div>
                <div class="shop-grid"></div>
            </div>
        </div>
    `;
        document.body.insertAdjacentHTML('beforeend', shopHTML);
    }

    // ä¿®æ”¹å•†åº—åˆå§‹åŒ–å‡½æ•°
    function initShop() {
        // æ·»åŠ æ ·å¼
        const styleSheet = document.createElement('style');
        styleSheet.textContent = shopStyles + `
        .shop-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        #refresh-shop {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        #refresh-shop:hover {
            background: #27ae60;
        }

        #refresh-shop:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .shop-item.discounted {
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
            border: 2px solid #2ecc71;
        }

        .discounted-price {
            color: #2ecc71;
            font-weight: bold;
        }

        .material-icon {
            font-size: 0.9em;
            opacity: 0.8;
            margin-left: 4px;
        }
    `;
        document.head.appendChild(styleSheet);

        // åˆ›å»ºå•†åº—HTML
        const shopHTML = `
        <button id="shop-button">ğŸ›ï¸ å•†åº—</button>
        <div id="shop-container" style="display: none;">
            <div id="shop-content">
                <h2>å•†åº—</h2>
                <div class="shop-buttons">
                    <button id="refresh-shop">åˆ·æ–°å•†å“ (3ğŸ§±)</button>
                    <button id="shop-close">å…³é—­</button>
                </div>
                <div class="shop-grid"></div>
            </div>
        </div>
    `;

        // æ·»åŠ HTMLåˆ°body
        document.body.insertAdjacentHTML('beforeend', shopHTML);

        // è·å–DOMå…ƒç´ å¹¶æ·»åŠ äº‹ä»¶ç›‘å¬
        const shopButton = document.getElementById('shop-button');
        const shopContainer = document.getElementById('shop-container');
        const shopClose = document.getElementById('shop-close');
        const refreshButton = document.getElementById('refresh-shop');

        if (shopButton && shopContainer && shopClose && refreshButton) {
            shopButton.addEventListener('click', () => {
                shopContainer.style.display = 'block';
                if (isFirstShopOpen) {
                    generateShopItems();
                    isFirstShopOpen = false;
                }
            });

            refreshButton.addEventListener('click', () => {
                if (resources.material < 3) {
                    showResourceError('ææ–™ä¸è¶³!');
                    return;
                }
                resources.material -= 3;
                updateResourceDisplay();
                generateShopItems();
            });

            shopClose.addEventListener('click', () => {
                shopContainer.style.display = 'none';
            });
        }
    }

    function generateShopItems() {
        const shopGrid = document.querySelector('.shop-grid');
        currentShopItems = [];

        // æ£€æŸ¥èŒä¸šé€‰æ‹©
        if (!selectedProfession || filteredIconData.length === 0) {
            shopGrid.innerHTML = '<div class="shop-error">è¯·å…ˆé€‰æ‹©èŒä¸š!</div>';
            return;
        }

        // æ ¹æ®ç¨€æœ‰åº¦è®¾ç½®ç»Ÿä¸€ä»·æ ¼
        const rarityPrices = {
            [Rarity.COMMON]: 2,    // æ™®é€šå“è´¨2ææ–™
            [Rarity.RARE]: 3,      // ç¨€æœ‰å“è´¨3ææ–™
            [Rarity.EPIC]: 6,      // å²è¯—å“è´¨6ææ–™
            [Rarity.LEGENDARY]: 8   // ä¼ è¯´å“è´¨8ææ–™
        };

        // ç”Ÿæˆå•†å“
        currentShopItems.push(...generateItemsByRarity(Rarity.COMMON, 5));
        currentShopItems.push(...generateItemsByRarity(Rarity.RARE, 2));
        currentShopItems.push(...generateItemsByRarity(Rarity.EPIC, 2));
        currentShopItems.push(...generateItemsByRarity(Rarity.LEGENDARY, 1));

        // éšæœºé€‰æ‹©ä¸€ä¸ªæ‰“æŠ˜å•†å“
        discountItemIndex = Math.floor(Math.random() * currentShopItems.length);

        // ç”Ÿæˆå•†å“HTML
        shopGrid.innerHTML = currentShopItems.map((item, index) => {
            const isDiscounted = index === discountItemIndex;
            const originalPrice = rarityPrices[item.rarity];
            const discountedPrice = isDiscounted ? Math.floor(originalPrice / 2) : originalPrice;

            return `
            <div class="shop-item ${isDiscounted ? 'discounted' : ''}">
                <div class="shop-item-icon">${item.icon}</div>
                <div class="shop-item-info">
                    <div class="shop-item-name">${item.tip}</div>
                    <div class="shop-item-price ${isDiscounted ? 'discounted-price' : ''}">
                        ${discountedPrice}<span class="material-icon">ğŸ§±</span>
                    </div>
                </div>
                <button class="shop-item-button">è´­ä¹°</button>
            </div>
        `;
        }).join('');

        // æ·»åŠ è´­ä¹°æŒ‰é’®äº‹ä»¶ç›‘å¬
        addShopButtonListeners();
    }

    // æ·»åŠ è´­ä¹°æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
    function addShopButtonListeners() {
        const buttons = document.querySelectorAll('.shop-item-button');
        buttons.forEach((button, index) => {
            button.addEventListener('click', () => {
                const item = currentShopItems[index];
                const price = index === discountItemIndex ?
                    Math.floor(getItemPrice(item.rarity) / 2) :
                    getItemPrice(item.rarity);

                if (resources.material >= price) {
                    resources.material -= price;
                    updateResourceDisplay();
                    handCards.push(item);

                    // ä»å•†å“åˆ—è¡¨ä¸­ç§»é™¤å·²è´­ä¹°å•†å“
                    currentShopItems.splice(index, 1);
                    if (index === discountItemIndex) {
                        discountItemIndex = -1;
                    }

                    // é‡æ–°æ¸²æŸ“å•†åº—
                    const shopGrid = document.querySelector('.shop-grid');
                    shopGrid.innerHTML = generateShopItemsHTML(currentShopItems);
                    addShopButtonListeners();

                    showPurchaseSuccess(item);
                } else {
                    showResourceError('ææ–™ä¸è¶³!');
                }
            });
        });
    }

    function generateShopItemsHTML(items) {
        return items.map((item, index) => `
        <div class="shop-item" style="border: 2px solid ${getRarityColor(item.rarity)}">
            <div class="shop-item-icon">${item.icon}</div>
            <div class="shop-item-info">${item.tip}</div>
            <div class="shop-item-price">ğŸ§± ${getItemPrice(item.rarity)} ææ–™</div>
            <button class="shop-item-button" data-item-index="${index}">è´­ä¹°</button>
        </div>
    `).join('');
    }

    // æ ¹æ®ç¨€æœ‰åº¦ç”ŸæˆæŒ‡å®šæ•°é‡çš„å•†å“
    function generateItemsByRarity(rarity, count) {
        // ä»è¿‡æ»¤åçš„ç‰Œå †ä¸­ç­›é€‰æŒ‡å®šç¨€æœ‰åº¦çš„å¡ç‰Œ
        const availableCards = filteredIconData.filter(card => card.rarity === rarity);
        const result = [];

        // å¦‚æœè¿‡æ»¤åæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å¡ç‰Œ,è¿”å›ç©ºæ•°ç»„
        if (availableCards.length === 0) {
            return result;
        }

        // éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„å¡ç‰Œ
        while (result.length < count && availableCards.length > 0) {
            const randomIndex = Math.floor(Math.random() * availableCards.length);
            // ä»å¯ç”¨å¡ç‰Œæ± ä¸­ç§»é™¤å·²é€‰å¡ç‰Œ,é¿å…é‡å¤
            result.push(availableCards.splice(randomIndex, 1)[0]);
        }

        return result;
    }

    // è·å–å•†å“ä»·æ ¼
    function getItemPrice(rarity) {
        switch (rarity) {
            case Rarity.COMMON: return 2;
            case Rarity.RARE: return 3;
            case Rarity.EPIC: return 5;
            case Rarity.LEGENDARY: return 8;
            default: return 2;
        }
    }

    // è´­ä¹°å•†å“
    function purchaseItem(item) {
        const price = getItemPrice(item.rarity);

        if (resources.material < price) {
            showResourceError(`éœ€è¦ ${price} ä¸ªğŸ§±ææ–™èµ„æºæ‰èƒ½è´­ä¹°`);
            return;
        }

        // æ‰£é™¤ææ–™
        resources.material -= price;
        updateResourceDisplay();

        // æ·»åŠ åˆ°æ‰‹ç‰Œ
        handCards.push(item);

        // æ›´æ–°å›¾é‰´æ˜¾ç¤º
        renderCodex();

        // æ˜¾ç¤ºæˆåŠŸæç¤º
        showPurchaseSuccess(item);
    }

    // æ˜¾ç¤ºè´­ä¹°æˆåŠŸæç¤º
    function showPurchaseSuccess(item) {
        const success = document.createElement('div');
        success.textContent = `è·å¾— ${item.icon} ${item.tip}`;
        success.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 9999;
            animation: fadeInOut 2s ease-in-out;
        `;
        document.body.appendChild(success);
        setTimeout(() => success.remove(), 2000);
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ‰“ä¹±æ•°ç»„é¡ºåº
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // æ·»åŠ å•†åº—é”™è¯¯å’Œè­¦å‘Šæç¤ºæ ·å¼
    const additionalShopStyles = `
        .shop-error, .shop-warning {
            color: white;
            padding: 20px;
            text-align: center;
            width: 100%;
            border-radius: 8px;
        }

        .shop-error {
            background: rgba(231, 76, 60, 0.3);
            border: 2px solid #e74c3c;
        }

        .shop-warning {
            background: rgba(241, 196, 15, 0.3);
            border: 2px solid #f1c40f;
            margin-bottom: 20px;
        }
    `;

    // å°†æ–°æ ·å¼æ·»åŠ åˆ°åŸæœ‰çš„å•†åº—æ ·å¼ä¸­
    const updatedShopStyles = shopStyles + additionalShopStyles;

    function initResourcePanel() {
        const panel = document.createElement('div');
        panel.className = 'resource-panel';
        panel.innerHTML = `
            <h3>èµ„æºäº¤æ˜“</h3>
            <div class="resource-item">
                <div class="resource-info">
                    <div class="resource-name">ææ–™ ğŸ§±</div>
                    <div class="resource-count" id="material-count">0</div>
                </div>
                <div class="resource-actions">
                    <button class="trade-btn buy-btn" onclick="buyResource('material')">
                        ä¹°å…¥(${tradePrices.buy.material}ğŸ’°)
                    </button>
                    <button class="trade-btn sell-btn" onclick="sellResource('material')">
                        å–å‡º(+${tradePrices.sell.material}ğŸ’°)
                    </button>
                </div>
            </div>
            <div class="resource-item">
                <div class="resource-info">
                    <div class="resource-name">ç¥ç§˜ âœ¨</div>
                    <div class="resource-count" id="mystic-count">0</div>
                </div>
                <div class="resource-actions">
                    <button class="trade-btn buy-btn" onclick="buyResource('mystic')">
                        ä¹°å…¥(${tradePrices.buy.mystic}ğŸ’°)
                    </button>
                    <button class="trade-btn sell-btn" onclick="sellResource('mystic')">
                        å–å‡º(+${tradePrices.sell.mystic}ğŸ’°)
                    </button>
                </div>
            </div>
            <div class="resource-item">
                <div class="resource-info">
                    <div class="resource-name">ç§‘ç ” ğŸ”¬</div>
                    <div class="resource-count" id="tech-count">0</div>
                </div>
                <div class="resource-actions">
                    <button class="trade-btn buy-btn" onclick="buyResource('tech')">
                        ä¹°å…¥(${tradePrices.buy.tech}ğŸ’°)
                    </button>
                    <button class="trade-btn sell-btn" onclick="sellResource('tech')">
                        å–å‡º(+${tradePrices.sell.tech}ğŸ’°)
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(panel);
        updateResourceDisplay();
    }

    function buyResource(type) {
        const price = tradePrices.buy[type];
        if (coinCount >= price) {
            coinCount -= price;
            resources[type]++;
            updateCoinDisplay();
            updateResourceDisplay();
        } else {
            showResourceError('é‡‘å¸ä¸è¶³!');
        }
    }

    function sellResource(type) {
        if (resources[type] > 0) {
            resources[type]--;
            coinCount += tradePrices.sell[type];
            updateCoinDisplay();
            updateResourceDisplay();
        } else {
            showResourceError(`${type}èµ„æºä¸è¶³!`);
        }
    }

    function updateResourceDisplay() {
        Object.keys(resources).forEach(type => {
            const element = document.getElementById(`${type}-count`);
            if (element) {
                element.textContent = resources[type];
            }
        });
    }
</script>
</body>
</html>