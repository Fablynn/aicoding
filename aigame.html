<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>AI:幸运房东</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background: #222;
            color: #fff;
        }

        #slot-machine {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 40px auto;
            width: fit-content;
        }

        #coin-pool {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            color: #fff;
            z-index: 100;
        }

        .coin-icon {
            font-size: 22px;
            animation: none;
        }

        #coin-count {
            font-weight: bold;
        }

        @keyframes coinBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .coin-highlight {
            animation: coinBounce 0.5s ease infinite;
        }

        .flying-coin {
            position: absolute;
            font-size: 20px;
            z-index: 99;
            pointer-events: none;
        }

        .column {
            width: 80px;
            height: 400px;
            overflow: hidden;
            border: 2px solid #555;
            background: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 8px;
            position: relative;
        }

        .slot {
            width: 100%;
            height: 80px;
            font-size: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: slide 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        @keyframes slide {
            from {
                transform: translateY(-20px);
                opacity: 0.5;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        button {
            padding: 10px 20px;
            font-size: 18px;
            border: none;
            border-radius: 6px;
            background: #00bcd4;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background: #0097a7;
        }

        .slot:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            background: #333;
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 14px;
            transform: translateY(-5px);
            opacity: 0.9;
        }

        .highlight {
            animation: blink 0.6s infinite;
            background: #ffeb3b;
            border-radius: 6px;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        #upgrade-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .panel-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .skip-button, .hide-button {
            padding: 8px 16px;
            background: #666;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        .skip-button:hover, .hide-button:hover {
            background: #888;
        }

        #show-upgrade-button {
            margin-left: 10px;
            padding: 8px 16px;
            background: #4a90e2;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        #show-upgrade-button:hover {
            background: #3a80d2;
        }

        #upgrade-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .upgrade-card {
            background: #333;
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            width: 150px;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
        }

        .upgrade-card:hover {
            transform: scale(1.05);
            background: #555;
        }

        .upgrade-card .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

    </style>
</head>
<body>
<!--<h1>🎰 Slots 游戏</h1>-->
<div id="coin-pool">
    <div class="coin-icon">💰</div>
    <span id="coin-count">0</span>
</div>
<div id="slot-machine">
    <div class="column" id="col-0" data-index="0"></div>
    <div class="column" id="col-1" data-index="1"></div>
    <div class="column" id="col-2" data-index="2"></div>
    <div class="column" id="col-3" data-index="3"></div>
    <div class="column" id="col-4" data-index="4"></div>
</div>
<div id="upgrade-panel">
    <h2>🎁 选择一个构筑加成</h2>
    <div id="upgrade-options"></div>
    <div class="panel-buttons">
        <button class="skip-button" onclick="giveUpgrade()">跳过选择</button>
        <button class="hide-button" onclick="hideUpgradePanel()">隐藏面板</button>
    </div>
</div>

<!-- 游戏主界面添加显示构筑面板按钮 -->
<div class="game-controls">
    <button id="start-button" onclick="startSlots()">开始滚动</button>
    <button id="show-upgrade-button" onclick="toggleUpgradePanel()" style="display: none;">选择奖励</button>
</div>

<script>
    // 定义图标类别枚举
    const IconCategory = {
        Items: 'Items',            // 基类 放数值卡牌
        Box: 'Box',                 // 宝箱类
        Key: 'Key',                 // 钥匙类
        STATUS: 'STATUS',          // 状态效果类
        WEATHER: 'WEATHER',        // 天气环境类
        ANIMAL: 'ANIMAL',          // 动物伙伴类
        BUILDING: 'BUILDING',      // 建筑设施类
        PLANT: 'PLANT',           // 植物资源类
        MAGIC: 'MAGIC',           // 魔法元素类
        TREASURE: 'TREASURE',      // 宝物财富类
        FESTIVAL: 'FESTIVAL',      // 节日庆典类
        MUSIC: 'MUSIC',           // 音乐艺术类
        VEHICLE: 'VEHICLE',        // 交通工具类
        GEM: 'GEM',               // 水晶宝石类
        TECH: 'TECH',             // 科技装备类
        MARINE: 'MARINE',         // 海洋生物类
        MYTH: 'MYTH',             // 神话生物类
        TIME: 'TIME'              // 时空元素类
    };

    // 定义稀有度枚举
    const Rarity = {
        COMMON: '优秀',           // 优秀 (2-3金币)
        RARE: '精良',            // 精良 (4-6金币)
        EPIC: '史诗',            // 史诗 (7-9金币)
        LEGENDARY: '传说'         // 传说 (15-20金币)
    };
    // 完善职业列表
    const professions = [
        // { icon: '🧙‍♂️', tip: '法师', baseCoins: 0, rarity: Rarity.LEGENDARY,
        //     description: '掌握奥术的大师，擅长各类魔法元素',
        //     excludeCategories: [IconCategory.TECH,IconCategory.ANIMAL, IconCategory.VEHICLE, IconCategory.MARINE] },
        //
        // { icon: '🧝‍♀️', tip: '艺术家', baseCoins: 0, rarity: Rarity.COMMON,
        //     description: '沉浸于艺术创作，热爱音乐与美术和奇怪的建筑',
        //     excludeCategories: [IconCategory.TECH,IconCategory.VEHICLE, IconCategory.PLANT, IconCategory.MAGIC] },
        //
        // { icon: '🦸‍♂️', tip: '商人', baseCoins: 0, rarity: Rarity.COMMON,
        //     description: '精于算计的贸易商人，善于财富积累，也会铤而走险',
        //     excludeCategories: [IconCategory.PLANT, IconCategory.TECH, IconCategory.ANIMAL] },
        //
        // { icon: '🤖', tip: '机器人', baseCoins: 0, rarity: Rarity.LEGENDARY,
        //     description: '精通科技的发明家，擅长机械装置',
        //     excludeCategories: [IconCategory.MAGIC, IconCategory.PLANT, IconCategory.FESTIVAL, IconCategory.MYTH] },

        { icon: '🧑‍🌾', tip: '农夫', baseCoins: 0, rarity: Rarity.RARE,
            description: '勤劳的耕种者，与自然和植物亲近',
            excludeCategories: [IconCategory.TECH, IconCategory.MAGIC, IconCategory.MARINE, IconCategory.TREASURE] }
    ];

    // 添加职业选择面板HTML
    const professionSelectionHTML = `
<div id="profession-selection-panel">
    <h2>🧩 选择你的职业</h2>
    <p>不同职业会影响你的抽牌库构成</p>
    <div id="profession-options"></div>
</div>
`;

    // 添加职业选择面板样式
    const professionSelectionStyles = `
#profession-selection-panel {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 20px;
    color: white;
}

#profession-options {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
    max-width: 800px;
}

.profession-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 20px;
    width: 180px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.profession-card:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-5px);
}

.profession-icon {
    font-size: 48px;
    margin-bottom: 10px;
}

.profession-name {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 10px;
    color: #4a90e2;
}

.profession-description {
    font-size: 14px;
    margin-bottom: 15px;
    color: rgba(255, 255, 255, 0.8);
}

.profession-rarity {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-top: 10px;
}

.rarity-common {
    background: #7fba00;
}

.rarity-rare {
    background: #2b88d9;
}

.rarity-epic {
    background: #9370db;
}

.rarity-legendary {
    background: #ff8c00;
}
`;

    // 添加变量存储当前选择的职业
    let selectedProfession = null;
    let filteredIconData = [];

    // 初始化职业选择面板
    function initProfessionSelection() {
        // 添加样式
        const styleSheet = document.createElement('style');
        styleSheet.textContent = professionSelectionStyles;
        document.head.appendChild(styleSheet);

        // 添加HTML
        const div = document.createElement('div');
        div.innerHTML = professionSelectionHTML;
        document.body.appendChild(div.firstElementChild);

        // 获取职业选项容器
        const optionsContainer = document.getElementById('profession-options');

        // 渲染职业卡片
        professions.forEach(profession => {
            const rarityClass = `rarity-${profession.rarity.toLowerCase()}`;
            const card = document.createElement('div');
            card.className = 'profession-card';
            card.innerHTML = `
            <div class="profession-icon">${profession.icon}</div>
            <div class="profession-name">${profession.tip}</div>
            <div class="profession-description">${profession.description}</div>
            <div class="profession-rarity ${rarityClass}">${profession.rarity}</div>
        `;

            // 添加点击事件
            card.addEventListener('click', () => {
                selectProfession(profession);
            });

            optionsContainer.appendChild(card);
        });
    }

    // 修改选择职业的函数
    function selectProfession(profession) {
        selectedProfession = profession;

        // 过滤抽牌库
        filterCardsByProfession();

        // 关闭职业选择面板
        const panel = document.getElementById('profession-selection-panel');
        panel.style.opacity = '0';
        panel.style.transition = 'opacity 0.5s ease';

        setTimeout(() => {
            panel.remove();
            // 开始初始构筑环节
            startInitialDeck();
        }, 500);

        // 显示选择确认消息
        showProfessionConfirmation(profession);
    }

    function startInitialDeck() {
        window.deckBuildingCount = 10; // 构筑次数
        const upgradePanel = document.getElementById('upgrade-panel');

        // 显示构筑面板
        upgradePanel.style.display = 'block';
        document.getElementById('show-upgrade-button').style.display = 'none';

        // 修改面板标题
        const panelTitle = document.querySelector('#upgrade-panel h2');
        panelTitle.textContent = `🎮 初始构筑 (剩余${window.deckBuildingCount}次)`;

        showUpgradeChoices();
    }

    // 显示构筑完成消息
    function showDeckCompleteMessage() {
        const message = document.createElement('div');
        message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 200, 0, 0.9);
        padding: 20px;
        border-radius: 10px;
        color: white;
        font-size: 24px;
        z-index: 2000;
        text-align: center;
        animation: fadeInOut 2s ease-in-out;
    `;
        message.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 10px;">✨</div>
        <div>初始构筑完成！</div>
        <div style="font-size: 16px; margin-top: 10px;">点击开始按钮开始游戏</div>
    `;
        document.body.appendChild(message);

        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
        }
    `;
        document.head.appendChild(style);

        // 2秒后移除消息
        setTimeout(() => {
            message.remove();
            style.remove();
        }, 2000);
    }


    // 根据职业过滤卡牌
    function filterCardsByProfession() {
        if (!selectedProfession) {
            filteredIconData = [...iconData];
            return;
        }

        // 过滤掉职业排除的类别
        filteredIconData = iconData.filter(card =>
            !selectedProfession.excludeCategories.includes(card.category)
        );

        console.log(`已过滤卡牌库，剩余 ${filteredIconData.length} 张卡牌`);
    }

    // 显示职业选择确认消息
    function showProfessionConfirmation(profession) {
        const message = document.createElement('div');
        message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(74, 144, 226, 0.9);
        padding: 20px;
        border-radius: 10px;
        color: white;
        font-size: 24px;
        z-index: 1000;
        text-align: center;
    `;
        message.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 10px;">${profession.icon}</div>
        <div>你选择了 ${profession.tip} 职业！</div>
    `;
        document.body.appendChild(message);
        setTimeout(() => message.remove(), 2000);
    }

    // 优化后的猫鼠互动检查函数
    function checkCatMouseInteraction(grid, row, col, highlightGroups) {
        const currentCard = grid[row][col];
        if (!currentCard) return;
    
        // 检查是否是猫或鼠
        if (currentCard.icon === '🐈' || currentCard.icon === '🐭') {
            const neighbors = [];
    
            // 检查八个方向相邻格子
            const directions = [
                [-1, -1], // 左上
                [-1, 0],  // 上
                [-1, 1],  // 右上
                [0, -1],  // 左
                [0, 1],   // 右
                [1, -1],  // 左下
                [1, 0],   // 下
                [1, 1]    // 右下
            ];
    
            for (const [dx, dy] of directions) {
                const newRow = row + dx;
                const newCol = col + dy;
    
                // 确保位置在网格内
                if (newRow >= 0 && newRow < 5 && newCol >= 0 && newCol < 5) {
                    const neighbor = grid[newRow][newCol];
                    if (neighbor) {
                        // 如果当前是猫,寻找老鼠
                        if (currentCard.icon === '🐈' && neighbor.icon === '🐭') {
                            neighbors.push({
                                card: neighbor,
                                element: document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`)
                            });
                        }
                        // 如果当前是老鼠,寻找猫
                        else if (currentCard.icon === '🐭' && neighbor.icon === '🐈') {
                            neighbors.push({
                                card: neighbor,
                                element: document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`)
                            });
                        }
                    }
                }
            }
    
            // 如果找到相互作用的卡牌
            if (neighbors.length > 0) {
                const currentElement = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
                
                // 将当前卡牌和相邻卡牌加入高亮组
                const group = [
                    { card: currentCard, element: currentElement },
                    ...neighbors
                ];
                highlightGroups.push(group);
    
                // 计算额外获得的金币
                const extraCoins = neighbors.reduce((sum, {card}) => sum + card.baseCoins, 0);
                
                // 更新当前卡片右上角的金币提示
                const coinIndicator = currentElement.querySelector('.coin-indicator');
                if (coinIndicator) {
                    coinIndicator.textContent = `+${currentCard.baseCoins + extraCoins}💰`;
                }
    
                // 显示互动效果
                setTimeout(() => {
                    showCatMouseEffect(currentElement, neighbors.map(n => n.element));
                    addCoins(extraCoins, currentElement);
                }, 500);
            }
        }
    }
    
    // 优化猫鼠互动效果显示
    function showCatMouseEffect(sourceElement, targetElements) {
        targetElements.forEach(targetElement => {
            // 创建放射状连接线
            const line = document.createElement('div');
            line.className = 'cat-mouse-line';
            document.body.appendChild(line);
    
            // 获取位置
            const sourceRect = sourceElement.getBoundingClientRect();
            const targetRect = targetElement.getBoundingClientRect();
    
            // 设置线的位置和角度
            const startX = sourceRect.left + sourceRect.width / 2;
            const startY = sourceRect.top + sourceRect.height / 2;
            const endX = targetRect.left + targetRect.width / 2;
            const endY = targetRect.top + targetRect.height / 2;
    
            const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
    
            line.style.width = `${length}px`;
            line.style.left = `${startX}px`;
            line.style.top = `${startY}px`;
            line.style.transform = `rotate(${angle}deg)`;
    
            // 创建互动文本
            const text = document.createElement('div');
            text.className = 'cat-mouse-text';
            const isMultiple = targetElements.length > 1;
            text.textContent = sourceElement.__card.icon === '🐈' ? 
                `🐈 和 Jerry!` :
                `🐭 和 Tom!`;
            text.style.left = `${(startX + endX) / 2}px`;
            text.style.top = `${(startY + endY) / 2 - 20}px`;
            document.body.appendChild(text);
    
            // 动画结束后移除效果
            setTimeout(() => {
                line.remove();
                text.remove();
            }, 1000);
        });
    }

    const catMouseStyles = `
    .cat-mouse-line {
        position: fixed;
        height: 2px;
        background: linear-gradient(90deg, #ffeb3b, #ff9800);
        transform-origin: left;
        z-index: 100;
        animation: catMousePulse 1s ease-in-out;
    }

    .cat-mouse-text {
        position: fixed;
        color: #ff9800;
        font-weight: bold;
        font-size: 16px;
        text-shadow: 0 0 5px rgba(0,0,0,0.8);
        transform: translate(-50%, -50%);
        z-index: 101;
        animation: catMouseTextFloat 1.5s ease-out;
        white-space: nowrap;
    }

    @keyframes catMousePulse {
        0% { opacity: 0; height: 1px; }
        50% { opacity: 1; height: 3px; }
        100% { opacity: 0; height: 2px; }
    }

    @keyframes catMouseTextFloat {
        0% { opacity: 0; transform: translate(-50%, 0); }
        20% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; transform: translate(-50%, -30px); }
    }
    `;

    const iconData = [
        // 钥匙和宝箱
        { icon: '🗝️', tip: '开锁', baseCoins: 1,delCoins:0, rarity: Rarity.COMMON, category: IconCategory.Key },
        { icon: '📦', tip: '宝箱藏着30金币', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        { icon: '💼', tip: '精华宝箱藏着50金币', baseCoins: 2,delCoins:50, rarity: Rarity.RARE, category: IconCategory.Box },
        { icon: '👑', tip: '财富宝箱藏着80金币', baseCoins: 3,delCoins:80, rarity: Rarity.EPIC, category: IconCategory.Box },
        { icon: '🧳', tip: '传奇宝箱藏着120金币', baseCoins: 5,delCoins:120, rarity: Rarity.LEGENDARY, category: IconCategory.Box },

        // 天气环境类
        { icon: '🌪️', tip: '龙卷风：破坏', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.WEATHER },
        { icon: '🌧️', tip: '雨天:20%概率添加💧',make:'💧', baseCoins: 1, rarity: Rarity.RARE, category: IconCategory.WEATHER },
        // { icon: '⛈️', tip: '雷暴', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.WEATHER },
        // { icon: '❄️', tip: '暴雪', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.WEATHER },
        // { icon: '☁️', tip: '多云', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.WEATHER },
        { icon: '💧', tip: '水:可以让植物长大', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.WEATHER },
        // { icon: '🌫️', tip: '核废水', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.WEATHER },

        // 植物资源类
        { icon: '🌿', tip: '发芽', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.PLANT },
        { icon: '🌸', tip: '开花', baseCoins: 1, rarity: Rarity.RARE, category: IconCategory.PLANT },
        { icon: '🌻', tip: '向日葵', baseCoins: 2, rarity: Rarity.RARE, category: IconCategory.PLANT },
        { icon: '🌾', tip: '麦穗', baseCoins: 2, rarity: Rarity.EPIC, category: IconCategory.PLANT },
        { icon: '🍎', tip: '苹果', baseCoins: 3, rarity: Rarity.EPIC, category: IconCategory.PLANT},
        { icon: '🌲', tip: '松树：生产材料2', baseCoins: 5, rarity: Rarity.LEGENDARY, category: IconCategory.PLANT },
        { icon: '🌳', tip: '树木: 生产神秘2', baseCoins: 5, rarity: Rarity.LEGENDARY, category: IconCategory.PLANT },
        { icon: '🌴', tip: '棕榈树：生产科技2', baseCoins: 5, rarity: Rarity.LEGENDARY, category: IconCategory.PLANT },
        { icon: '🎄', tip: '圣诞树 20%概率添加🎇',make: '🎇', baseCoins: 5, rarity: Rarity.LEGENDARY, category: IconCategory.PLANT },

        // 动物伙伴类
        { icon: '🐕', tip: '小狗', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.ANIMAL },
        { icon: '🐈', tip: 'Tom', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.ANIMAL },
        { icon: '🐭', tip: 'Jerry', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.ANIMAL },
        { icon: '🐇', tip: '兔子 20%概率添加🐇',make:'🐇', baseCoins: 2, rarity: Rarity.RARE, category: IconCategory.ANIMAL },
        { icon: '🐺', tip: '狼', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.ANIMAL },
        { icon: '🐯', tip: '猛虎', baseCoins: 5, rarity: Rarity.EPIC, category: IconCategory.ANIMAL },
        { icon: '🐉', tip: '巨龙: 最强生物', baseCoins: 18, rarity: Rarity.LEGENDARY, category: IconCategory.ANIMAL },

        // 建筑设施类
        { icon: '🏚️', tip: '废墟', baseCoins: 3, rarity: Rarity.COMMON, category: IconCategory.BUILDING },
        { icon: '⛪', tip: '教堂', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.BUILDING },
        { icon: '🏰', tip: '城堡', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.BUILDING },
        { icon: '🏯', tip: '要塞', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.BUILDING },
        { icon: '🗽', tip: '神像', baseCoins: 20, rarity: Rarity.LEGENDARY, category: IconCategory.BUILDING },

        // 魔法元素类
        // { icon: '🔥', tip: '火焰伤害', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.MAGIC },
        // { icon: '❄️', tip: '冰冻效果', baseCoins: 6, rarity: Rarity.RARE, category: IconCategory.MAGIC },
        // { icon: '⚡', tip: '闪电连击', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.MAGIC },
        // { icon: '🌈', tip: '彩虹祝福', baseCoins: 9, rarity: Rarity.EPIC, category: IconCategory.MAGIC },
        // { icon: '💫', tip: '魔法星尘', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.MAGIC },
        // { icon: '🌟', tip: '星光祝福', baseCoins: 9, rarity: Rarity.EPIC, category: IconCategory.MAGIC },
        // { icon: '🌀', tip: '空间扭曲', baseCoins: 16, rarity: Rarity.LEGENDARY, category: IconCategory.MAGIC },
        // { icon: '☄️', tip: '陨石坠落', baseCoins: 18, rarity: Rarity.LEGENDARY, category: IconCategory.MAGIC },
        // { icon: '🧪', tip: '神秘药水', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.MAGIC },
        // { icon: '📜', tip: '法术卷轴', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.MAGIC },
        // { icon: '💊', tip: '治疗药剂', baseCoins: 4, rarity: Rarity.RARE, category: IconCategory.MAGIC },
        // { icon: '🧉', tip: '能量饮品', baseCoins: 3, rarity: Rarity.COMMON, category: IconCategory.MAGIC },
        // { icon: '🔮', tip: '预言水晶', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.MAGIC },

        // 宝物财富类
        { icon: '💰', tip: '金币', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.TREASURE },
        { icon: '💎', tip: '稀有宝石', baseCoins: 3, rarity: Rarity.EPIC, category: IconCategory.TREASURE },
        { icon: '💍', tip: '魔法戒指', baseCoins: 4, rarity: Rarity.EPIC, category: IconCategory.TREASURE },
        { icon: '🏆', tip: '荣誉奖杯: 生产神秘3', baseCoins: 8, rarity: Rarity.LEGENDARY, category: IconCategory.TREASURE },

        // 节日庆典类
        { icon: '🎨', tip: '彩绘', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.FESTIVAL },
        { icon: '🎇', tip: '烟花', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.FESTIVAL },
        { icon: '🎉', tip: '庆祝', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.FESTIVAL },
        { icon: '🏮', tip: '红灯笼', baseCoins: 2, rarity: Rarity.RARE, category: IconCategory.FESTIVAL },
        { icon: '🎃', tip: '南瓜灯', baseCoins: 3, rarity: Rarity.RARE, category: IconCategory.FESTIVAL },
        { icon: '🎭', tip: '狂欢面具 20%概率添加🎨',make: '🎨', baseCoins: 6, rarity: Rarity.RARE, category: IconCategory.FESTIVAL },
        { icon: '🎅', tip: '圣诞老人 40%概率添加🎉',make: '🎉', baseCoins: 8, rarity: Rarity.LEGENDARY, category: IconCategory.MYTH },
        // { icon: '🎪', tip: '嘉年华', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.FESTIVAL },

        // 音乐艺术类
        { icon: '🎻', tip: '小提琴 20%概率添加🎵',make:'🎵', baseCoins: 1, rarity: Rarity.RARE, category: IconCategory.MUSIC },
        { icon: '🎹', tip: '钢琴 30%概率添加🎵',make:'🎵', baseCoins: 1, rarity: Rarity.EPIC, category: IconCategory.MUSIC },
        { icon: '🎶', tip: '旋律', baseCoins: 2, rarity: Rarity.RARE, category: IconCategory.MUSIC },
        { icon: '🎵', tip: '音符', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.MUSIC },
        { icon: '🎼', tip: '乐谱', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.MUSIC },
        { icon: '🧚', tip: '精灵 30%概率添加🎶',make:'🎶', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.MYTH },
        // { icon: '🎺', tip: '小号', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.MUSIC },
        // { icon: '🥁', tip: '战鼓', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.MUSIC },

        // 海洋生物类
        { icon: '🐋', tip: '巨鲸', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.MARINE },
        { icon: '🦐', tip: '虾', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.MARINE },
        { icon: '🐚', tip: '贝壳', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.MARINE },
        { icon: '🐡', tip: '河豚', baseCoins: 2, rarity: Rarity.RARE, category: IconCategory.MARINE },
        { icon: '🐙', tip: '章鱼', baseCoins: 4, rarity: Rarity.RARE, category: IconCategory.MARINE },
        { icon: '🐳', tip: '喷水鲸：生产神秘1', baseCoins: 6, rarity: Rarity.EPIC, category: IconCategory.MARINE },
        { icon: '🐬', tip: '海豚：生产神秘1', baseCoins: 5, rarity: Rarity.EPIC, category: IconCategory.MARINE },
        { icon: '🧜‍♀️', tip: '人鱼公主:可以召唤海王类', baseCoins: 2, rarity: Rarity.EPIC, category: IconCategory.MARINE },

        // 水晶宝石类
        { icon: '⬜', tip: '普通矿石', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.GEM },
        { icon: '🔶', tip: '琥珀', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.GEM },
        { icon: '🔷', tip: '蓝宝石', baseCoins: 4, rarity: Rarity.RARE, category: IconCategory.GEM },
        { icon: '♦️', tip: '红宝石', baseCoins: 4, rarity: Rarity.RARE, category: IconCategory.GEM },
        { icon: '🟡', tip: '黄宝石', baseCoins: 5, rarity: Rarity.EPIC, category: IconCategory.GEM },
        { icon: '🔺', tip: '水晶', baseCoins: 5, rarity: Rarity.EPIC, category: IconCategory.GEM },
        { icon: '💎', tip: '钻石:生产材料3', baseCoins: 10, rarity: Rarity.LEGENDARY, category: IconCategory.GEM },
        { icon: '🔮', tip: '魔法水晶:生产神秘3', baseCoins: 8, rarity: Rarity.LEGENDARY, category: IconCategory.GEM },

        // 时空元素类 翻转
        { icon: '🌌', tip: '星空', baseCoins: 5, rarity: Rarity.EPIC, category: IconCategory.TIME },
        { icon: '🌠', tip: '流星', baseCoins: 5, rarity: Rarity.EPIC, category: IconCategory.TIME },
        { icon: '🌙', tip: '月光', baseCoins: 4, rarity: Rarity.EPIC, category: IconCategory.TIME },
        { icon: '🌞', tip: '太阳', baseCoins: 3, rarity: Rarity.EPIC, category: IconCategory.TIME },
        { icon: '🌀', tip: '时空倒流', baseCoins: 0, rarity: Rarity.LEGENDARY, category: IconCategory.TIME },
        { icon: '⌛', tip: '时之沙：生产神秘2', baseCoins: 8, rarity: Rarity.LEGENDARY, category: IconCategory.TIME },

        // 科技类 升级
        { icon: '🚀', tip: '火箭', baseCoins: 20, rarity: Rarity.LEGENDARY, category: IconCategory.TECH },
        { icon: '🚢', tip: '游轮', baseCoins: 12, rarity: Rarity.LEGENDARY, category: IconCategory.TECH },
        { icon: '🚤', tip: '快艇', baseCoins: 6, rarity: Rarity.RARE, category: IconCategory.TECH },
        { icon: '🛸', tip: '时光机', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.TECH },
        { icon: '🚁', tip: '直升机', baseCoins: 14, rarity: Rarity.LEGENDARY, category: IconCategory.TECH },
        { icon: '⚡', tip: '能源核心', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.TECH },
        { icon: '🔋', tip: '高能电池', baseCoins: 3, rarity: Rarity.COMMON, category: IconCategory.TECH },
        { icon: '💻', tip: '终端设备', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.TECH },
        { icon: '🎮', tip: '控制器', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.TECH },
        { icon: '📱', tip: '智能设备', baseCoins: 4, rarity: Rarity.RARE, category: IconCategory.TECH },
        { icon: '🛰️', tip: '卫星模块', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.TECH },
        { icon: '🤖', tip: '机器人', baseCoins: 16, rarity: Rarity.LEGENDARY, category: IconCategory.TECH },
        { icon: '⚙️', tip: '机械齿轮', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.TECH },


        // 神话生物类
        // { icon: '🦄', tip: '独角兽', baseCoins: 16, rarity: Rarity.LEGENDARY, category: IconCategory.MYTH },
        // { icon: '🧚', tip: '精灵', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.MYTH },
        // { icon: '🧞', tip: '灯神', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.MYTH },
        // { icon: '🧛', tip: '吸血鬼', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.MYTH },
        // { icon: '👹', tip: '恶魔', baseCoins: 6, rarity: Rarity.RARE, category: IconCategory.MYTH },
        // { icon: '👻', tip: '幽灵', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.MYTH },


        // // 冒险类
        // { icon: '🗡️', tip: '勇气之刃', baseCoins: 4, rarity: Rarity.RARE, category: IconCategory.WEAPON },
        // { icon: '🛡️', tip: '勇气之盾', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.WEAPON },
        // { icon: '🏹', tip: '勇气之弓', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.WEAPON },
        // { icon: '⚔️', tip: '英勇打击', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.WEAPON },
        // { icon: '🪓', tip: '一往无前', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.WEAPON },
        // { icon: '🔫', tip: '狙杀', baseCoins: 6, rarity: Rarity.RARE, category: IconCategory.WEAPON },
        // { icon: '🗡️', tip: '匕首', baseCoins: 6, rarity: Rarity.RARE, category: IconCategory.WEAPON },
        // { icon: '🦾', tip: '冒险', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.WEAPON },

        // 状态效果类
        // { icon: '💤', tip: '睡眠', baseCoins: 4, rarity: Rarity.RARE, category: IconCategory.STATUS },
        // { icon: '🤕', tip: '受伤', baseCoins: 3, rarity: Rarity.COMMON, category: IconCategory.STATUS },
        // { icon: '🤢', tip: '中毒', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.STATUS },
        // { icon: '💘', tip: '魅惑', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.STATUS },
        // { icon: '💢', tip: '愤怒', baseCoins: 6, rarity: Rarity.RARE, category: IconCategory.STATUS },
        // { icon: '😱', tip: '恐惧', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.STATUS },
        // 效果增益类
        // { icon: '🎯', tip: '精准打击', baseCoins: 6, rarity: Rarity.RARE, category: IconCategory.BUFF },
        // { icon: '🧲', tip: '磁力吸收', baseCoins: 5, rarity: Rarity.RARE, category: IconCategory.BUFF },
        // { icon: '🦾', tip: '机械强化', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.BUFF },
        // { icon: '🎭', tip: '伪装效果', baseCoins: 4, rarity: Rarity.RARE, category: IconCategory.BUFF },
        // { icon: '👁️', tip: '真实视觉', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.BUFF },
        // { icon: '🛡️', tip: '护盾加成', baseCoins: 9, rarity: Rarity.EPIC, category: IconCategory.BUFF },
        // { icon: '⚔️', tip: '攻击强化', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.BUFF },
        // { icon: '💥', tip: '爆炸增幅', baseCoins: 16, rarity: Rarity.LEGENDARY, category: IconCategory.BUFF },

        // 特殊能力类
        // { icon: '🌀', tip: '瞬间移动', baseCoins: 16, rarity: Rarity.LEGENDARY, category: IconCategory.ABILITY },
        // { icon: '🎲', tip: '随机效果', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.ABILITY },
        // { icon: '🎮', tip: '技能强化', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.ABILITY },
        // { icon: '🃏', tip: '复制能力', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.ABILITY },
        // { icon: '🦸', tip: '英雄模式', baseCoins: 17, rarity: Rarity.LEGENDARY, category: IconCategory.ABILITY },
        // { icon: '🧙', tip: '召唤法师', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.ABILITY },
        // { icon: '🦹', tip: '反派技能', baseCoins: 9, rarity: Rarity.EPIC, category: IconCategory.ABILITY },
        // { icon: '🧞', tip: '召唤精灵', baseCoins: 16, rarity: Rarity.LEGENDARY, category: IconCategory.ABILITY },
        // { icon: '🧟', tip: '亡灵', baseCoins: 4, rarity: Rarity.RARE , category: IconCategory.ABILITY },
        // { icon: '👻', tip: '幽灵', baseCoins: 4, rarity: Rarity.RARE, category: IconCategory.ABILITY },


        // 星座符号类
        // { icon: '♈', tip: '白羊座', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.ZODIAC },
        // { icon: '♉', tip: '金牛座', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.ZODIAC },
        // { icon: '♊', tip: '双子座', baseCoins: 9, rarity: Rarity.EPIC, category: IconCategory.ZODIAC },
        // { icon: '♋', tip: '巨蟹座', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.ZODIAC },
        // { icon: '♌', tip: '狮子座', baseCoins: 16, rarity: Rarity.LEGENDARY, category: IconCategory.ZODIAC },
        // { icon: '♍', tip: '处女座', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.ZODIAC },
        // { icon: '♎', tip: '天秤座', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.ZODIAC },
        // { icon: '♏', tip: '天蝎座', baseCoins: 17, rarity: Rarity.LEGENDARY, category: IconCategory.ZODIAC },

        // 魔法符文类
        // { icon: '✡️', tip: '六芒星', baseCoins: 15, rarity: Rarity.LEGENDARY, category: IconCategory.RUNE },
        // { icon: '🕯️', tip: '魔法烛台', baseCoins: 2, rarity: Rarity.COMMON, category: IconCategory.RUNE },
        // { icon: '⚜️', tip: '圣印', baseCoins: 8, rarity: Rarity.EPIC, category: IconCategory.RUNE },
        // { icon: '🔯', tip: '法阵', baseCoins: 9, rarity: Rarity.EPIC, category: IconCategory.RUNE },
        // { icon: '☯️', tip: '阴阳符', baseCoins: 6, rarity: Rarity.RARE, category: IconCategory.RUNE },
        // { icon: '⚛️', tip: '元素符文', baseCoins: 7, rarity: Rarity.EPIC, category: IconCategory.RUNE },
        // { icon: '🔮', tip: '预言符文', baseCoins: 16, rarity: Rarity.LEGENDARY, category: IconCategory.RUNE },
        // { icon: '📜', tip: '古代卷轴', baseCoins: 4, rarity: Rarity.RARE, category: IconCategory.RUNE },
    ];

    let isPanelVisible = false;

    function checkMermaidInteraction(grid, row, col, highlightGroups) {
        const currentCard = grid[row][col];
        if (!currentCard || currentCard.icon !== '🧜‍♀️') return false;

        // 检查八个方向的相邻格子
        const directions = [
            [-1, -1], [-1, 0], [-1, 1],
            [0, -1],           [0, 1],
            [1, -1],  [1, 0],  [1, 1]
        ];

        const marineNeighbors = [];
        let availableSpots = 0;

        // 检查周围的海洋生物和可用格子数
        for (const [dx, dy] of directions) {
            const newRow = row + dx;
            const newCol = col + dy;

            // 检查位置是否在网格内
            if (newRow >= 0 && newRow < 5 && newCol >= 0 && newCol < 5) {
                availableSpots++;
                const neighbor = grid[newRow][newCol];
                if (neighbor && neighbor.category === IconCategory.MARINE) {
                    const element = document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`);
                    marineNeighbors.push({ card: neighbor, element: element });
                }
            }
        }

        // 如果所有可用格子都是海洋生物
        if (marineNeighbors.length === availableSpots) {
            const currentElement = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);

            // 将当前卡牌和相邻卡牌加入高亮组
            const group = [
                { card: currentCard, element: currentElement },
                ...marineNeighbors
            ];
            highlightGroups.push(group);

            // 添加巨鲸到手牌
            const whaleCard = iconData.find(card => card.icon === '🐋');
            if (whaleCard) {
                handCards.push({...whaleCard});
                setTimeout(() => {
                    showFloatingText(currentElement, '✨ 召唤巨鲸!');
                    updateHandCards();
                }, 500);
            }

            return true;
        }

        return false;
    }

    function checkMusicInteraction(grid, row, col, highlightGroups) {
        const currentSlot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
        const currentCard = currentSlot?.__card;

        // 检查是否是乐谱
        if (!currentCard || currentCard.icon !== '🎼') return false;

        const directions = [
            [-1,-1], [-1,0], [-1,1],
            [0,-1],         [0,1],
            [1,-1],  [1,0],  [1,1]
        ];

        const musicElements = [];

        // 检查周围8个方向的音符
        for (const [dx, dy] of directions) {
            const newRow = row + dx;
            const newCol = col + dy;

            if (newRow >= 0 && newRow < 5 && newCol >= 0 && newCol < 5) {
                const targetSlot = document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`);
                const targetCard = targetSlot?.__card;

                if (targetCard && (targetCard.icon === '🎵' || targetCard.icon === '🎶')) {
                    musicElements.push({
                        row: newRow,
                        col: newCol,
                        slot: targetSlot,
                        card: targetCard
                    });
                }
            }
        }

        if (musicElements.length > 0) {
            // 处理每个音乐元素
            musicElements.forEach(({slot: targetSlot, card: targetCard}) => {
                // 显示破坏效果
                showMusicDestructionEffect(currentSlot, targetSlot);
                // 增加乐谱基础金币
                currentCard.baseCoins += 1;

                // 更新乐谱提示文本
                currentSlot.setAttribute('data-tooltip',
                    `乐谱 (基础金币:${currentCard.baseCoins})`);

                // 清除目标格子
                targetSlot.innerHTML = '';
                targetSlot.removeAttribute('data-tooltip');
                targetSlot.__card = null;
            });

            // 检查是否达到生成精灵的条件
            if (Math.floor(currentCard.baseCoins / 12) >
                Math.floor((currentCard.baseCoins - musicElements.length) / 12)) {
                // 添加精灵到手牌
                const fairyCard = {...iconData.find(card => card.icon === '🧚')};
                if (fairyCard) {
                    handCards.push(fairyCard);
                    showFloatingText(currentSlot, '✨ 获得精灵! ✨');
                }
            }

            highlightGroups.push([currentSlot]);
            return true;
        }

        return false;
    }

    function showMusicDestructionEffect(sourceSlot, targetSlot) {
        // 创建特效容器
        const effectContainer = document.createElement('div');
        effectContainer.className = 'music-effect';
        effectContainer.style.position = 'absolute';
        effectContainer.style.pointerEvents = 'none';
        effectContainer.style.zIndex = '9999';

        // 添加到列容器中
        const column = sourceSlot.closest('.column');
        column.appendChild(effectContainer);

        // 获取相对位置
        const columnRect = column.getBoundingClientRect();
        const sourceRect = sourceSlot.getBoundingClientRect();
        const targetRect = targetSlot.getBoundingClientRect();

        // 计算相对坐标
        const startX = sourceRect.left - columnRect.left + sourceRect.width / 2;
        const startY = sourceRect.top - columnRect.top + sourceRect.height / 2;
        const endX = targetRect.left - columnRect.left + targetRect.width / 2;
        const endY = targetRect.top - columnRect.top + targetRect.height / 2;

        // 创建音符线
        const line = document.createElement('div');
        line.className = 'music-line';
        const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
        line.style.cssText = `
            position: absolute;
            width: ${distance}px;
            left: ${startX}px;
            top: ${startY}px;
            transform-origin: left center;
            transform: rotate(${Math.atan2(endY - startY, endX - startX)}rad);
        `;
        effectContainer.appendChild(line);

        // 创建音乐文本效果
        const text = document.createElement('div');
        text.className = 'music-text';
        text.textContent = '♪ 破坏!';
        text.style.cssText = `
            position: absolute;
            left: ${endX}px;
            top: ${endY - 20}px;
            transform: translate(-50%, -50%);
        `;
        effectContainer.appendChild(text);

        // 添加破坏动画类
        targetSlot.classList.add('destroy-animation');

        // 立即处理音符移除
        const targetCard = targetSlot.__card;
        if (targetCard) {
            const cardIndex = handCards.findIndex(card =>
                card.icon === targetCard.icon && !card.used);
            if (cardIndex !== -1) {
                handCards[cardIndex].used = true;
            }
        }

        // 立即清除目标格子
        targetSlot.innerHTML = '';
        targetSlot.removeAttribute('data-tooltip');
        targetSlot.__card = null;

        // 更新手牌显示
        updateHandCards();

        // 延时移除效果
        setTimeout(() => {
            effectContainer.remove();
            targetSlot.classList.remove('destroy-animation');
        }, 1000);
    }

    // 添加更新手牌显示的函数
    function updateHandCards() {
        // 移除已使用的卡牌
        handCards = handCards.filter(card => !card.used);

        // 这里可以添加手牌UI更新的逻辑
        // 如果有相关的UI元素需要更新
    }

    // 添加破坏动画样式
    const musicDestructionStyles = `
    .music-effect {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
    }

    .music-line {
        height: 2px;
        background: linear-gradient(90deg, #ff69b4, #00bcd4);
        z-index: 9999;
        animation: musicPulse 1s ease-in-out;
    }

    .music-text {
        color: #ff69b4;
        font-weight: bold;
        font-size: 16px;
        text-shadow: 0 0 5px rgba(0,0,0,0.8);
        z-index: 9999;
        animation: musicTextFloat 1.5s ease-out;
        white-space: nowrap;
    }

    .destroy-animation {
        animation: destroyPulse 1s ease-in-out;
    }

    @keyframes musicPulse {
        0% { opacity: 0; height: 1px; }
        50% { opacity: 1; height: 3px; }
        100% { opacity: 0; height: 2px; }
    }

    @keyframes musicTextFloat {
        0% { opacity: 0; transform: translate(-50%, -30%); }
        20% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; transform: translate(-50%, -100%); }
    }

    @keyframes destroyPulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.5; }
        100% { transform: scale(1); opacity: 0; }
    }`;

    function toggleUpgradePanel() {
        const panel = document.getElementById('upgrade-panel');
        isPanelVisible = !isPanelVisible;
        panel.style.display = isPanelVisible ? 'block' : 'none';
    }

    function hideUpgradePanel() {
        isPanelVisible = false;
        document.getElementById('upgrade-panel').style.display = 'none';
        document.getElementById('show-upgrade-button').style.display = 'block';
    }

    function giveUpgrade() {
        hasSelectedUpgrade = true; // 标记已完成选择
        document.getElementById('show-upgrade-button').style.display = 'none';
        isPanelVisible = false;
        document.getElementById('upgrade-panel').style.display = 'none';
        document.body.classList.remove('upgrade-panel-visible'); // 添加这行
        clearNoticeChoose();
    }

    function showUpgradeChoices() {
        const panel = document.getElementById('upgrade-panel');
        const container = document.getElementById('upgrade-options');
        container.innerHTML = '';

        // 根据是否有待处理的高稀有度选择来决定显示哪种选项
        if (window.pendingRareUpgrades > 0) {
            // 高稀有度3选1
            const rareCards = filteredIconData.filter(card =>
                card.rarity === Rarity.EPIC || card.rarity === Rarity.LEGENDARY
            );

            // 随机选择3张高稀有度卡牌
            const choices = [];
            while (choices.length < 3 && rareCards.length > 0) {
                const index = Math.floor(Math.random() * rareCards.length);
                choices.push({...rareCards[index]});
                rareCards.splice(index, 1);
            }

            // 创建选项卡片
            choices.forEach(card => {
                const choice = document.createElement('div');
                choice.className = 'upgrade-card';
                choice.innerHTML = `
                    <div class="icon">${card.icon}</div>
                    <div>${card.tip}</div>
                    <div style="color: #FFD700">${card.rarity}</div>
                    <div>基础金币: ${card.baseCoins}</div>
                `;

                choice.onclick = () => {
                    handCards.push(card);
                    if (window.pendingRareUpgrades > 0) {
                        window.pendingRareUpgrades--;
                    }
                    giveUpgrade();
                    showFloatingText(choice, '✨ 获得卡牌!');

                    showUpgradeChoices();
                };

                container.appendChild(choice);
            });

        } else {
            // 常规3选1(使用当前挑战的概率)
            const currentProbs = challenges[currentChallenge];
            const cardPool = [...filteredIconData];
            const choices = [];

            // 获取3个随机选项
            for (let i = 0; i < 3; i++) {
                if (cardPool.length === 0) break;

                const roll = Math.random()*100;
                let card;

                if (roll < currentProbs.legendaryChance) {
                    card = getRandomCardByRarity(cardPool, Rarity.legendaryChance);
                } else if (roll < currentProbs.legendaryChance + currentProbs.epicChance) {
                    card = getRandomCardByRarity(cardPool, Rarity.EPIC);
                } else if (roll < currentProbs.legendaryChance + currentProbs.epicChance + currentProbs.rareChance) {
                    card = getRandomCardByRarity(cardPool, Rarity.RARE);
                } else {
                    card = getRandomCardByRarity(cardPool, Rarity.COMMON);
                }

                if (card) {
                    choices.push({...card});
                }
            }

            // 创建选项卡片
            choices.forEach(card => {
                const choice = document.createElement('div');
                choice.className = 'upgrade-card';
                choice.innerHTML = `
                <div class="icon">${card.icon}</div>
                <div>${card.tip}</div>
                <div style="color: ${getRarityColor(card.rarity)}">${card.rarity}</div>
                <div>基础金币: ${card.baseCoins}</div>
            `;

                choice.onclick = () => {
                    handCards.push(card);
                    // 更新构筑次数
                    if (window.deckBuildingCount > 0) {
                        window.deckBuildingCount--;

                        if (window.deckBuildingCount > 0) {
                            // 更新标题
                            const panelTitle = document.querySelector('#upgrade-panel h2');
                            panelTitle.textContent = `🎮 初始构筑 (剩余${window.deckBuildingCount}次)`;
                            // 刷新新的选项
                            showUpgradeChoices();
                        } else {
                            // 构筑完成
                            const upgradePanel = document.getElementById('upgrade-panel');
                            upgradePanel.style.display = 'none';
                            document.getElementById('start-button').disabled = false;
                            showDeckCompleteMessage();
                        }
                    } else {
                        // 非初始构筑的情况
                        giveUpgrade();
                        showFloatingText(choice, '✨ 获得卡牌!');
                    }
                };

                container.appendChild(choice);
            });
        }

        panel.style.display = 'block';
        document.getElementById('show-upgrade-button').style.display = 'none';
    }

    // 辅助函数：根据稀有度获取随机卡牌
    function getRandomCardByRarity(cardPool, rarity) {
        const cards = cardPool.filter(card => card.rarity === rarity);
        if (cards.length === 0) return null;

        const index = Math.floor(Math.random() * cards.length);
        const selected = cards[index];

        // 从卡池中移除已选卡牌
        const poolIndex = cardPool.findIndex(card => card.icon === selected.icon);
        if (poolIndex !== -1) {
            cardPool.splice(poolIndex, 1);
        }

        return selected;
    }

    // 辅助函数：获取稀有度对应的颜色
    function getRarityColor(rarity) {
        switch (rarity) {
            case Rarity.LEGENDARY: return '#FFD700'; // 金色
            case Rarity.EPIC: return '#9370DB';      // 紫色
            case Rarity.RARE: return '#4169E1';      // 蓝色
            case Rarity.COMMON: return '#90EE90';    // 绿色
            default: return '#FFFFFF';
        }
    }

    const columns = Array.from({ length: 5 }, (_, i) => document.getElementById(`col-${i}`));
    const rows = 5;

    // 初始手牌
    let handCards = [
        // { icon: '🗝️', tip: '开锁', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.Key },
        // { icon: '📦', tip: '宝箱', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        // { icon: '📦', tip: '宝箱', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        // { icon: '📦', tip: '宝箱', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        // { icon: '📦', tip: '宝箱', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        // { icon: '📦', tip: '宝箱', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        // { icon: '📦', tip: '宝箱', baseCoins: 1,delCoins:30, rarity: Rarity.COMMON, category: IconCategory.Box },
        { icon: '🏚️', tip: '障碍', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.BUILDING },
        { icon: '🦊', tip: '狐狸', baseCoins: 1, rarity: Rarity.COMMON, category: IconCategory.ANIMAL },
    ];

    // 修改 fillColumn 函数，添加建筑固定逻辑
    function fillColumn(col) {
        col.innerHTML = '';
        const colIndex = parseInt(col.dataset.index);

        // 如果是第一列，创建临时栈并打乱
        if(colIndex === 0) {
            // 创建25个格子的数组
            let slots = new Array(25).fill(null);

            // 使用过滤后的卡牌库
            let tempStack = [...handCards];

            // 记录当前所有建筑的位置
            let buildingPositions = [];
            document.querySelectorAll('.slot').forEach(slot => {
                if (slot.__card && slot.__card.category === IconCategory.BUILDING) {
                    const row = parseInt(slot.dataset.row);
                    const col = parseInt(slot.dataset.col);
                    buildingPositions.push({
                        row: row,
                        col: col,
                        card: slot.__card
                    });
                }
            });

            // 先将建筑放回原位置
            buildingPositions.forEach(building => {
                const slotIndex = building.row * columns.length + building.col;
                slots[slotIndex] = building.card;

                // 从临时栈中移除该建筑卡牌
                const buildingIndex = tempStack.findIndex(card =>
                    card.icon === building.card.icon &&
                    card.category === building.card.category
                );
                if (buildingIndex !== -1) {
                    tempStack.splice(buildingIndex, 1);
                }
            });

            // Fisher-Yates 洗牌算法打乱剩余卡牌
            for(let i = tempStack.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [tempStack[i], tempStack[j]] = [tempStack[j], tempStack[i]];
            }

            // 随机分配剩余卡牌到空格子
            let availableSlots = [];
            for(let i = 0; i < 25; i++) {
                if(slots[i] === null) {
                    availableSlots.push(i);
                }
            }

            tempStack.forEach(card => {
                if(availableSlots.length > 0) {
                    // 随机选择一个可用格子
                    const randomIndex = Math.floor(Math.random() * availableSlots.length);
                    const slotIndex = availableSlots[randomIndex];

                    // 将卡牌放入选中的格子
                    slots[slotIndex] = card;

                    // 从可用格子中移除已使用的格子
                    availableSlots.splice(randomIndex, 1);
                }
            });

            // 保存打乱后的结果供其他列使用
            window.currentSlots = slots;
        }

        // 渲染当前列的格子
        for (let i = 0; i < rows; i++) {
            const slot = document.createElement('div');
            slot.className = 'slot';
            slot.setAttribute('data-row', i);
            slot.setAttribute('data-col', colIndex);

            const slotIndex = i * columns.length + colIndex;
            const card = window.currentSlots[slotIndex];

            if (card) {
                slot.innerHTML = `
                    <div class="card-icon">${card.icon}</div>
                    <div class="coin-indicator">+${card.baseCoins}💰</div>
                `;
                slot.setAttribute('data-tooltip', `${card.tip} (${card.rarity})`);

                // 如果是建筑，添加特殊样式
                if (card.category === IconCategory.BUILDING) {
                    slot.classList.add('building-slot');
                }

                // 在slot元素上存储对卡牌的引用
                slot.__card = card;
            } else {
                slot.innerHTML = '';
            }

            col.appendChild(slot);
        }
    }

    const buildingStyles = `
    .building-slot {
        border: 2px solid #8e44ad;
        background: rgba(142, 68, 173, 0.1);
    }

    .building-slot .card-icon {
        transform: scale(1.1);
        transition: transform 0.3s ease;
    }

    .building-slot:hover .card-icon {
        transform: scale(1.2);
    }
    `;

    let hasSelectedUpgrade = false; // 添加选择状态标记

    function startSlots() {
        // 如果未完成上一轮选择，禁止开始
        if (!hasSelectedUpgrade) {
            noticeChoose();
            toggleUpgradePanel();
            return;
        }

        // 如果有待处理的高稀有度选择
        if (window.pendingRareUpgrades > 0) {
            // 显示选择面板
            showUpgradeChoices();
            return;
        }

        // 如果未完成上一轮选择,禁止开始
        if(!hasSelectedUpgrade) {
            noticeChoose();
            toggleUpgradePanel();
            return;
        }

        if (remainingSlots <= 0) {
            checkChallengeResult();
            return;
        }

        remainingSlots--;
        totalSlots++;
        updateRemainingSlots();

        clearHighlights();
        hasSelectedUpgrade = false; // 重置选择状态

        columns.forEach((col, index) => {
            let interval = setInterval(() => fillColumn(col), 100);
            setTimeout(() => {
                clearInterval(interval);
                fillColumn(col);
                if (index === columns.length - 1) {
                    setTimeout(() => {
                        checkWin();

                        // 处理所有格子的生产效果
                        const allSlots = document.querySelectorAll('.slot');
                        allSlots.forEach(slot => {
                            if (slot.__card) {
                                processProduction(slot.__card, slot);
                            }
                        });
                        setTimeout(showUpgradeChoices, 500);
                    }, 500);
                }
            }, 1000 + index * 500);
        });
    }

    function noticeChoose(){
        const panel = document.getElementById('upgrade-panel');
        const skipButton = panel.querySelector('.skip-button');
        // 使用直接样式设置
        panel.style.border = '3px solid #4a90e2';
        panel.style.boxShadow = '0 0 20px #4a90e2';
        panel.style.transition = 'all 0.3s ease';

        skipButton.style.background = '#4a90e2';
        skipButton.style.transform = 'scale(1.1)';
        skipButton.style.transition = 'all 0.3s ease';
    }

    function clearNoticeChoose(){
        const panel = document.getElementById('upgrade-panel');
        const skipButton = panel.querySelector('.skip-button');
        // 使用直接样式设置
        panel.style.border = '';
        panel.style.boxShadow = '';
        panel.style.transition = '';

        skipButton.style.background = '';
        skipButton.style.transform = '';
        skipButton.style.transition = '';
    }

    // 新增函数：检查水与植物相邻
    function checkWaterPlantInteraction(grid, row, col, highlightGroups) {
        const currentCard = grid[row][col];
        if (!currentCard) return;

        // 检查是否是水
        if (currentCard.icon === '💧' && currentCard.category === IconCategory.WEATHER) {
            // 检查八个方向的相邻格子（包括对角线）
            const directions = [
                { dr: -1, dc: 0 },  // 上
                { dr: 1, dc: 0 },   // 下
                { dr: 0, dc: -1 },  // 左
                { dr: 0, dc: 1 },   // 右
                { dr: -1, dc: -1 }, // 左上
                { dr: -1, dc: 1 },  // 右上
                { dr: 1, dc: -1 },  // 左下
                { dr: 1, dc: 1 }    // 右下
            ];

            const foundPlants = [];  // 存储找到的所有植物
            const waterSlot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);

            // 查找周围所有的植物
            for (const dir of directions) {
                const newRow = row + dir.dr;
                const newCol = col + dir.dc;

                // 检查边界
                if (newRow < 0 || newRow >= rows || newCol < 0 || newCol >= columns.length) {
                    continue;
                }

                const adjacentCard = grid[newRow][newCol];
                if (adjacentCard && adjacentCard.category === IconCategory.PLANT) {
                    // 找到植物
                    const plantSlot = document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`);
                    foundPlants.push({
                        card: adjacentCard,
                        row: newRow,
                        col: newCol,
                        slot: plantSlot
                    });
                }
            }

            // 如果找到了植物，处理所有植物
            if (foundPlants.length > 0) {
                // 20%概率触发成长效果
                if (Math.random() < 0.2) {
                    // 将水添加到高亮组
                    const highlightGroup = [{ row, col }];  // 水的位置

                    // 将所有植物添加到高亮组
                    foundPlants.forEach(plant => {
                        highlightGroup.push({ row: plant.row, col: plant.col });
                    });

                    // 添加到高亮组
                    highlightGroups.push(highlightGroup);

                    // 处理特效和成长
                    setTimeout(() => {
                        // 添加基础金币
                        addCoins(currentCard.baseCoins);

                        // 为每个植物显示成长特效并创建新植物
                        foundPlants.forEach((plant, index) => {
                            // 延迟显示效果，创造连锁反应的视觉效果
                            setTimeout(() => {
                                // 显示成长线
                                showGrowthEffect(waterSlot, plant.slot);

                                // 创建更高稀有度的植物
                                const newPlant = getHigherRarityPlant(plant.card);

                                // 从手牌中移除原植物
                                removeCardFromHand(plant.card);

                                // 在原植物位置生成新植物
                                setTimeout(() => {
                                    spawnNewPlant(plant.row, plant.col, newPlant);
                                }, 300);

                            }, index * 200); // 每个植物之间间隔200ms
                        });

                        // 从手牌中移除水
                        setTimeout(() => {
                            removeCardFromHand(currentCard);
                            console.log(`水滋养了${foundPlants.length}株植物！剩余手牌数量：${handCards.length}`);
                        }, foundPlants.length * 200 + 300);

                    }, 500);
                }
            }
        }
    }

    // 获取更高稀有度的植物（严格按照稀有度升级）
    function getHigherRarityPlant(originalPlant) {
        // 稀有度升级路径
        const rarityUpgrade = {
            [Rarity.COMMON]: Rarity.RARE,
            [Rarity.RARE]: Rarity.EPIC,
            [Rarity.EPIC]: Rarity.LEGENDARY,
            [Rarity.LEGENDARY]: Rarity.LEGENDARY
        };

        // 确定下一个稀有度级别
        const nextRarity = rarityUpgrade[originalPlant.rarity];

        // 从过滤后的卡牌库中选择符合下一级稀有度的植物卡牌
        const availablePlants = filteredIconData.filter(card =>
            card.category === IconCategory.PLANT &&
            card.rarity === nextRarity
        );

        // 如果有可用的更高稀有度植物，随机选择一个
        if (availablePlants && availablePlants.length > 0) {
            return availablePlants[Math.floor(Math.random() * availablePlants.length)];
        }

        // 如果没有更高稀有度的植物，返回原植物
        return originalPlant;
    }

    // 从手牌中移除卡牌
    function removeCardFromHand(card) {
        const index = handCards.findIndex(c =>
            c.icon === card.icon &&
            c.category === card.category
        );

        if (index !== -1) {
            handCards.splice(index, 1);
        }
    }

    // 在指定位置生成新植物
    function spawnNewPlant(row, col, plant) {
        const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
        if (!slot) return;

        // 清空原有内容
        slot.innerHTML = '';
        slot.removeAttribute('data-tooltip');
        slot.classList.remove('highlight');

        // 添加新植物
        slot.innerHTML = `
        <div class="icon">${plant.icon}</div>
        <div class="coin-indicator">+${plant.baseCoins}💰</div>
    `;
        slot.setAttribute('data-tooltip', `${plant.tip}`);

        // 保存引用
        slot.__card = plant;

        // 添加出场动画
        slot.classList.add('grow-animation');
        setTimeout(() => {
            slot.classList.remove('grow-animation');

            // 触发新植物的金币效果
            addCoins(plant.baseCoins, slot);
        }, 500);

        // 将新植物添加到手牌中
        handCards.push(plant);
    }

    // 显示成长特效
    function showGrowthEffect(waterSlot, plantSlot) {
        if (!waterSlot || !plantSlot) return;

        // 创建连接线特效
        const line = document.createElement('div');
        line.className = 'growth-line';
        document.body.appendChild(line);

        // 获取两个元素的位置
        const waterRect = waterSlot.getBoundingClientRect();
        const plantRect = plantSlot.getBoundingClientRect();

        // 计算线的起点和终点
        const startX = waterRect.left + waterRect.width / 2;
        const startY = waterRect.top + waterRect.height / 2;
        const endX = plantRect.left + plantRect.width / 2;
        const endY = plantRect.top + plantRect.height / 2;

        // 计算线的长度和角度
        const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
        const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;

        // 设置线的样式
        line.style.width = `${length}px`;
        line.style.left = `${startX}px`;
        line.style.top = `${startY}px`;
        line.style.transform = `rotate(${angle}deg)`;

        // 创建成长提示
        const growthText = document.createElement('div');
        growthText.className = 'growth-text';
        growthText.textContent = '植物成长!';
        growthText.style.left = `${(startX + endX) / 2}px`;
        growthText.style.top = `${(startY + endY) / 2 - 20}px`;
        document.body.appendChild(growthText);

        // 设置动画结束后移除元素
        setTimeout(() => {
            line.remove();
            growthText.remove();
        }, 1500);
    }

    function clearHighlights() {
        document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
    }

    // 修改 checkWin 函数，增加宝箱与钥匙相邻时的特殊消除逻辑
    function checkWin() {
        const grid = [];
        const processed = new Set(); // 用于记录已处理的位置

        // 构建网格数据
        for (let row = 0; row < rows; row++) {
            grid[row] = [];
            for (let col = 0; col < columns.length; col++) {
                const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
                grid[row][col] = slot?.__card;
            }
        }

        const highlightGroups = [];
        let delay = 0;

        // 遍历格子检查三消效果
        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < columns.length; col++) {
                const key = `${row},${col}`;
                if (!processed.has(key) && grid[row][col]?.category === IconCategory.FESTIVAL) {
                    if (checkFestivalInteraction(grid, row, col, highlightGroups)) {
                        processed.add(key); // 标记当前位置已处理
                        // 标记相邻的节日元素为已处理
                        const directions = [
                            [-1, -1], [-1, 0], [-1, 1],
                            [0, -1],           [0, 1],
                            [1, -1],  [1, 0],  [1, 1]
                        ];
                        for (const [dx, dy] of directions) {
                            const newRow = row + dx;
                            const newCol = col + dy;
                            if (newRow >= 0 && newRow < 5 && newCol >= 0 && newCol < 5) {
                                const newKey = `${newRow},${newCol}`;
                                processed.add(newKey);
                            }
                        }
                    }
                }
            }
        }

        // 遍历所有格子，处理金币效果
        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < columns.length; col++) {
                const currentCard = grid[row][col];
                if (!currentCard) continue;

                // 检查音乐符号与其他符号相邻
                checkMusicInteraction(grid, row, col, highlightGroups);

                // 检查宝箱与钥匙相邻
                checkKeyBoxPair(grid, row, col, highlightGroups);
                // 检查水与植物相邻
                checkWaterPlantInteraction(grid, row, col, highlightGroups);
                // 猫鼠游戏
                checkCatMouseInteraction(grid, row, col, highlightGroups);
                // 人鱼公主
                checkMermaidInteraction(grid, row, col, highlightGroups);

                // 宝石重生
                checkGemRespawn(grid, row, col, grid[row][col]);

                // 获取基础金币
                const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
                if (slot && currentCard) {
                    setTimeout(() => {
                        addCoins(currentCard.baseCoins, slot);
                    }, delay);
                    delay += 100;
                }
            }
        }

        // 处理匹配组的高亮效果
        let highlightDelay = delay; // 在所有金币动画完成后再显示高亮
        highlightGroups.forEach(group => {
            setTimeout(() => {
                group.forEach(pos => {
                    const slot = document.querySelector(`.slot[data-row="${pos.row}"][data-col="${pos.col}"]`);
                    if (slot) slot.classList.add('highlight');
                });
            }, highlightDelay);
            highlightDelay += 300;
        });
    }

    // 新增函数：检查宝箱与钥匙相邻
    function checkKeyBoxPair(grid, row, col, highlightGroups) {
        const currentCard = grid[row][col];
        if (!currentCard) return;

        // 检查是否是钥匙
        if (currentCard.category === IconCategory.Key) {
            // 检查八个方向的相邻格子（包括对角线）
            const directions = [
                { dr: -1, dc: 0 },  // 上
                { dr: 1, dc: 0 },   // 下
                { dr: 0, dc: -1 },  // 左
                { dr: 0, dc: 1 },   // 右
                { dr: -1, dc: -1 }, // 左上
                { dr: -1, dc: 1 },  // 右上
                { dr: 1, dc: -1 },  // 左下
                { dr: 1, dc: 1 }    // 右下
            ];

            const foundBoxes = [];  // 存储找到的所有宝箱
            const keySlot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);

            // 查找周围所有的宝箱
            for (const dir of directions) {
                const newRow = row + dir.dr;
                const newCol = col + dir.dc;

                // 检查边界
                if (newRow < 0 || newRow >= rows || newCol < 0 || newCol >= columns.length) {
                    continue;
                }

                const adjacentCard = grid[newRow][newCol];
                if (adjacentCard && adjacentCard.category === IconCategory.Box) {
                    // 找到宝箱
                    const boxSlot = document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`);
                    foundBoxes.push({
                        card: adjacentCard,
                        row: newRow,
                        col: newCol,
                        slot: boxSlot
                    });
                }
            }

            // 如果找到了宝箱，处理所有宝箱
            if (foundBoxes.length > 0) {
                // 将钥匙和所有宝箱添加到高亮组
                const highlightGroup = [{ row, col }]; // 钥匙位置

                // 添加所有宝箱位置
                foundBoxes.forEach(box => {
                    highlightGroup.push({ row: box.row, col: box.col });
                });

                // 添加到高亮组
                highlightGroups.push(highlightGroup);

                // 处理特效和得分
                let totalDelCoins = 0;
                foundBoxes.forEach((box, index) => {
                    // 累计宝箱的额外奖励
                    if (box.card.delCoins) {
                        totalDelCoins += box.card.delCoins;
                    }

                    // 为每个宝箱显示连接线
                    setTimeout(() => {
                        showUnlockEffect(keySlot, box.slot);
                    }, index * 200); // 错开特效显示时间
                });

                // 显示总共获得的额外奖励
                if (totalDelCoins > 0) {
                    setTimeout(() => {
                        addCoins(totalDelCoins);
                        showFloatingText(keySlot, `开启${foundBoxes.length}个宝箱! +${totalDelCoins}`);
                    }, 500);
                }

                // 从手牌中移除钥匙和所有宝箱
                setTimeout(() => {
                    // 移除钥匙
                    const keyIndex = handCards.findIndex(card =>
                        card.icon === currentCard.icon &&
                        card.category === currentCard.category
                    );

                    if (keyIndex !== -1) {
                        handCards.splice(keyIndex, 1);
                    }

                    // 移除所有找到的宝箱
                    foundBoxes.forEach(box => {
                        const boxIndex = handCards.findIndex(card =>
                            card.icon === box.card.icon &&
                            card.category === box.card.category
                        );

                        if (boxIndex !== -1) {
                            handCards.splice(boxIndex, 1);
                        }
                    });

                    console.log(`钥匙开启了${foundBoxes.length}个宝箱！剩余手牌数量：${handCards.length}`);
                }, 1000);
            }
        }
    }

    // 显示开锁特效
    function showUnlockEffect(keySlot, boxSlot) {
        if (!keySlot || !boxSlot) return;

        // 创建连接线特效
        const line = document.createElement('div');
        line.className = 'unlock-line';
        document.body.appendChild(line);

        // 获取两个元素的位置
        const keyRect = keySlot.getBoundingClientRect();
        const boxRect = boxSlot.getBoundingClientRect();

        // 计算线的起点和终点
        const startX = keyRect.left + keyRect.width / 2;
        const startY = keyRect.top + keyRect.height / 2;
        const endX = boxRect.left + boxRect.width / 2;
        const endY = boxRect.top + boxRect.height / 2;

        // 计算线的长度和角度
        const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
        const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;

        // 设置线的样式
        line.style.width = `${length}px`;
        line.style.left = `${startX}px`;
        line.style.top = `${startY}px`;
        line.style.transform = `rotate(${angle}deg)`;

        // 设置动画结束后移除元素
        setTimeout(() => {
            line.remove();
        }, 1500);
    }

    // 显示浮动文本
    function showFloatingText(element, text) {
        const unlockText = document.createElement('div');
        unlockText.className = 'unlock-text';
        unlockText.textContent = text;

        const rect = element.getBoundingClientRect();
        unlockText.style.left = `${rect.left + rect.width / 2}px`;
        unlockText.style.top = `${rect.top - 20}px`;

        document.body.appendChild(unlockText);

        // 设置动画结束后移除元素
        setTimeout(() => {
            unlockText.remove();
        }, 1500);
    }


    // 添加开锁特效的样式
    const unlockStyles = `
    .unlock-line {
        position: fixed;
        height: 3px;
        background: linear-gradient(90deg, gold, #ffeb3b);
        transform-origin: left;
        z-index: 100;
        animation: unlockPulse 0.8s ease-in-out;
    }

    .unlock-text {
        position: fixed;
        color: gold;
        font-weight: bold;
        font-size: 16px;
        text-shadow: 0 0 5px rgba(0,0,0,0.8);
        transform: translate(-50%, -50%);
        z-index: 101;
        animation: unlockTextFloat 1.5s ease-out;
        white-space: nowrap;
    }

    @keyframes unlockPulse {
        0% { opacity: 0; height: 1px; }
        50% { opacity: 1; height: 4px; }
        100% { opacity: 0; height: 2px; }
    }

    @keyframes unlockTextFloat {
        0% { opacity: 0; transform: translate(-50%, 0); }
        20% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; transform: translate(-50%, -30px); }
    }
    `;

    // 金币池代码
    let coinCount = 0;

    // 初始化金币池
    function initCoinPool() {
        updateCoinDisplay();
    }

    // 更新金币显示
    function updateCoinDisplay() {
        document.getElementById('coin-count').textContent = coinCount;
    }

    // 添加金币并显示动画
    function addCoins(amount, sourceElement) {
        // 高亮金币池图标
        const coinIcon = document.querySelector('.coin-icon');
        coinIcon.classList.add('coin-highlight');

        // 在指定时间后移除高亮
        setTimeout(() => {
            coinIcon.classList.remove('coin-highlight');
        }, 1500);

        // 创建飞行金币动画
        if (sourceElement) {
            createFlyingCoin(sourceElement);
        }

        // 增加金币数量
        coinCount += amount;
        updateCoinDisplay();
    }

    // 创建飞向金币池的金币动画
    function createFlyingCoin(sourceElement) {
        const coinPool = document.getElementById('coin-pool');
        const flyingCoin = document.createElement('div');
        flyingCoin.className = 'flying-coin';
        flyingCoin.textContent = '💰';
        document.body.appendChild(flyingCoin);

        // 获取起始位置和目标位置
        const sourceRect = sourceElement.getBoundingClientRect();
        const targetRect = coinPool.getBoundingClientRect();

        // 设置金币初始位置
        flyingCoin.style.left = `${sourceRect.left + sourceRect.width/2}px`;
        flyingCoin.style.top = `${sourceRect.top + sourceRect.height/2}px`;

        // 动画目标位置
        const targetX = targetRect.left + targetRect.width/2;
        const targetY = targetRect.top + targetRect.height/2;

        // 使用Web Animations API创建飞行动画
        flyingCoin.animate([
            { transform: 'translate(0, 0) scale(1)', opacity: 1 },
            { transform: `translate(${targetX - sourceRect.left - sourceRect.width/2}px,
                                ${targetY - sourceRect.top - sourceRect.height/2}px) scale(0.5)`,
                opacity: 0 }
        ], {
            duration: 800,
            easing: 'ease-out'
        }).onfinish = () => {
            flyingCoin.remove();
        };
    }

    //图鉴代码
    // 在 head 的 style 标签中添加以下样式
    // 在 body 的最合适位置添加以下按钮和容器
    const codexStyles = `
    #codex-button {
        position: fixed;
        left: 20px;
        top: 20px;
        padding: 10px 20px;
        background: #4a90e2;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        z-index: 1001;
    }

    #codex-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 1002;
        overflow-y: auto;
        padding: 20px;
    }

    #codex-content {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
    }

    .codex-category {
        color: #4a90e2;
        font-size: 24px;
        margin-top: 30px;
        padding-bottom: 10px;
        border-bottom: 2px solid #4a90e2;
    }

    .codex-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        padding: 20px 0;
    }

    .codex-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        color: white;
        transition: transform 0.2s;
        cursor: pointer;
        position: relative;
    }

    .codex-tip {
        display: none;
        position: absolute;
        bottom: 110%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        white-space: nowrap;
        z-index: 1003;
        animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateX(-50%) translateY(10px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .codex-tip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
    }

    .codex-tabs {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
    }

    .codex-tab {
        padding: 10px 20px;
        background: rgba(74, 144, 226, 0.2);
        border: 2px solid #4a90e2;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
    }

    .codex-tab.active {
        background: #4a90e2;
    }

    .codex-content-section {
        display: none;
    }

    .codex-content-section.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    #handcards-section {
        padding: 20px;
    }

    .handcards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }
    `;

    // 添加 HTML 结构
    const codexHTML = `
    <button id="codex-button">📖 图鉴</button>
    <div id="codex-container">
        <div id="codex-content"></div>
    </div>
    `;

    // 在 script 标签中添加以下 JavaScript 代码
    function initCodex() {
        // 添加样式
        const styleSheet = document.createElement('style');
        styleSheet.textContent = codexStyles;
        document.head.appendChild(styleSheet);

        // 添加 HTML
        const div = document.createElement('div');
        div.innerHTML = codexHTML;
        document.body.appendChild(div.firstElementChild);
        document.body.appendChild(div.firstElementChild);

        // 获取DOM元素
        const codexButton = document.getElementById('codex-button');
        const codexContainer = document.getElementById('codex-container');
        const codexContent = document.getElementById('codex-content');

        // 按类别整理图标数据
        const categories = {};
        iconData.forEach((item, index) => {
            let category = '';
            if (index < 8) {
                category = '武器装备类';
            } else if (index < 16) {
                category = '职业类';
            } else if (index < 24) {
                category = '状态效果类';
            } else if (index < 32) {
                category = '天气环境类';
            } else if (index < 40) {
                category = '动物伙伴类';
            } else if (index < 48) {
                category = '建筑设施类';
            } else if (index < 56) {
                category = '植物资源类';
            } else if (index < 64) {
                category = '魔法元素类';
            } else if (index < 72) {
                category = '道具消耗品';
            } else if (index < 80) {
                category = '宝物财富类';
            } else if (index < 88) {
                category = '效果增益类';
            } else if (index < 96) {
                category = '特殊能力类';
            } else if (index < 104) {
                category = '节日庆典类';
            } else if (index < 112) {
                category = '星座符号类';
            } else if (index < 120) {
                category = '音乐艺术类';
            } else if (index < 128) {
                category = '交通工具类';
            } else if (index < 136) {
                category = '水晶宝石类';
            } else if (index < 144) {
                category = '魔法符文类';
            } else if (index < 152) {
                category = '科技装备类';
            } else if (index < 160) {
                category = '海洋生物类';
            } else if (index < 168) {
                category = '神话生物类';
            } else if (index < 176) {
                category = '时空元素类';
            }

            if (!categories[category]) {
                categories[category] = [];
            }
            categories[category].push(item);
        });

        // 绑定按钮点击事件
        codexButton.addEventListener('click', toggleCodex);

        // 渲染图鉴内容
        function renderCodex() {
            codexContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="color: white; text-align: center; margin: 0;">图鉴系统</h1>
            <button id="close-codex" style="
                padding: 8px 16px;
                background: #e74c3c;
                border: none;
                border-radius: 4px;
                color: white;
                cursor: pointer;
                font-size: 16px;
                transition: all 0.3s;
            ">关闭图鉴</button>
        </div>
    <div class="codex-tabs">
        <div class="codex-tab active" data-tab="handcards">当前手牌</div>
        <div class="codex-tab" data-tab="codex">图鉴大全</div>
    </div>
    <div id="handcards-section" class="codex-content-section active">
        <h2 style="color: white; margin-bottom: 20px;">当前手牌列表</h2>
        <div class="handcards-grid"></div>
    </div>
    <div id="codex-section" class="codex-content-section">
        <div id="full-codex"></div>
    </div>
    `;

            const closeButton = codexContent.querySelector('#close-codex');
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    codexContainer.style.display = 'none';
                });

                closeButton.addEventListener('mouseover', () => {
                    closeButton.style.background = '#c0392b';
                });
                closeButton.addEventListener('mouseout', () => {
                    closeButton.style.background = '#e74c3c';
                });
            }

            // 渲染手牌列表
            const handcardsGrid = codexContent.querySelector('.handcards-grid');
            handCards.forEach(card => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'codex-item';
                itemDiv.innerHTML = `
            <div class="codex-icon">${card.icon}</div>
            <div class="codex-tip">${card.tip}$${card.baseCoins}</div>
        `;
                handcardsGrid.appendChild(itemDiv);
            });

            // 渲染完整图鉴
            const fullCodex = codexContent.querySelector('#full-codex');
            Object.entries(categories).forEach(([category, items]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'codex-category';
                categoryDiv.textContent = category;
                fullCodex.appendChild(categoryDiv);

                const grid = document.createElement('div');
                grid.className = 'codex-grid';

                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'codex-item';
                    itemDiv.innerHTML = `
                <div class="codex-icon">${item.icon}</div>
                <div class="codex-tip">${item.tip}</div>
            `;
                    grid.appendChild(itemDiv);
                });

                fullCodex.appendChild(grid);
            });

            // 添加 tab 切换事件
            const tabs = codexContent.querySelectorAll('.codex-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有 active 类
                    tabs.forEach(t => t.classList.remove('active'));
                    codexContent.querySelectorAll('.codex-content-section').forEach(section => {
                        section.classList.remove('active');
                    });

                    // 添加 active 类到当前选中的 tab 和对应内容
                    tab.classList.add('active');
                    const targetId = `${tab.dataset.tab}-section`;
                    document.getElementById(targetId).classList.add('active');
                });
            });

            // 添加提示框显示/隐藏逻辑
            document.querySelectorAll('.codex-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    document.querySelectorAll('.codex-tip').forEach(tip => {
                        tip.style.display = 'none';
                    });
                    const tip = item.querySelector('.codex-tip');
                    tip.style.display = 'block';
                    e.stopPropagation();
                });
            });
        }

        // 切换图鉴显示状态
        function toggleCodex() {
            const isVisible = codexContainer.style.display === 'block';
            codexContainer.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                renderCodex();
            }
        }

        // 点击空白处关闭图鉴
        codexContainer.addEventListener('click', (e) => {
            if (e.target.className == 'codex-grid') {
                codexContainer.style.display = 'none';
            }
        });

        // 绑定按钮点击事件
        codexButton.addEventListener('click', toggleCodex);
    }

    //图鉴代码

    // 金币右上角显示提示
    const styles = `
        .coin-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.7);
            color: gold;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 10;
        }

        /* 修改这里：当面板显示时显示金币提示 */
        .upgrade-panel-visible .coin-indicator {
            opacity: 1;
        }

        .slot:hover .coin-indicator {
            opacity: 1;
        }

        .slot.highlight .coin-indicator {
            background: rgba(0, 0, 0, 0.8);
        }
    `;

    const styleSheet = document.createElement('style');
    styleSheet.textContent = styles;
    document.head.appendChild(styleSheet);
    //挑战目标
    // 在 coin-pool div 下方添加挑战目标显示区域
    const challengeHTML = `
    <div id="challenge-container">
        <div class="challenge-header">
            <span>📋 租金挑战</span>
            <span id="remaining-slots">剩余次数: 5</span>
        </div>
        <div id="challenge-list"></div>
    </div>
    `;

    // 添加样式
    const challengeStyles = `
        #challenge-container {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
            min-width: 200px;
            z-index: 100;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .challenge-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            transition: all 0.3s;
        }

        .challenge-item.active {
            background: rgba(74, 144, 226, 0.2);
            border: 1px solid #4a90e2;
        }

        .challenge-item.completed {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid #27ae60;
        }

        .challenge-item.failed {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
        }
    `;

    // 挑战列表数据
    const challenges = [
        {
            slots: 5,
            coins: 150,
            completed: false,
            commonChance: 90,   // 70% 获得"优秀"品质奖励的概率
            rareChance: 8,    // 25% 获得"精良"品质奖励的概率
            epicChance: 2,    // 5% 获得"史诗"品质奖励的概率
            legendaryChance: 0   // 0% 获得"传说"品质奖励的概率
        },
        {
            slots: 7,
            coins: 350,
            completed: false,
            commonChance: 80,   // 50% 获得"优秀"品质奖励的概率
            rareChance: 15,    // 35% 获得"精良"品质奖励的概率
            epicChance: 5,    // 13% 获得"史诗"品质奖励的概率
            legendaryChance: 0 // 2% 获得"传说"品质奖励的概率
        },
        {
            slots: 10,
            coins: 660,
            completed: false,
            commonChance: 65,   // 30% 获得"优秀"品质奖励的概率
            rareChance: 20,     // 40% 获得"精良"品质奖励的概率
            epicChance: 13,     // 20% 获得"史诗"品质奖励的概率
            legendaryChance: 2  // 10% 获得"传说"品质奖励的概率
        },
        {
            slots: 13,
            coins: 1000,
            completed: false,
            commonChance: 30,
            rareChance: 40,     // 40% 获得"精良"品质奖励的概率
            epicChance: 25,     // 20% 获得"史诗"品质奖励的概率
            legendaryChance: 5  // 10% 获得"传说"品质奖励的概率
        },
    ];

    let currentChallenge = 0;
    let remainingSlots = challenges[0].slots;
    let totalSlots = 0;

    // 初始化挑战系统
    function initChallengeSystem() {
        // 添加 HTML 和样式
        document.body.insertAdjacentHTML('beforeend', challengeHTML);
        const styleSheet = document.createElement('style');
        styleSheet.textContent = challengeStyles;
        document.head.appendChild(styleSheet);

        // 渲染挑战列表
        renderChallenges();
        updateRemainingSlots();
    }

    // 渲染挑战列表
    function renderChallenges() {
        const list = document.getElementById('challenge-list');
        list.innerHTML = challenges.map((challenge, index) => `
        <div class="challenge-item ${index === currentChallenge ? 'active' : ''}
                                  ${challenge.completed ? 'completed' : ''}">
            <span>🎯 ${challenge.slots}次抽取</span>
            <span>💰 ${challenge.coins}金币</span>
        </div>
    `).join('');
    }

    // 更新剩余次数显示
    function updateRemainingSlots() {
        document.getElementById('remaining-slots').textContent =
            `剩余次数: ${remainingSlots}`;
    }


    // 检查挑战结果
    function checkChallengeResult() {
        const currentTarget = challenges[currentChallenge];

        if (coinCount >= currentTarget.coins) {
            // 完成挑战
            coinCount -= currentTarget.coins;
            updateCoinDisplay();
            currentTarget.completed = true;
            showChallengeComplete();

            // 进入下一个挑战
            if (currentChallenge < challenges.length - 1) {
                currentChallenge++;
                remainingSlots = challenges[currentChallenge].slots;
                renderChallenges();
                updateRemainingSlots();
            } else {
                showGameComplete();
            }
        } else {
            showGameOver();
        }
    }

    // 显示挑战完成消息
    function showChallengeComplete() {
        const message = document.createElement('div');
        message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(39, 174, 96, 0.9);
        padding: 20px;
        border-radius: 10px;
        color: white;
        font-size: 24px;
        z-index: 1000;
    `;
        message.textContent = '🎉 成功支付租金！进入下一阶段';
        document.body.appendChild(message);
        setTimeout(() => message.remove(), 2000);
    }

    // 显示游戏结束消息
    function showGameOver() {
        const message = document.createElement('div');
        message.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(231, 76, 60, 0.9);
        padding: 20px;
        border-radius: 10px;
        color: white;
        font-size: 24px;
        z-index: 1000;
    `;
        message.textContent = '😢 租金不足，你被赶了出去';
        document.body.appendChild(message);
        disableControls();
    }

    // 显示通关动画
    function showGameComplete() {
        const container = document.createElement('div');
        container.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 1000;
    `;

        container.innerHTML = `
        <h1 style="color: gold; font-size: 48px; margin-bottom: 20px;">
            🎊 恭喜通关！ 🎊
        </h1>
        <p style="color: white; font-size: 24px;">
            你已经成为了一个成功的房东！
        </p>
    `;

        document.body.appendChild(container);
        disableControls();
    }

    // 添加成长特效的样式
    const growthStyles = `
    .growth-line {
        position: fixed;
        height: 3px;
        background: linear-gradient(90deg, #4CAF50, #8BC34A);
        transform-origin: left;
        z-index: 100;
        animation: growthPulse 0.8s ease-in-out;
    }

    .growth-text {
        position: fixed;
        color: #4CAF50;
        font-weight: bold;
        font-size: 16px;
        text-shadow: 0 0 5px rgba(0,0,0,0.8);
        transform: translate(-50%, -50%);
        z-index: 101;
        animation: growthTextFloat 1.5s ease-out;
        white-space: nowrap;
    }

    .grow-animation {
        animation: growPlant 0.8s ease-out;
    }

    @keyframes growthPulse {
        0% { opacity: 0; height: 1px; }
        50% { opacity: 1; height: 4px; }
        100% { opacity: 0; height: 2px; }
    }

    @keyframes growthTextFloat {
        0% { opacity: 0; transform: translate(-50%, 0); }
        20% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; transform: translate(-50%, -30px); }
    }

    @keyframes growPlant {
        0% { transform: scale(0.5); opacity: 0.3; }
        70% { transform: scale(1.2); }
        100% { transform: scale(1); opacity: 1; }
    }
    `;

    // 禁用游戏控制
    function disableControls() {
        document.getElementById('start-button').disabled = true;
        document.getElementById('show-upgrade-button').disabled = true;
    }

    // 游戏初始化时调用
    document.addEventListener('DOMContentLoaded', () => {
        // 添加开锁特效样式
        const styleSheet = document.createElement('style');
        styleSheet.textContent = unlockStyles;
        document.head.appendChild(styleSheet);

        // 添加成长特效样式
        const growthStyleSheet = document.createElement('style');
        growthStyleSheet.textContent = growthStyles;
        document.head.appendChild(growthStyleSheet);

        // 添加破坏效果样式
        document.head.appendChild(effectStyles);
        // 添加音符破坏效果样式
        const musicStyles = document.createElement('style');
        musicStyles.textContent = musicDestructionStyles;
        document.head.appendChild(musicStyles);
        // 添加猫鼠互动样式
        const catSheet = document.createElement('style');
        catSheet.textContent = catMouseStyles;
        document.head.appendChild(catSheet);

        // 添加建筑固定样式
        const buildSheet = document.createElement('style');
        buildSheet.textContent = buildingStyles;
        document.head.appendChild(buildSheet);

        // 添加建筑固定样式
        const musicSheet = document.createElement('style');
        musicSheet.textContent = musicStyles;
        document.head.appendChild(musicSheet);


        initResourcePool();
        initCoinPool();
        initChallengeSystem();
        initCodex();

        // 在所有初始化完成后显示职业选择面板
        initProfessionSelection();

        // 禁用开始按钮，直到选择完职业
        document.getElementById('start-button').disabled = true;

        // 设置初始状态
        hasSelectedUpgrade = true;
    });

    // 1. 定义资源池数据结构
    let resources = {
        material: 0,   // 材料资源
        mystery: 0,    // 神秘资源
        science: 0     // 科技资源
    };

    // 2. 资源池初始化函数
    function initResourcePool() {
        // 创建资源池元素
        const resourcePool = document.createElement('div');
        resourcePool.id = 'resource-pool';
        resourcePool.innerHTML = `
        <div class="resource-title">珍稀资源</div>
        <div class="resource" data-type="material">
            <div class="resource-icon">🧱</div>
            <div class="resource-count" id="material-count">0</div>
        </div>
        <div class="resource" data-type="mystery">
            <div class="resource-icon">✨</div>
            <div class="resource-count" id="mystery-count">0</div>
        </div>
        <div class="resource" data-type="science">
            <div class="resource-icon">🔬</div>
            <div class="resource-count" id="science-count">0</div>
        </div>
    `;

        // 添加到页面
        document.body.appendChild(resourcePool);

        // 添加样式
        const style = document.createElement('style');
        style.textContent = `
        #resource-pool {
            position: fixed;
            left: 20px;
            bottom: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            color: white;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .resource-title {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
            color: gold;
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }

        .resource-icon {
            font-size: 24px;
        }

        .resource-count {
            font-size: 18px;
            font-weight: bold;
        }

        .resource-highlight {
            animation: resourceBounce 0.5s ease;
        }

        .flying-resource {
            position: fixed;
            font-size: 20px;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
        }

        @keyframes resourceBounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .resource-text {
            position: fixed;
            color: white;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
            transform: translate(-50%, -50%);
            z-index: 101;
            animation: resourceTextFloat 1.5s ease-out;
            white-space: nowrap;
        }

        @keyframes resourceTextFloat {
            0% { opacity: 0; transform: translate(-50%, 0); }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -30px); }
        }
    `;
        document.head.appendChild(style);

        // 初始更新资源显示
        updateResourceDisplay();
    }

    // 3. 更新资源显示
    function updateResourceDisplay() {
        document.getElementById('material-count').textContent = resources.material;
        document.getElementById('mystery-count').textContent = resources.mystery;
        document.getElementById('science-count').textContent = resources.science;
    }

    // 4. 添加资源并显示动画
    function addResource(type, amount, sourceElement) {
        if (!type || amount <= 0) return;

        // 更新资源数量
        resources[type] += amount;

        // 更新显示
        updateResourceDisplay();

        // 高亮资源图标
        const resourceElement = document.querySelector(`.resource[data-type="${type}"]`);
        if (resourceElement) {
            resourceElement.classList.add('resource-highlight');
            setTimeout(() => {
                resourceElement.classList.remove('resource-highlight');
            }, 500);
        }

        // 显示资源获取特效
        if (sourceElement) {
            showResourceProduction(sourceElement, type);
            createFlyingResource(type, amount, sourceElement);
        }
    }

    // 5. 显示资源生产特效
    function showResourceProduction(sourceElement, resourceType) {
        if (!sourceElement) return;

        const resourceText = document.createElement('div');
        resourceText.className = 'resource-text';

        // 根据资源类型设置文本
        let emoji = '';
        let text = '';

        switch (resourceType) {
            case 'material':
                emoji = '🧱';
                text = '材料';
                break;
            case 'mystery':
                emoji = '✨';
                text = '神秘';
                break;
            case 'science':
                emoji = '🔬';
                text = '科技';
                break;
        }

        resourceText.textContent = `${emoji} ${text}`;

        const rect = sourceElement.getBoundingClientRect();
        resourceText.style.left = `${rect.left + rect.width / 2}px`;
        resourceText.style.top = `${rect.top - 20}px`;

        document.body.appendChild(resourceText);

        // 设置动画结束后移除元素
        setTimeout(() => {
            resourceText.remove();
        }, 1500);
    }

    // 6. 创建飞向资源池的资源动画
    function createFlyingResource(type, amount, sourceElement) {
        if (!sourceElement) return;

        // 获取资源图标
        let emoji = '';
        switch (type) {
            case 'material': emoji = '🧱'; break;
            case 'mystery': emoji = '✨'; break;
            case 'science': emoji = '🔬'; break;
        }

        // 创建飞行资源元素
        const flyingResource = document.createElement('div');
        flyingResource.className = 'flying-resource';
        flyingResource.textContent = `${emoji}+${amount}`;

        // 获取起点位置（卡牌中心）
        const sourceRect = sourceElement.getBoundingClientRect();
        const startX = sourceRect.left + sourceRect.width / 2;
        const startY = sourceRect.top + sourceRect.height / 2;

        // 获取目标位置（资源池中对应资源的位置）
        const targetElement = document.querySelector(`.resource[data-type="${type}"]`);
        const targetRect = targetElement ? targetElement.getBoundingClientRect() :
            document.getElementById('resource-pool').getBoundingClientRect();
        const endX = targetRect.left + targetRect.width / 2;
        const endY = targetRect.top + targetRect.height / 2;

        // 设置初始位置
        flyingResource.style.left = `${startX}px`;
        flyingResource.style.top = `${startY}px`;

        document.body.appendChild(flyingResource);

        // 动画飞向目标
        const startTime = performance.now();
        const duration = 800; // 毫秒

        function animate(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // 使用缓动函数使动画更自然
            const easeProgress = 1 - Math.pow(1 - progress, 3);

            // 计算当前位置（抛物线轨迹）
            const currentX = startX + (endX - startX) * easeProgress;
            const currentY = startY + (endY - startY) * easeProgress - Math.sin(easeProgress * Math.PI) * 50;

            flyingResource.style.left = `${currentX}px`;
            flyingResource.style.top = `${currentY}px`;
            flyingResource.style.opacity = 1 - Math.pow(progress, 2);

            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                flyingResource.remove();
            }
        }

        requestAnimationFrame(animate);
    }

    function processProduction(card, slot) {
        if (!card || !card.tip) return;

        // 从提示文本中解析生产效果
        const tip = card.tip || "";

        // 1. 处理破坏效果 - 最高优先级
        if (tip.includes("破坏")) {
            // 获取周围八个方向的元素
            const slotPos = slot.dataset;
            const currentRow = parseInt(slotPos.row);
            const currentCol = parseInt(slotPos.col);

            // 获取周围所有格子
            const surroundingSlots = [];
            for (let r = Math.max(0, currentRow - 1); r <= Math.min(rows - 1, currentRow + 1); r++) {
                for (let c = Math.max(0, currentCol - 1); c <= Math.min(columns.length - 1, currentCol + 1); c++) {
                    if (r === currentRow && c === currentCol) continue; // 跳过自身

                    const neighborSlot = document.querySelector(`.slot[data-row="${r}"][data-col="${c}"]`);
                    if (neighborSlot && neighborSlot.__card) {
                        surroundingSlots.push({slot: neighborSlot, row: r, col: c});
                    }
                }
            }

            // 如果有周围元素，随机选择一个移除
            if (surroundingSlots.length > 0) {
                const randomIndex = Math.floor(Math.random() * surroundingSlots.length);
                const targetSlot = surroundingSlots[randomIndex];

                // 特殊处理：如果目标是宝箱，触发开箱效果
                if (targetSlot.slot.__card && targetSlot.slot.__card.category === IconCategory.Box) {
                    // 先显示破坏效果
                    showDestructionEffect(slot, targetSlot.slot);

                    // 然后触发开箱效果
                    setTimeout(() => {
                        const boxCard = targetSlot.slot.__card;
                        const boxCoins = boxCard.delCoins || 0;
                        if (boxCoins > 0) {
                            addCoins(boxCoins, targetSlot.slot);
                            showFloatingText(targetSlot.slot, `+${boxCoins} 💰`);
                        }

                        // 清空格子
                        clearSlot(targetSlot.row, targetSlot.col);
                    }, 500);
                } else {
                    // 对非宝箱元素，直接显示破坏效果并清空
                    showDestructionEffect(slot, targetSlot.slot);
                    setTimeout(() => {
                        clearSlot(targetSlot.row, targetSlot.col);
                    }, 500);
                }
            }
        }

        // 2. 处理概率添加元素
        const probabilityMatch = tip.match(/(\d+)%概率添加/);
        if (probabilityMatch) {
            const probability = parseInt(probabilityMatch[1]);
            const elementToAdd = card.make || "";
            // 检查是否触发概率
            if (Math.random() * 100 < probability) {
                console.log(card,"成功触发概率添加",probability,elementToAdd);
                // 从iconData中查找匹配的元素
                const matchingCards = iconData.filter(card =>
                    card.icon === elementToAdd
                );

                if (matchingCards.length > 0) {
                    // 随机选择一个匹配的卡牌
                    const cardToAdd = matchingCards[Math.floor(Math.random() * matchingCards.length)];

                    // 添加到手牌
                    handCards.push(cardToAdd);

                    // 显示添加效果
                    showCardAddedEffect(slot, cardToAdd);
                }
            }
        }

        // 特定提示文本触发特定资源生产
        if (tip.includes("生产材料") && Math.random() < 0.2) {
            // 从tip中提取数字作为资源数量，如果没有数字则默认为1
            const numberMatch = tip.match(/\d+/);
            const amount = numberMatch ? parseInt(numberMatch[0]) : 1;
            addResource('material', amount, slot);
        }

        if (tip.includes("生产神秘") && Math.random() < 0.2) {
            // 从tip中提取数字作为资源数量，如果没有数字则默认为1
            const numberMatch = tip.match(/\d+/);
            const amount = numberMatch ? parseInt(numberMatch[0]) : 1;
            addResource('mystery', amount, slot);
        }

        if (tip.includes("生产科技") && Math.random() < 0.2) {
            // 从tip中提取数字作为资源数量，如果没有数字则默认为1
            const numberMatch = tip.match(/\d+/);
            const amount = numberMatch ? parseInt(numberMatch[0]) : 1;
            addResource('science', amount, slot);
        }
    }

    // 清空指定格子
    function clearSlot(row, col) {
        const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
        if (slot) {
            // 保存原来的卡牌引用（用于从手牌中移除）
            const card = slot.__card;

            // 清空格子内容和引用
            slot.innerHTML = '';
            slot.removeAttribute('data-tooltip');
            slot.__card = null;

            // 如果卡牌在手牌中，移除它
            if (card) {
                removeCardFromHand(card);
            }
        }
    }

    // 显示破坏效果
    function showDestructionEffect(sourceSlot, targetSlot) {
        // 创建破坏效果容器
        const effectContainer = document.createElement('div');
        effectContainer.className = 'destruction-effect';
        document.body.appendChild(effectContainer);

        // 获取两个元素的位置
        const sourceRect = sourceSlot.getBoundingClientRect();
        const targetRect = targetSlot.getBoundingClientRect();

        // 设置破坏线
        const line = document.createElement('div');
        line.className = 'destruction-line';

        // 计算线的位置和角度
        const sourceX = sourceRect.left + sourceRect.width / 2;
        const sourceY = sourceRect.top + sourceRect.height / 2;
        const targetX = targetRect.left + targetRect.width / 2;
        const targetY = targetRect.top + targetRect.height / 2;

        const length = Math.sqrt(Math.pow(targetX - sourceX, 2) + Math.pow(targetY - sourceY, 2));
        const angle = Math.atan2(targetY - sourceY, targetX - sourceX) * 180 / Math.PI;

        line.style.width = `${length}px`;
        line.style.left = `${sourceX}px`;
        line.style.top = `${sourceY}px`;
        line.style.transform = `rotate(${angle}deg)`;

        effectContainer.appendChild(line);

        // 创建破坏文本
        const text = document.createElement('div');
        text.className = 'destruction-text';
        text.textContent = '💥 破坏!';
        text.style.left = `${targetX}px`;
        text.style.top = `${targetY - 20}px`;

        effectContainer.appendChild(text);

        // 添加动画后移除效果
        setTimeout(() => {
            effectContainer.remove();
        }, 1000);
    }

    // 显示卡牌添加效果
    function showCardAddedEffect(slot, card) {
        // 创建效果文本
        const text = document.createElement('div');
        text.className = 'card-added-text';
        text.innerHTML = `${card.icon} 添加到手牌!`;

        const rect = slot.getBoundingClientRect();
        text.style.left = `${rect.left + rect.width / 2}px`;
        text.style.top = `${rect.top - 20}px`;

        document.body.appendChild(text);

        // 设置动画结束后移除元素
        setTimeout(() => {
            text.remove();
        }, 1500);
    }

    const effectStyles = document.createElement('style');
    effectStyles.textContent = `
        .destruction-line {
            position: fixed;
            height: 3px;
            background: linear-gradient(to right, transparent, #ff4500, transparent);
            transform-origin: left center;
            z-index: 1000;
            animation: destructionPulse 0.5s ease-out;
        }

        .destruction-text {
            position: fixed;
            color: #ff4500;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
            transform: translate(-50%, -50%);
            z-index: 1001;
            animation: destructionTextFloat 1s ease-out;
            white-space: nowrap;
        }

        .card-added-text {
            position: fixed;
            color: #4CAF50;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
            transform: translate(-50%, -50%);
            z-index: 1001;
            animation: cardAddedFloat 1.5s ease-out;
            white-space: nowrap;
        }

        @keyframes destructionPulse {
            0% { opacity: 0; transform: scaleX(0.2) rotate(var(--angle)); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: scaleX(1.2) rotate(var(--angle)); }
        }

        @keyframes destructionTextFloat {
            0% { opacity: 0; transform: translate(-50%, 0); }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -30px); }
        }

        @keyframes cardAddedFloat {
            0% { opacity: 0; transform: translate(-50%, 0); }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -30px); }
        }
    `;

    // 添加全局计数器，记录待触发的高稀有度选择次数
    window.pendingRareUpgrades = 0;

    function checkFestivalInteraction(grid, row, col, highlightGroups) {
        const currentCard = grid[row][col];

        if (!currentCard || currentCard.category !== IconCategory.FESTIVAL) return false;

        // 获取周围的节日元素
        const festivalNeighbors = [];
        const visited = new Set();
        visited.add(`${row},${col}`);
        const directions = [
            [-1, -1], [-1, 0], [-1, 1],
            [0, -1],           [0, 1],
            [1, -1],  [1, 0],  [1, 1]
        ];

        // 检查邻居
        for (const [dx, dy] of directions) {
            const newRow = row + dx;
            const newCol = col + dy;

            if (newRow >= 0 && newRow < 5 && newCol >= 0 && newCol < 5) {
                const neighbor = grid[newRow][newCol];
                const key = `${newRow},${newCol}`;

                if (neighbor &&
                    neighbor.category === IconCategory.FESTIVAL &&
                    !visited.has(key)) {
                    festivalNeighbors.push({
                        row: newRow,
                        col: newCol,
                        card: neighbor,
                        element: document.querySelector(`.slot[data-row="${newRow}"][data-col="${newCol}"]`)
                    });
                    visited.add(key);
                }
            }
        }

        // 如果周围有2个或以上节日元素
        if (festivalNeighbors.length >= 2) {
            const currentElement = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
            const elementsToRemove = [
                { element: currentElement, card: currentCard, row, col },
                ...festivalNeighbors.map(n => ({
                    element: n.element,
                    card: n.card,
                    row: n.row,
                    col: n.col
                }))
            ];

            // 显示庆典消除特效
            showFestivalEffect(elementsToRemove);

            // 移除手牌中对应的卡牌和格子中的元素
            elementsToRemove.forEach(({element, card}) => {
                // 从手牌移除
                const cardIndex = handCards.findIndex(handCard =>
                    handCard.icon === card.icon && !handCard.used);
                if (cardIndex !== -1) {
                    handCards[cardIndex].used = true;
                }

                // 清除格子
                element.innerHTML = '';
                element.removeAttribute('data-tooltip');
                element.__card = null;
            });

            // 更新手牌显示
            updateHandCards();

            // 增加高稀有度选择机会
            window.pendingRareUpgrades++;

            return true;
        }

        return false;
    }

    // 添加庆典消除特效函数
    function showFestivalEffect(elements) {
        // 创建特效容器
        const effectContainer = document.createElement('div');
        effectContainer.className = 'festival-effect-container';
        document.body.appendChild(effectContainer);
        // 为每个元素创建消除特效
        elements.forEach(({element, row, col}) => {
            // 创建烟花特效
            const firework = document.createElement('div');
            firework.className = 'festival-firework';

            // 获取元素位置
            const rect = element.getBoundingClientRect();

            // 设置烟花位置
            firework.style.left = `${rect.left + rect.width/2}px`;
            firework.style.top = `${rect.top + rect.height/2}px`;

            effectContainer.appendChild(firework);

            // 添加庆典文字
            const text = document.createElement('div');
            text.className = 'festival-text';
            text.textContent = '✨ 三连奇迹!';
            text.style.left = `${rect.left + rect.width/2}px`;
            text.style.top = `${rect.top - 20}px`;
            effectContainer.appendChild(text);
        });

        // 添加特效样式
        const style = document.createElement('style');
        style.textContent = `
        .festival-effect-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .festival-firework {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: radial-gradient(circle, #ffeb3b, #ff9800);
            transform: translate(-50%, -50%);
            animation: festivalExplosion 0.8s ease-out forwards;
        }

        .festival-text {
            position: absolute;
            color: #ff9800;
            font-weight: bold;
            font-size: 20px;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
            transform: translate(-50%, -50%);
            animation: festivalTextFloat 1s ease-out forwards;
        }

        @keyframes festivalExplosion {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(20);
                opacity: 0;
            }
        }

        @keyframes festivalTextFloat {
            0% {
                transform: translate(-50%, 0);
                opacity: 0;
            }
            20% {
                opacity: 1;
            }
            80% {
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -30px);
                opacity: 0;
            }
        }
    `;
        document.head.appendChild(style);

        // 清理特效
        setTimeout(() => {
            effectContainer.remove();
            style.remove();
        }, 1000);
    }

    function checkGemRespawn(grid, row, col, card) {
        if (!card || !grid) return false;

        // 判断是否是宝石类元素
        const isGem = card.category === IconCategory.GEM;

        // 判断是否在时空元素旁边
        const isNearTimeWarp = checkNearTimeWarp(grid, row, col);

        // 如果不是宝石或不在时空元素旁，直接返回
        if (!isGem || !isNearTimeWarp) return false;

        // 获取当前格子
        const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
        if (!slot) return false;

        // 处理时空倒流效果
        // 先触发金币效果
        addCoins(card.baseCoins, slot);

        // 升级宝石稀有度
        const upgradedGem = getHigherRarityGem(card);
        if (upgradedGem) {
            // 从手牌中移除旧宝石
            removeCardFromHand(card);

            // 生成新宝石
            spawnNewCard(row, col, upgradedGem);

            // 触发新宝石的金币和生产效果
            addCoins(upgradedGem.baseCoins, slot);
            processProduction(upgradedGem, slot);

            // 将新宝石添加到手牌
            handCards.push(upgradedGem);

            return true;
        }

        return false;
    }

    function checkNearTimeWarp(grid, row, col) {
        const directions = [
            [-1, -1], [-1, 0], [-1, 1],
            [0, -1],           [0, 1],
            [1, -1],  [1, 0],  [1, 1]
        ];

        for (const [dx, dy] of directions) {
            const newRow = row + dx;
            const newCol = col + dy;

            if (newRow >= 0 && newRow < rows && newCol >= 0 && newCol < 5) {
                const nearCard = grid[newRow][newCol];
                if (nearCard && nearCard.icon === '🌀') {
                    return true;
                }
            }
        }
        return false;
    }

    // 辅助函数：获取更高稀有度的宝石
    function getHigherRarityGem(currentGem) {
        const rarityOrder = [Rarity.COMMON, Rarity.RARE, Rarity.EPIC, Rarity.LEGENDARY];
        const currentIndex = rarityOrder.indexOf(currentGem.rarity);

        if (currentIndex < rarityOrder.length - 1) {
            const targetRarity = rarityOrder[currentIndex + 1];
            const availableGems = iconData.filter(card =>
                card.category === IconCategory.GEM && card.rarity === targetRarity
            );

            if (availableGems.length > 0) {
                return availableGems[Math.floor(Math.random() * availableGems.length)];
            }
        }
        return null;
    }

    // 辅助函数：获取随机宝石
    function getRandomGemByCategory() {
        const gems = iconData.filter(card => card.category === IconCategory.GEM);
        return gems.length > 0 ? gems[Math.floor(Math.random() * gems.length)] : null;
    }

    function spawnNewCard(row, col, card) {
        // 获取对应格子
        const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);
        if (!slot) return;

        // 清空原有内容
        slot.innerHTML = '';
        slot.removeAttribute('data-tooltip');
        slot.__card = null;

        // 创建新卡牌内容
        slot.innerHTML = `
            <div class="card-icon">${card.icon}</div>
            <div class="coin-indicator">+${card.baseCoins}💰</div>
        `;

        // 设置提示文本
        slot.setAttribute('data-tooltip', card.tip);

        // 保存卡牌数据引用
        slot.__card = card;

        // 添加生成动画
        slot.classList.add('spawn-animation');
        setTimeout(() => {
            slot.classList.remove('spawn-animation');
        }, 500);

        // 更新网格数据
        const grid = getGrid();
        grid[row][col] = card;
    }

    function getGrid() {
        const grid = [];

        // 遍历所有行
        for (let row = 0; row < rows; row++) {
            grid[row] = [];

            // 遍历每行的所有列
            for (let col = 0; col < 5; col++) {
                // 获取对应格子
                const slot = document.querySelector(`.slot[data-row="${row}"][data-col="${col}"]`);

                // 如果格子存在且有卡牌数据，则添加到网格中
                if (slot && slot.__card) {
                    grid[row][col] = slot.__card;
                } else {
                    grid[row][col] = null;
                }
            }
        }

        return grid;
    }

    const spawnStyles = `
    .spawn-animation {
        animation: spawnCard 0.5s ease-out;
    }

    @keyframes spawnCard {
        0% {
            transform: scale(0.3);
            opacity: 0;
        }
        70% {
            transform: scale(1.1);
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    `;

    // 将样式添加到文档中
    const spawnSheet = document.createElement('style');
    spawnSheet.textContent = spawnStyles;
    document.head.appendChild(spawnSheet);
</script>
</body>
</html>